@page "/reports"
@using SMED.FrontEnd.Services
@using SMED.Shared.DTOs
@inject ReportService ReportService
@inject HealthProfessionalService HealthProfessionalService
@inject LocationService LocationService
@inject PlaceOfAttentionService PlaceOfAttentionService
@inject PersonService PersonService
@inject MedicalReferralService MedicalReferralService
@inject MedicalServiceService MedicalServiceService
@inject IJSRuntime JSRuntime

<PageTitle>Reportes del Sistema</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h3 class="mb-4">Sistema de Reportes y Estadísticas</h3>
        </div>
    </div>

    <!-- Filtros para Generación de Reportes PDF -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Generación de Reportes PDF</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Tipo de Reporte</label>
                    <select @bind="ReportRequest.ReportType" class="form-select">
                        <option value="">Seleccione un reporte</option>
                        <option value="medical-care">Atenciones Médicas</option>
                        <option value="patient">Pacientes</option>
                        <option value="professional">Profesionales</option>
                        <option value="professional-detail">Detalle de Profesional</option>
                        <option value="location">Por Ubicación</option>
                        <option value="area">Por Área</option>
                        <option value="top-patients">Pacientes con Más Atenciones</option>
                        <option value="statistical">Estadístico</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Fecha Inicio</label>
                    <input type="date" @bind="ReportRequest.StartDate" @bind:format="yyyy-MM-dd" class="form-control" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Fecha Fin</label>
                    <input type="date" @bind="ReportRequest.EndDate" @bind:format="yyyy-MM-dd" class="form-control" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Área</label>
                    <select @bind="ReportRequest.Area" class="form-select">
                        <option value="">Todas las áreas</option>
                        @foreach (var area in Areas)
                        {
                            <option value="@area.Name">@area.Name</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Profesional</label>
                    <select @bind="ReportRequest.HealthProfessionalId" class="form-select">
                        <option value="">Todos</option>
                        @foreach (var prof in Professionals)
                        {
                            <option value="@prof.HealthProfessionalId">@prof.FullName</option>
                        }
                    </select>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <button class="btn btn-primary me-2" @onclick="GenerateReport" disabled="@IsLoading">
                        <i class="fas fa-file-pdf"></i> Generar Reporte PDF
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ClearReportFilters">
                        <i class="fas fa-broom"></i> Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Control de Estadísticas Generales -->
    <div class="card mb-4 border-info">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Estadísticas del Sistema</h5>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="includeAllRecords"
                               @bind="StatisticsIncludeAllRecords">
                        <label class="form-check-label" for="includeAllRecords">
                            <strong>Mostrar todos los registros</strong>
                        </label>
                    </div>
                    <small class="text-muted">
                        @if (StatisticsIncludeAllRecords)
                        {
                            <span>Mostrando todos los registros históricos</span>
                        }
                        else
                        {
                            <span>Aplicando filtro de fechas</span>
                        }
                    </small>
                </div>

                @if (!StatisticsIncludeAllRecords)
                {
                    <div class="col-md-3">
                        <label class="form-label">Fecha Inicio</label>
                        <input type="date" @bind="StatisticsStartDate" @bind:format="yyyy-MM-dd" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fecha Fin</label>
                        <input type="date" @bind="StatisticsEndDate" @bind:format="yyyy-MM-dd" class="form-control" />
                    </div>
                }

                <div class="col-md-3">
                    <button class="btn btn-info w-100" @onclick="LoadStatistics" disabled="@IsLoadingStatistics">
                        <i class="fas fa-sync-alt @(IsLoadingStatistics ? "fa-spin" : "")"></i>
                        @(IsLoadingStatistics ? "Cargando..." : "Actualizar Estadísticas")
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Generales -->
    @if (ShowStatistics)
    {
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h4>@TotalProfessionals</h4>
                        <p class="mb-0">Total Profesionales</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h4>@TotalAreas</h4>
                        <p class="mb-0">Áreas Médicas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h4>@TotalLocations</h4>
                        <p class="mb-0">Ubicaciones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h4>@TotalConsultations</h4>
                        <p class="mb-0">Total Atenciones</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA: Atenciones por Género -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-venus-mars me-2"></i>Atenciones por Género</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm @(GenderViewMode == "table" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetGenderViewMode("table")'>
                                <i class="fas fa-table"></i>
                            </button>
                            <button class="btn btn-sm @(GenderViewMode == "chart" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetGenderViewMode("chart")'>
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (GenderViewMode == "table")
                        {
                            @if (AttentionsByGender.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Género</th>
                                                <th>Cantidad</th>
                                                <th>Porcentaje</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in AttentionsByGender.OrderByDescending(x => x.Value))
                                            {
                                                <tr>
                                                    <td>@item.Key</td>
                                                    <td><span class="badge bg-primary">@item.Value</span></td>
                                                    <td>@(TotalConsultations > 0 ? ((item.Value * 100.0 / TotalConsultations).ToString("F1") + "%") : "0%")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>No hay datos disponibles
                                </div>
                            }
                        }
                        else
                        {
                            <canvas id="genderChart" style="height: 300px; width: 100%;"></canvas>
                        }
                    </div>
                </div>
            </div>

            <!-- TABLA: Atenciones por Ciudad/Provincia -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Atenciones por Ubicación Geográfica</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm @(LocationViewMode == "table" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetLocationViewMode("table")'>
                                <i class="fas fa-table"></i>
                            </button>
                            <button class="btn btn-sm @(LocationViewMode == "chart" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetLocationViewMode("chart")'>
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (LocationViewMode == "table")
                        {
                            @if (AttentionsByProvince.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Provincia</th>
                                                <th>Ciudad</th>
                                                <th>Cantidad</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in AttentionsByProvince.OrderByDescending(x => x.Count))
                                            {
                                                <tr>
                                                    <td>@item.Province</td>
                                                    <td>@item.City</td>
                                                    <td><span class="badge bg-success">@item.Count</span></td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>No hay datos disponibles
                                </div>
                            }
                        }
                        else
                        {
                            <canvas id="locationChart" style="height: 300px; width: 100%;"></canvas>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA: Atenciones por Rango de Edad y Departamento -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-user-clock me-2"></i>Atenciones por Rango de Edad y Departamento</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm @(AgeViewMode == "table" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetAgeViewMode("table")'>
                                <i class="fas fa-table"></i>
                            </button>
                            <button class="btn btn-sm @(AgeViewMode == "chart" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetAgeViewMode("chart")'>
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (AgeViewMode == "table")
                        {
                            @if (AttentionsByAgeRange.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Rango de Edad</th>
                                                @foreach (var area in AttentionsByAgeRange.First().ByDepartment.Keys.OrderBy(x => x))
                                                {
                                                    <th>@area</th>
                                                }
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in AttentionsByAgeRange.OrderBy(x => x.MinAge))
                                            {
                                                <tr>
                                                    <td><strong>@item.Range</strong></td>
                                                    @foreach (var area in item.ByDepartment.Keys.OrderBy(x => x))
                                                    {
                                                        <td><span class="badge bg-info">@item.ByDepartment[area]</span></td>
                                                    }
                                                    <td><strong><span class="badge bg-warning">@item.Total</span></strong></td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>No hay datos disponibles
                                </div>
                            }
                        }
                        else
                        {
                            <canvas id="ageChart" style="height: 400px; width: 100%;"></canvas>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA: Derivaciones entre Departamentos -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Derivaciones entre Departamentos</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm @(ReferralViewMode == "table" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetReferralViewMode("table")'>
                                <i class="fas fa-table"></i>
                            </button>
                            <button class="btn btn-sm @(ReferralViewMode == "chart" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetReferralViewMode("chart")'>
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (ReferralViewMode == "table")
                        {
                            @if (ReferralsBetweenDepartments.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Desde (Departamento)</th>
                                                <th>Hacia (Departamento)</th>
                                                <th>Cantidad de Derivaciones</th>
                                                <th>Porcentaje</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{
                                                var totalReferrals = ReferralsBetweenDepartments.Sum(x => x.Count);
                                            }
                                            @foreach (var item in ReferralsBetweenDepartments.OrderByDescending(x => x.Count))
                                            {
                                                <tr>
                                                    <td>@item.FromDepartment</td>
                                                    <td>@item.ToDepartment</td>
                                                    <td><span class="badge bg-danger">@item.Count</span></td>
                                                    <td>@((item.Count * 100.0 / Math.Max(totalReferrals, 1)).ToString("F1"))%</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>No hay datos disponibles
                                </div>
                            }
                        }
                        else
                        {
                            <canvas id="referralChart" style="height: 400px; width: 100%;"></canvas>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA: Servicios Realizados por Departamento -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-briefcase-medical me-2"></i>Servicios Realizados por Departamento</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm @(ServiceViewMode == "table" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetServiceViewMode("table")'>
                                <i class="fas fa-table"></i>
                            </button>
                            <button class="btn btn-sm @(ServiceViewMode == "chart" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetServiceViewMode("chart")'>
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (ServiceViewMode == "table")
                        {
                            @if (ServicesByDepartment.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Departamento</th>
                                                <th>Total Servicios</th>
                                                <th>Tipos de Servicios</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in ServicesByDepartment.OrderByDescending(x => x.TotalServices))
                                            {
                                                <tr>
                                                    <td>@item.Department</td>
                                                    <td><span class="badge bg-info">@item.TotalServices</span></td>
                                                    <td>
                                                        @foreach (var serviceType in item.ServiceTypes)
                                                        {
                                                            <span class="badge bg-secondary me-1">@serviceType.Key: @serviceType.Value</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>No hay datos disponibles
                                </div>
                            }
                        }
                        else
                        {
                            <canvas id="serviceChart" style="height: 400px; width: 100%;"></canvas>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    @if (IsLoading || IsLoadingStatistics)
    {
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin"></i> Cargando datos, por favor espere...
        </div>
    }

    @if (!string.IsNullOrEmpty(Message))
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check"></i> @Message
            <button type="button" class="btn-close" @onclick="() => Message = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-triangle"></i> @ErrorMessage
            <button type="button" class="btn-close" @onclick="() => ErrorMessage = string.Empty"></button>
        </div>
    }
</div>

@code {
    private ReportRequestDTO ReportRequest { get; set; } = new();
    private List<HealthProfessionalDTO> Professionals { get; set; } = new();
    private List<LocationDTO> Areas { get; set; } = new();
    private List<PlaceOfAttentionDTO> Locations { get; set; } = new();
    private bool IsLoading = false;
    private bool IsLoadingStatistics = false;
    private bool ShowStatistics = true;
    private string Message = string.Empty;
    private string ErrorMessage = string.Empty;

    // Variables para control de estadísticas
    private bool StatisticsIncludeAllRecords = true;
    private DateTime? StatisticsStartDate;
    private DateTime? StatisticsEndDate;

    // Variables para estadísticas generales
    private int TotalProfessionals = 0;
    private int TotalAreas = 0;
    private int TotalLocations = 0;
    private int TotalConsultations = 0;

    // NUEVAS VARIABLES PARA LAS TABLAS
    private Dictionary<string, int> AttentionsByGender = new();
    private List<GeographicAttentionData> AttentionsByProvince = new();
    private List<AgeRangeAttentionData> AttentionsByAgeRange = new();
    private List<ReferralBetweenDepartmentsData> ReferralsBetweenDepartments = new();
    private List<ServicesByDepartmentData> ServicesByDepartment = new();

    // Variables para controlar vista tabla/gráfico
    private string GenderViewMode = "table";
    private string LocationViewMode = "table";
    private string AgeViewMode = "table";
    private string ReferralViewMode = "table";
    private string ServiceViewMode = "table";

    protected override async Task OnInitializedAsync()
    {
        await LoadDropdownData();
        await LoadStatistics();
    }

    private async Task LoadDropdownData()
    {
        try
        {
            Professionals = (await HealthProfessionalService.GetAllHealthProfessionalsAsync()).ToList();
            Areas = (await LocationService.GetAllAsync()).ToList();
            Locations = (await PlaceOfAttentionService.GetAllPlacesAsync()).ToList();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error cargando datos: {ex.Message}";
        }
    }

    // MÉTODOS PARA CAMBIAR VISTA Y RENDERIZAR GRÁFICOS
    private async Task SetGenderViewMode(string mode)
    {
        GenderViewMode = mode;
        StateHasChanged();
        if (mode == "chart" && AttentionsByGender.Any())
        {
            await Task.Delay(100);
            await InitializeGenderChart();
        }
    }

    private async Task SetLocationViewMode(string mode)
    {
        LocationViewMode = mode;
        StateHasChanged();
        if (mode == "chart" && AttentionsByProvince.Any())
        {
            await Task.Delay(100);
            await InitializeLocationChart();
        }
    }

    private async Task SetAgeViewMode(string mode)
    {
        AgeViewMode = mode;
        StateHasChanged();
        if (mode == "chart" && AttentionsByAgeRange.Any())
        {
            await Task.Delay(100);
            await InitializeAgeChart();
        }
    }

    private async Task SetReferralViewMode(string mode)
    {
        ReferralViewMode = mode;
        StateHasChanged();
        if (mode == "chart" && ReferralsBetweenDepartments.Any())
        {
            await Task.Delay(100);
            await InitializeReferralChart();
        }
    }

    private async Task SetServiceViewMode(string mode)
    {
        ServiceViewMode = mode;
        StateHasChanged();
        if (mode == "chart" && ServicesByDepartment.Any())
        {
            await Task.Delay(100);
            await InitializeServiceChart();
        }
    }

    // MÉTODOS PARA INICIALIZAR GRÁFICOS
    private async Task InitializeGenderChart()
    {
        try
        {
            var labels = AttentionsByGender.Keys.ToArray();
            var data = AttentionsByGender.Values.ToArray();
            var colors = new[] { "#3b82f6", "#ef4444", "#10b981" };

            await JSRuntime.InvokeVoidAsync("renderGenderChart", "genderChart", labels, data, colors);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando gráfico de género: {ex.Message}");
        }
    }

    private async Task InitializeLocationChart()
    {
        try
        {
            var locations = AttentionsByProvince.Take(10).Select(x => $"{x.City}, {x.Province}").ToArray();
            var counts = AttentionsByProvince.Take(10).Select(x => x.Count).ToArray();

            await JSRuntime.InvokeVoidAsync("renderLocationChart", "locationChart", locations, counts);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando gráfico de ubicación: {ex.Message}");
        }
    }

    private async Task InitializeAgeChart()
    {
        try
        {
            var ageRanges = AttentionsByAgeRange.Select(x => x.Range).ToArray();
            var departments = Areas.Select(x => x.Name).Take(5).ToArray();
            var data = AttentionsByAgeRange.ToDictionary(ar => ar.Range, ar => ar.ByDepartment);

            await JSRuntime.InvokeVoidAsync("renderAgeChart", "ageChart", ageRanges, departments, data);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando gráfico de edad: {ex.Message}");
        }
    }

    private async Task InitializeReferralChart()
    {
        try
        {
            var referrals = ReferralsBetweenDepartments.Take(15)
                .Select(r => new { from = r.FromDepartment, to = r.ToDepartment, count = r.Count })
                .ToArray();

            await JSRuntime.InvokeVoidAsync("renderReferralChart", "referralChart", referrals);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando gráfico de derivaciones: {ex.Message}");
        }
    }

    private async Task InitializeServiceChart()
    {
        try
        {
            var departments = ServicesByDepartment.Select(x => x.Department).ToArray();
            var totals = ServicesByDepartment.Select(x => x.TotalServices).ToArray();

            await JSRuntime.InvokeVoidAsync("renderServiceChart", "serviceChart", departments, totals);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando gráfico de servicios: {ex.Message}");
        }
    }

    private async Task LoadStatistics()
    {
        IsLoadingStatistics = true;
        Message = string.Empty;
        ErrorMessage = string.Empty;

        try
        {
            if (!StatisticsIncludeAllRecords && (!StatisticsStartDate.HasValue || !StatisticsEndDate.HasValue))
            {
                ErrorMessage = "Por favor seleccione ambas fechas para filtrar las estadísticas.";
                return;
            }

            // Cargar todas las personas
            var allPersons = await PersonService.GetAllPersons();

            // Cargar estadísticas básicas
            var statisticalData = await ReportService.GetStatisticalDataAsync(
                StatisticsStartDate,
                StatisticsEndDate,
                StatisticsIncludeAllRecords);

            TotalProfessionals = statisticalData.TotalProfessionals;
            TotalAreas = statisticalData.ConsultationsByArea.Count;
            TotalLocations = Locations.Count;
            TotalConsultations = statisticalData.TotalConsultations;

            // Cargar datos de atenciones médicas
            var request = new ReportRequestDTO
                {
                    IncludeAllRecords = StatisticsIncludeAllRecords,
                    StartDate = StatisticsStartDate,
                    EndDate = StatisticsEndDate
                };

            var professionalData = await ReportService.GetProfessionalReportDataAsync(request);

            // Procesar atenciones por género
            await ProcessAttentionsByGender(professionalData, allPersons);

            // Procesar atenciones por ubicación geográfica
            await ProcessAttentionsByLocation(allPersons);

            // Procesar atenciones por rango de edad
            await ProcessAttentionsByAgeRange(professionalData, allPersons);

            // Procesar derivaciones entre departamentos
            await ProcessReferralsBetweenDepartments();

            // Procesar servicios por departamento
            await ProcessServicesByDepartment();

            Message = "Estadísticas actualizadas correctamente";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error cargando estadísticas: {ex.Message}";
            Console.WriteLine($"Error en LoadStatistics: {ex}");
        }
        finally
        {
            IsLoadingStatistics = false;
            StateHasChanged();
        }
    }

    private async Task ProcessAttentionsByGender(List<ProfessionalReportDTO> professionalData, List<PersonDTO> allPersons)
    {
        var patientIds = professionalData
            .SelectMany(p => p.RecentConsultations.Select(c => c.PatientName))
            .Distinct()
            .ToList();

        var genderCounts = new Dictionary<string, int>();

        foreach (var person in allPersons)
        {
            var consultations = professionalData
                .SelectMany(p => p.RecentConsultations)
                .Count(c => c.PatientName.Contains(person.FirstName) && c.PatientName.Contains(person.LastName));

            if (consultations > 0)
            {
                var genderName = person.GenderId == 1 ? "Masculino" : person.GenderId == 2 ? "Femenino" : "Otro";

                if (!genderCounts.ContainsKey(genderName))
                    genderCounts[genderName] = 0;

                genderCounts[genderName] += consultations;
            }
        }

        AttentionsByGender = genderCounts;
    }

    private async Task ProcessAttentionsByLocation(List<PersonDTO> allPersons)
    {
        var locationData = new List<GeographicAttentionData>();

        var groupedByLocation = allPersons
            .Where(p => p.Residence != null)
            .GroupBy(p => new { p.Residence.ProvinceName, p.Residence.CityName })
            .Select(g => new GeographicAttentionData
                {
                    Province = g.Key.ProvinceName ?? "Sin provincia",
                    City = g.Key.CityName ?? "Sin ciudad",
                    Count = g.Count()
                })
            .ToList();

        AttentionsByProvince = groupedByLocation;
    }

    private async Task ProcessAttentionsByAgeRange(List<ProfessionalReportDTO> professionalData, List<PersonDTO> allPersons)
    {
        var ageRanges = new List<AgeRangeAttentionData>
        {
            new AgeRangeAttentionData { Range = "0-10 años", MinAge = 0, MaxAge = 10 },
            new AgeRangeAttentionData { Range = "11-20 años", MinAge = 11, MaxAge = 20 },
            new AgeRangeAttentionData { Range = "21-30 años", MinAge = 21, MaxAge = 30 },
            new AgeRangeAttentionData { Range = "31-40 años", MinAge = 31, MaxAge = 40 },
            new AgeRangeAttentionData { Range = "41-50 años", MinAge = 41, MaxAge = 50 },
            new AgeRangeAttentionData { Range = "51-60 años", MinAge = 51, MaxAge = 60 },
            new AgeRangeAttentionData { Range = "61+ años", MinAge = 61, MaxAge = 200 }
        };

        var departmentNames = Areas.Select(a => a.Name).ToList();

        foreach (var ageRange in ageRanges)
        {
            foreach (var dept in departmentNames)
            {
                ageRange.ByDepartment[dept] = 0;
            }
        }

        foreach (var prof in professionalData)
        {
            foreach (var consultation in prof.RecentConsultations)
            {
                var patient = allPersons.FirstOrDefault(p =>
                    consultation.PatientName.Contains(p.FirstName) &&
                    consultation.PatientName.Contains(p.LastName));

                if (patient?.BirthDate != null)
                {
                    var age = CalculateAge(patient.BirthDate.Value);
                    var ageRange = ageRanges.FirstOrDefault(ar => age >= ar.MinAge && age <= ar.MaxAge);

                    if (ageRange != null && !string.IsNullOrEmpty(consultation.Area))
                    {
                        if (ageRange.ByDepartment.ContainsKey(consultation.Area))
                        {
                            ageRange.ByDepartment[consultation.Area]++;
                        }
                    }
                }
            }
        }

        foreach (var ageRange in ageRanges)
        {
            ageRange.Total = ageRange.ByDepartment.Values.Sum();
        }

        AttentionsByAgeRange = ageRanges;
    }

    private async Task ProcessReferralsBetweenDepartments()
    {
        var allReferrals = await MedicalReferralService.GetAllAsync();

        if (!allReferrals.Success || allReferrals.Data == null)
        {
            ReferralsBetweenDepartments = new List<ReferralBetweenDepartmentsData>();
            return;
        }

        var referralData = allReferrals.Data
            .Where(r => !string.IsNullOrEmpty(r.ReferringArea) && !string.IsNullOrEmpty(r.LocationName))
            .GroupBy(r => new { From = r.ReferringArea, To = r.LocationName })
            .Select(g => new ReferralBetweenDepartmentsData
                {
                    FromDepartment = g.Key.From,
                    ToDepartment = g.Key.To,
                    Count = g.Count()
                })
            .ToList();

        ReferralsBetweenDepartments = referralData;
    }

    private async Task ProcessServicesByDepartment()
    {
        var allServices = await MedicalServiceService.GetAllAsync();

        if (allServices == null || !allServices.Any())
        {
            ServicesByDepartment = new List<ServicesByDepartmentData>();
            return;
        }

        var serviceData = allServices
            .Where(s => s.CareId.HasValue)
            .GroupBy(s => "Departamento") // Aquí necesitarías obtener el departamento del MedicalCare
            .Select(g => new ServicesByDepartmentData
                {
                    Department = g.Key,
                    TotalServices = g.Count(),
                    ServiceTypes = g.GroupBy(s => s.ServiceType ?? "Sin tipo")
                        .ToDictionary(sg => sg.Key, sg => sg.Count())
                })
            .ToList();

        ServicesByDepartment = serviceData;
    }

    private int CalculateAge(DateTime birthDate)
    {
        var today = DateTime.Today;
        var age = today.Year - birthDate.Year;
        if (birthDate.Date > today.AddYears(-age)) age--;
        return age;
    }

    private async Task GenerateReport()
    {
        if (string.IsNullOrEmpty(ReportRequest.ReportType))
        {
            ErrorMessage = "Por favor seleccione un tipo de reporte";
            return;
        }

        if (!ValidateReportRequirements())
        {
            return;
        }

        IsLoading = true;
        ErrorMessage = string.Empty;
        Message = string.Empty;

        try
        {
            var cleanRequest = new ReportRequestDTO
                {
                    ReportType = ReportRequest.ReportType,
                    StartDate = ReportRequest.StartDate?.Date,
                    EndDate = ReportRequest.EndDate?.Date,
                    Format = "PDF",
                    Area = ReportRequest.Area ?? "",
                    LocationId = ReportRequest.LocationId,
                    HealthProfessionalId = ReportRequest.HealthProfessionalId,
                    PlaceOfAttentionId = ReportRequest.PlaceOfAttentionId,
                    DocumentNumber = ReportRequest.DocumentNumber ?? "",
                    IncludeAllRecords = false
                };

            byte[] reportContent = cleanRequest.ReportType switch
            {
                "medical-care" => await ReportService.GenerateMedicalCareReportAsync(cleanRequest),
                "patient" => await ReportService.GeneratePatientReportAsync(cleanRequest),
                "professional" => await ReportService.GenerateProfessionalReportAsync(cleanRequest),
                "professional-detail" => await ReportService.GenerateProfessionalDetailReportAsync(cleanRequest),
                "location" => await ReportService.GenerateLocationReportAsync(cleanRequest),
                "area" => await ReportService.GenerateAreaReportAsync(cleanRequest),
                "top-patients" => await ReportService.GenerateTopPatientReportAsync(cleanRequest),
                "statistical" => await ReportService.GenerateStatisticalReportAsync(cleanRequest),
                _ => throw new ArgumentException("Tipo de reporte no válido")
            };

            Message = $"Reporte {GetReportTypeName(cleanRequest.ReportType)} generado exitosamente";

            var fileName = $"{GetReportTypeName(cleanRequest.ReportType)}_{DateTime.Now:yyyyMMddHHmmss}.pdf";
            await ReportService.DownloadReport(reportContent, fileName);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error generando reporte: {ex.Message}";
            Console.WriteLine($"Error detallado: {ex}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private bool ValidateReportRequirements()
    {
        switch (ReportRequest.ReportType)
        {
            case "professional-detail":
                if (!ReportRequest.HealthProfessionalId.HasValue)
                {
                    ErrorMessage = "Para el reporte detallado de profesional, debe seleccionar un profesional específico";
                    return false;
                }
                break;

            case "location":
                if (!ReportRequest.PlaceOfAttentionId.HasValue)
                {
                    ErrorMessage = "Para el reporte por ubicación, debe seleccionar una ubicación específica";
                    return false;
                }
                break;

            case "area":
                if (string.IsNullOrEmpty(ReportRequest.Area))
                {
                    ErrorMessage = "Para el reporte por área, debe seleccionar un área específica";
                    return false;
                }
                break;
        }

        if (ReportRequest.StartDate.HasValue && ReportRequest.EndDate.HasValue)
        {
            if (ReportRequest.StartDate.Value > ReportRequest.EndDate.Value)
            {
                ErrorMessage = "La fecha de inicio no puede ser mayor a la fecha de fin";
                return false;
            }
        }

        return true;
    }

    private void ClearReportFilters()
    {
        ReportRequest = new ReportRequestDTO
            {
                Format = "PDF",
                IncludeAllRecords = false
            };
        Message = string.Empty;
        ErrorMessage = string.Empty;
        StateHasChanged();
    }

    private string GetReportTypeName(string reportType)
    {
        return reportType switch
        {
            "medical-care" => "Atenciones_Médicas",
            "patient" => "Pacientes",
            "professional" => "Profesionales",
            "professional-detail" => "Detalle_Profesional",
            "location" => "Por_Ubicación",
            "area" => "Por_Área",
            "top-patients" => "Pacientes_Más_Atenciones",
            "statistical" => "Estadístico",
            _ => "Reporte"
        };
    }

    // Clases auxiliares para datos
    public class GeographicAttentionData
    {
        public string Province { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public int Count { get; set; }
    }

    public class AgeRangeAttentionData
    {
        public string Range { get; set; } = string.Empty;
        public int MinAge { get; set; }
        public int MaxAge { get; set; }
        public Dictionary<string, int> ByDepartment { get; set; } = new();
        public int Total { get; set; }
    }

    public class ReferralBetweenDepartmentsData
    {
        public string FromDepartment { get; set; } = string.Empty;
        public string ToDepartment { get; set; } = string.Empty;
        public int Count { get; set; }
    }

    public class ServicesByDepartmentData
    {
        public string Department { get; set; } = string.Empty;
        public int TotalServices { get; set; }
        public Dictionary<string, int> ServiceTypes { get; set; } = new();
    }
}