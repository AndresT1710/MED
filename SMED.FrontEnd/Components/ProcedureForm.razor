@using SMED.Shared.DTOs
@using SMED.FrontEnd.Services
@inject TypeOfProceduresService TypeOfProceduresService
@inject ProceduresService ProceduresService
@inject HealthProfessionalService HealthProfessionalService
@inject LocationService LocationService
@inject AuthorizationService AuthorizationService
@inject IJSRuntime JS

<div class="procedure-form">
    <div class="row g-3">
        <!-- Agregando selección de departamento -->
        <div class="col-md-6">
            <label class="form-label fw-bold">Departamento *</label>
            <select class="form-select @(showValidationErrors && !selectedLocationId.HasValue ? "is-invalid" : "")"
                    @bind:get="selectedLocationId"
                    @bind:set="OnDepartmentChangedAsync">
                <option value="">Seleccione un departamento</option>
                @foreach (var location in locations)
                {
                    <option value="@location.Id">@location.Name</option>
                }
            </select>
            @if (showValidationErrors && !selectedLocationId.HasValue)
            {
                <div class="invalid-feedback">
                    Debe seleccionar un departamento
                </div>
            }
        </div>

        <div class="col-md-6">
            <label class="form-label fw-bold">Fecha del Procedimiento *</label>
            <input type="datetime-local"
                   class="form-control @(showValidationErrors && Procedure.ProcedureDate == default ? "is-invalid" : "")"
                   @bind="Procedure.ProcedureDate" />
            @if (showValidationErrors && Procedure.ProcedureDate == default)
            {
                <div class="invalid-feedback">
                    Debe seleccionar una fecha
                </div>
            }
        </div>

        <div class="col-md-6">
            <label class="form-label fw-bold">Tipo de Procedimiento *</label>
            <select class="form-select @(showValidationErrors && selectedTypeOfProcedureId <= 0 ? "is-invalid" : "")"
                    @bind:get="selectedTypeOfProcedureId"
                    @bind:set="OnTypeOfProcedureChangedAsync">
                <option value="0">Seleccione un tipo</option>
                @foreach (var type in typesOfProcedures)
                {
                    <option value="@type.Id">@type.Name</option>
                }
            </select>
            @if (showValidationErrors && selectedTypeOfProcedureId <= 0)
            {
                <div class="invalid-feedback">
                    Debe seleccionar un tipo de procedimiento
                </div>
            }
        </div>

        <div class="col-md-6">
            <label class="form-label fw-bold">Procedimiento Específico *</label>
            <select class="form-select @(showValidationErrors && Procedure.SpecificProcedureId <= 0 ? "is-invalid" : "")"
                    @bind="Procedure.SpecificProcedureId"
                    disabled="@(selectedTypeOfProcedureId <= 0)">
                <option value="0">Seleccione un procedimiento</option>
                @foreach (var procedure in filteredProcedures)
                {
                    <option value="@procedure.Id">@procedure.Description</option>
                }
            </select>
            @if (showValidationErrors && Procedure.SpecificProcedureId <= 0)
            {
                <div class="invalid-feedback">
                    Debe seleccionar un procedimiento específico
                </div>
            }
        </div>

        <!-- Médico tratante condicional según departamento -->
        @if (selectedLocationId.HasValue && IsGeneralMedicineLocation())
        {
            <div class="col-md-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Medicina General:</strong> Se asignará automáticamente como médico tratante al profesional logueado.
                </div>
            </div>
        }
        else if (selectedLocationId.HasValue && IsNursingLocation())
        {
            <div class="col-md-12">
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Enfermería:</strong> Este procedimiento será asignado al departamento de enfermería y deberá ser completado por el enfermero disponible.
                </div>
            </div>
        }

        <div class="col-md-12">
            <label class="form-label fw-bold">Observaciones</label>
            <textarea class="form-control"
                      @bind="Procedure.Observations"
                      rows="3"
                      placeholder="Observaciones adicionales sobre el procedimiento..."></textarea>
        </div>
    </div>

    <div class="d-flex justify-content-end gap-2 mt-4">
        <button type="button" class="btn btn-secondary" @onclick="OnCancel">
            <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button type="button" class="btn btn-primary" @onclick="SaveProcedure" disabled="@isSaving">
            @if (isSaving)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            <i class="fas fa-save me-2"></i>@(Procedure.ProcedureId > 0 ? "Actualizar" : "Guardar")
        </button>
    </div>
</div>

@code {
    [Parameter] public MedicalProcedureDTO Procedure { get; set; } = new();
    [Parameter] public EventCallback<MedicalProcedureDTO> OnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }
    [Parameter] public int PatientId { get; set; }
    [Parameter] public int CareId { get; set; }

    private List<TypeOfProceduresDTO> typesOfProcedures = new();
    private List<ProceduresDTO> procedures = new();
    private List<ProceduresDTO> filteredProcedures = new();
    private List<HealthProfessionalDTO> healthProfessionals = new();
    private List<LocationDTO> locations = new();

    private int selectedTypeOfProcedureId = 0;
    private int? selectedLocationId;
    private bool showValidationErrors = false;
    private bool isSaving = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();

        if (Procedure.ProcedureId > 0)
        {
            selectedLocationId = Procedure.LocationId;
            selectedTypeOfProcedureId = Procedure.TypeOfProcedureId ?? 0;
            await OnTypeOfProcedureChangedAsync(selectedTypeOfProcedureId);
        }
        else
        {
            Procedure.ProcedureDate = DateTime.Now;
            if (PatientId > 0)
            {
                Procedure.PatientId = PatientId;
            }
            if (CareId > 0)
            {
                Procedure.CareId = CareId;
            }
            Procedure.Status = "Pendiente";

            await JS.InvokeVoidAsync("console.log", "[v0] Initialized procedure with:", new
            {
                PatientId = Procedure.PatientId,
                CareId = Procedure.CareId,
                ParameterPatientId = PatientId,
                ParameterCareId = CareId
            });
        }
    }

    private async Task LoadData()
    {
        try
        {
            var typesTask = TypeOfProceduresService.GetAllAsync();
            var proceduresTask = ProceduresService.GetAllAsync();
            var professionalsTask = HealthProfessionalService.GetAllHealthProfessionalsAsync();
            var locationsTask = LocationService.GetAllAsync();

            await Task.WhenAll(typesTask, proceduresTask, professionalsTask, locationsTask);

            typesOfProcedures = typesTask.Result ?? new();
            procedures = proceduresTask.Result ?? new();
            healthProfessionals = professionalsTask.Result ?? new();
            locations = locationsTask.Result ?? new();

            await JS.InvokeVoidAsync("console.log", "[v0] Loaded data:", new
            {
                typesCount = typesOfProcedures.Count,
                proceduresCount = procedures.Count,
                professionalsCount = healthProfessionals.Count,
                locationsCount = locations.Count
            });
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "[v0] Error loading data:", ex.Message);
        }
    }

    private async Task OnTypeOfProcedureChangedAsync(int value)
    {
        selectedTypeOfProcedureId = value;
        filteredProcedures = procedures.Where(p => p.TypeOfProcedureId == selectedTypeOfProcedureId).ToList();
        Procedure.SpecificProcedureId = 0;

        await JS.InvokeVoidAsync("console.log", "[v0] Filtered procedures:", filteredProcedures.Count);
        StateHasChanged();
    }

    private async Task OnDepartmentChangedAsync(int? value)
    {
        selectedLocationId = value;
        await JS.InvokeVoidAsync("console.log", "[v0] Department changed:", value);
        StateHasChanged();
    }

    private bool IsGeneralMedicineLocation()
    {
        var location = locations.FirstOrDefault(l => l.Id == selectedLocationId);
        return location?.Name.Contains("Medicina General", StringComparison.OrdinalIgnoreCase) == true ||
               location?.Name.Contains("Atención Médica", StringComparison.OrdinalIgnoreCase) == true;
    }

    private bool IsNursingLocation()
    {
        var location = locations.FirstOrDefault(l => l.Id == selectedLocationId);
        return location?.Name.Contains("Enfermería", StringComparison.OrdinalIgnoreCase) == true;
    }

    private async Task SaveProcedure()
    {
        showValidationErrors = true;

        if (!IsValid())
        {
            await JS.InvokeVoidAsync("console.error", "[v0] Validation failed");
            return;
        }

        isSaving = true;
        try
        {
            Procedure.LocationId = selectedLocationId;

            if (Procedure.PatientId <= 0 && PatientId > 0)
            {
                Procedure.PatientId = PatientId;
            }
            if (Procedure.CareId <= 0 && CareId > 0)
            {
                Procedure.CareId = CareId;
            }

            var currentUser = await AuthorizationService.GetCurrentUserAsync();
            await JS.InvokeVoidAsync("console.log", "[v0] Current user:", currentUser?.Name);

            if (currentUser != null)
            {
                var currentProfessional = healthProfessionals.FirstOrDefault(hp => hp.HealthProfessionalId == currentUser.PersonId);

                if (currentProfessional == null && !string.IsNullOrEmpty(currentUser.RegistrationNumber))
                {
                    currentProfessional = healthProfessionals.FirstOrDefault(hp => hp.RegistrationNumber == currentUser.RegistrationNumber);
                }

                await JS.InvokeVoidAsync("console.log", "[v0] Current professional found:", currentProfessional?.FullName);

                if (currentProfessional != null)
                {
                    Procedure.HealthProfessionalId = currentProfessional.HealthProfessionalId;

                    if (IsGeneralMedicineLocation())
                    {
                        Procedure.TreatingPhysicianId = currentProfessional.HealthProfessionalId;
                        Procedure.Status = "Realizado";
                        await JS.InvokeVoidAsync("console.log", "[v0] Assigned to General Medicine - Status: Realizado");
                    }
                    else if (IsNursingLocation())
                    {
                        Procedure.TreatingPhysicianId = null;
                        Procedure.Status = "Pendiente";
                        await JS.InvokeVoidAsync("console.log", "[v0] Assigned to Nursing - Status: Pendiente");
                    }
                    else
                    {
                        Procedure.TreatingPhysicianId = currentProfessional.HealthProfessionalId;
                        Procedure.Status = "Realizado";
                        await JS.InvokeVoidAsync("console.log", "[v0] Assigned to Other Department - Status: Realizado");
                    }
                }
                else
                {
                    await JS.InvokeVoidAsync("console.error", "[v0] No se encontró el profesional actual en la lista");
                    if (!IsNursingLocation())
                    {
                        Procedure.HealthProfessionalId = currentUser.PersonId ?? 0;
                    }

                    if (IsNursingLocation())
                    {
                        Procedure.TreatingPhysicianId = null;
                        Procedure.Status = "Pendiente";
                    }
                }
            }
            else
            {
                await JS.InvokeVoidAsync("console.error", "[v0] No se pudo obtener el usuario actual");
            }

            await JS.InvokeVoidAsync("console.log", "[v0] Procedure to save:", new
            {
                Procedure.PatientId,
                Procedure.CareId,
                Procedure.SpecificProcedureId,
                Procedure.HealthProfessionalId,
                Procedure.TreatingPhysicianId,
                Procedure.LocationId,
                Procedure.Status,
                Procedure.ProcedureDate
            });

            if (Procedure.PatientId <= 0)
            {
                await JS.InvokeVoidAsync("console.error", "[v0] PatientId is still 0, cannot save procedure");
                await JS.InvokeVoidAsync("alert", "Error: No se pudo obtener el ID del paciente");
                return;
            }

            await OnSaved.InvokeAsync(Procedure);
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "[v0] Error saving procedure:", ex.Message);
            await JS.InvokeVoidAsync("alert", $"Error al guardar procedimiento: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private bool IsValid()
    {
        return selectedLocationId.HasValue &&
               Procedure.ProcedureDate != default &&
               selectedTypeOfProcedureId > 0 &&
               Procedure.SpecificProcedureId > 0;
    }
}
