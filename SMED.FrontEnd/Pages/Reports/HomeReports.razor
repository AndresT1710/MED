@page "/reports"
@using SMED.FrontEnd.Services
@using SMED.Shared.DTOs
@using System.Text.Json
@using System.Globalization
@inject ReportService ReportService
@inject HealthProfessionalService HealthProfessionalService
@inject LocationService LocationService
@inject PlaceOfAttentionService PlaceOfAttentionService
@inject PersonService PersonService
@inject MedicalReferralService MedicalReferralService
@inject MedicalServiceService MedicalServiceService
@inject MedicalCareService MedicalCareService
@inject IJSRuntime JSRuntime

<PageTitle>Reportes del Sistema</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h3 class="mb-4">Sistema de Reportes y Estadísticas</h3>
        </div>
    </div>

    <!-- Filtros para Generación de Reportes PDF -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Generación de Reportes PDF</h5>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Tipo de Reporte</label>
                    <select @bind="ReportRequest.ReportType" class="form-select">
                        <option value="">Seleccione un reporte</option>
                        <option value="medical-care">Atenciones Médicas</option>
                        <option value="patient">Pacientes</option>
                        <option value="patient-specific">Paciente Específico</option>
                        <option value="professional">Profesionales</option>
                        <option value="professional-detail">Detalle de Profesional</option>
                        <option value="location">Por Ubicación</option>
                        <option value="area">Por Área</option>
                        <option value="top-patients">Pacientes con Más Atenciones</option>
                        <option value="statistical">Estadístico</option>
                    </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Fecha Inicio</label>
                <input type="date" @bind="ReportRequest.StartDate" @bind:format="yyyy-MM-dd" class="form-control" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Fecha Fin</label>
                <input type="date" @bind="ReportRequest.EndDate" @bind:format="yyyy-MM-dd" class="form-control" />
            </div>
                <div class="col-md-2">
                    <label class="form-label">Área</label>
                    <select @bind="SelectedArea" class="form-select">
                        <option value="">Todas las áreas</option>
                        @foreach (var area in Areas)
                        {
                            <option value="@area.Name">@area.Name</option>
                        }
                    </select>
                </div>
            <div class="col-md-2">
                <label class="form-label">Profesional</label>
                <select @bind="ReportRequest.HealthProfessionalId" class="form-select">
                    <option value="">Todos</option>
                    @if (FilteredProfessionals.Any())
                    {
                        @foreach (var prof in FilteredProfessionals)
                        {
                            <option value="@prof.HealthProfessionalId">@prof.FullName</option>
                        }
                    }
                    else
                    {
                        @foreach (var prof in Professionals)
                        {
                            <option value="@prof.HealthProfessionalId">@prof.FullName</option>
                        }
                    }
                </select>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <button class="btn btn-primary me-2" @onclick="GenerateReport" disabled="@IsLoading">
                    <i class="fas fa-file-pdf"></i> Generar Reporte PDF
                </button>
                <button class="btn btn-outline-secondary" @onclick="ClearReportFilters">
                    <i class="fas fa-broom"></i> Limpiar Filtros
                </button>
            </div>
        </div>
    </div>
</div>

    @if (IsLoading || IsLoadingStatistics)
    {
        <div class="alert alert-info">
            <i class="fas fa-spinner fa-spin"></i> Cargando datos, por favor espere...
        </div>
    }

    @if (!string.IsNullOrEmpty(Message))
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check"></i> @Message
            <button type="button" class="btn-close" @onclick="() => Message = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-triangle"></i> @ErrorMessage
            <button type="button" class="btn-close" @onclick="() => ErrorMessage = string.Empty"></button>
        </div>
    }

    <!-- Control de Estadísticas Generales -->
    <div class="card mb-4 border-info">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Estadísticas del Sistema</h5>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="includeAllRecords"
                               @bind="StatisticsIncludeAllRecords">
                        <label class="form-check-label" for="includeAllRecords">
                            <strong>Mostrar todos los registros</strong>
                        </label>
                    </div>
                    <small class="text-muted">
                        @if (StatisticsIncludeAllRecords)
                        {
                            <span>Mostrando todos los registros históricos</span>
                        }
                        else
                        {
                            <span>Aplicando filtro de fechas</span>
                        }
                    </small>
                </div>

                @if (!StatisticsIncludeAllRecords)
                {
                    <div class="col-md-3">
                        <label class="form-label">Fecha Inicio</label>
                        <input type="date" @bind="StatisticsStartDate" @bind:format="yyyy-MM-dd" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fecha Fin</label>
                        <input type="date" @bind="StatisticsEndDate" @bind:format="yyyy-MM-dd" class="form-control" />
                    </div>
                }

                <div class="col-md-3">
                    <button class="btn btn-info w-100" @onclick="LoadStatistics" disabled="@IsLoadingStatistics">
                        <i class="fas fa-sync-alt @(IsLoadingStatistics ? "fa-spin" : "")"></i>
                        @(IsLoadingStatistics ? "Cargando..." : "Actualizar Estadísticas")
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Generales -->
    @if (ShowStatistics)
    {
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-primary">
                    <div class="card-body text-center">
                        <h4>@TotalProfessionals</h4>
                        <p class="mb-0">Total Profesionales</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-success">
                    <div class="card-body text-center">
                        <h4>@TotalAreas</h4>
                        <p class="mb-0">Áreas Médicas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-warning">
                    <div class="card-body text-center">
                        <h4>@TotalLocations</h4>
                        <p class="mb-0">Ubicaciones</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card text-white bg-info">
                    <div class="card-body text-center">
                        <h4>@TotalConsultations</h4>
                        <p class="mb-0">Total Atenciones</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA: Atenciones por Género -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-venus-mars me-2"></i>Atenciones por Género</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm @(GenderViewMode == "table" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetGenderViewMode("table")'>
                                <i class="fas fa-table"></i>
                            </button>
                            <button class="btn btn-sm @(GenderViewMode == "chart" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetGenderViewMode("chart")'>
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (GenderViewMode == "table")
                        {
                            @if (AttentionsByGender.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Género</th>
                                                <th>Cantidad</th>
                                                <th>Porcentaje</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in AttentionsByGender.OrderByDescending(x => x.Value))
                                            {
                                                <tr>
                                                    <td>@item.Key</td>
                                                    <td><span class="badge bg-primary">@item.Value</span></td>
                                                    <td>@(TotalConsultations > 0 ? ((item.Value * 100.0 / TotalConsultations).ToString("F1") + "%") : "0%")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>No hay datos disponibles
                                </div>
                            }
                        }
                        else
                        {
                            <canvas id="genderChart" style="height: 300px; width: 100%;"></canvas>
                        }
                    </div>
                </div>
            </div>

            <!-- TABLA: Atenciones por Ciudad/Provincia -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Atenciones por Ubicación Geográfica</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm @(LocationViewMode == "table" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetLocationViewMode("table")'>
                                <i class="fas fa-table"></i>
                            </button>
                            <button class="btn btn-sm @(LocationViewMode == "chart" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetLocationViewMode("chart")'>
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (LocationViewMode == "table")
                        {
                            @if (AttentionsByLocation.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Provincia</th>
                                                <th>Ciudad</th>
                                                <th>Departamento/Área</th>
                                                <th class="text-end">Cantidad</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{
                                                var currentProvince = "";
                                                var rowCount = 0;
                                            }
                                            @foreach (var item in AttentionsByLocation)
                                            {
                                                rowCount++;
                                                var isNewProvince = currentProvince != item.Province;
                                                currentProvince = item.Province;

                                                <tr>
                                                    <td>
                                                        @if (isNewProvince)
                                                        {
                                                            <strong>@item.Province</strong>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted"></span>
                                                        }
                                                    </td>
                                                    <td>@item.City</td>
                                                    <td>@item.Department</td>
                                                    <td class="text-end">
                                                        <span class="badge bg-success">@item.Count</span>
                                                    </td>
                                                </tr>

                                                @if (rowCount >= 50) // Limitar a 50 filas para mejor rendimiento
                                                {
                                                    <tr>
                                                        <td colspan="4" class="text-center text-muted">
                                                            <small>Mostrando las primeras 50 ubicaciones. Use filtros para resultados específicos.</small>
                                                        </td>
                                                    </tr>
                                                    break;
                                                }
                                            }
                                        </tbody>
                                        <tfoot class="table-secondary">
                                            <tr>
                                                <td colspan="3"><strong>TOTAL ATENCIONES</strong></td>
                                                <td class="text-end">
                                                    <strong>
                                                        <span class="badge bg-dark">
                                                            @AttentionsByLocation.Sum(x => x.Count)
                                                        </span>
                                                    </strong>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan="4" class="text-muted">
                                                    <small>
                                                        <i class="fas fa-info-circle me-1"></i>
                                                        Mostrando @AttentionsByLocation.Count combinaciones únicas de ubicación/área
                                                    </small>
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                                    <p class="mb-0">No hay datos de atenciones por ubicación</p>
                                </div>
                            }
                        }
                        else
                        {
                            <canvas id="locationChart" style="height: 300px; width: 100%;"></canvas>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA: Atenciones por Rango de Edad y Departamento -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-user-clock me-2"></i>Atenciones por Rango de Edad y Departamento</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm @(AgeViewMode == "table" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetAgeViewMode("table")'>
                                <i class="fas fa-table"></i>
                            </button>
                            <button class="btn btn-sm @(AgeViewMode == "chart" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetAgeViewMode("chart")'>
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (AgeViewMode == "table")
                        {
                            @if (AttentionsByAgeRange.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Rango de Edad</th>
                                                @foreach (var area in AttentionsByAgeRange.First().ByDepartment.Keys.OrderBy(x => x))
                                                {
                                                    <th>@area</th>
                                                }
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in AttentionsByAgeRange.OrderBy(x => x.MinAge))
                                            {
                                                <tr>
                                                    <td><strong>@item.Range</strong></td>
                                                    @foreach (var area in item.ByDepartment.Keys.OrderBy(x => x))
                                                    {
                                                        <td><span class="badge bg-info">@item.ByDepartment[area]</span></td>
                                                    }
                                                    <td><strong><span class="badge bg-warning">@item.Total</span></strong></td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>No hay datos disponibles
                                </div>
                            }
                        }
                        else
                        {
                            <canvas id="ageChart" style="height: 400px; width: 100%;"></canvas>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA: Derivaciones entre Departamentos -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Derivaciones entre Departamentos</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm @(ReferralViewMode == "table" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetReferralViewMode("table")'>
                                <i class="fas fa-table"></i>
                            </button>
                            <button class="btn btn-sm @(ReferralViewMode == "chart" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetReferralViewMode("chart")'>
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (ReferralViewMode == "table")
                        {
                            @if (ReferralsBetweenDepartments.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Hacia (Departamento)</th>
                                                <th>Desde (Departamento)</th>
                                                <th>Cantidad de Derivaciones</th>
                                                <th>Porcentaje</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @{
                                                var totalReferrals = ReferralsBetweenDepartments.Sum(x => x.Count);
                                            }
                                            @foreach (var item in ReferralsBetweenDepartments.OrderByDescending(x => x.Count))
                                            {
                                                <tr>
                                                    <td>@item.FromDepartment</td>
                                                    <td>@item.ToDepartment</td>
                                                    <td><span class="badge bg-danger">@item.Count</span></td>
                                                    <td>@((item.Count * 100.0 / Math.Max(totalReferrals, 1)).ToString("F1"))%</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>No hay datos disponibles
                                </div>
                            }
                        }
                        else
                        {
                            <canvas id="referralChart" style="height: 400px; width: 100%;"></canvas>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA: Servicios Realizados por Departamento -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-briefcase-medical me-2"></i>Servicios Realizados por Profesional</h6>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm @(ServiceViewMode == "table" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetServiceViewMode("table")'>
                                <i class="fas fa-table"></i>
                            </button>
                            <button class="btn btn-sm @(ServiceViewMode == "chart" ? "btn-light" : "btn-outline-light")"
                                    @onclick='async () => await SetServiceViewMode("chart")'>
                                <i class="fas fa-chart-bar"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        @if (ServiceViewMode == "table")
                        {
                            @if (ServicesByDepartment.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Profesional</th>
                                                <th>Total Servicios</th>
                                                <th>Tipos de Servicios</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in ServicesByDepartment.OrderByDescending(x => x.TotalServices))
                                            {
                                                <tr>
                                                    <td>@item.Department</td>
                                                    <td><span class="badge bg-info">@item.TotalServices</span></td>
                                                    <td>
                                                        @foreach (var serviceType in item.ServiceTypes)
                                                        {
                                                            <span class="badge bg-secondary me-1">@serviceType.Key: @serviceType.Value</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>No hay datos disponibles
                                </div>
                            }
                        }
                        else
                        {
                            <canvas id="serviceChart" style="height: 400px; width: 100%;"></canvas>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA: Atenciones por Área -->
        <div class="row">
            <div class="col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-hospital-alt me-2"></i>Atenciones por Área Médica</h6>
                        <div class="d-flex align-items-center">
                            <button class="btn btn-sm btn-outline-light me-2" @onclick="ToggleAreaFilters">
                                <i class="fas fa-filter"></i> Filtros
                            </button>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm @(AreaViewMode == "table" ? "btn-light" : "btn-outline-light")"
                                        @onclick='async () => await SetAreaViewMode("table")'>
                                    <i class="fas fa-table"></i>
                                </button>
                                <button class="btn btn-sm @(AreaViewMode == "chart" ? "btn-light" : "btn-outline-light")"
                                        @onclick='async () => await SetAreaViewMode("chart")'>
                                    <i class="fas fa-chart-bar"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros de área -->
                    @if (ShowAreaFilters)
                    {
                        <div class="card-body border-bottom">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label">Fecha Inicio</label>
                                    <input type="date" @bind="AreaFilterStartDate" @bind:format="yyyy-MM-dd" class="form-control" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Fecha Fin</label>
                                    <input type="date" @bind="AreaFilterEndDate" @bind:format="yyyy-MM-dd" class="form-control" />
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-purple w-100" @onclick="ApplyAreaFilters">
                                        <i class="fas fa-check me-2"></i>Aplicar Filtros
                                    </button>
                                </div>
                            </div>
                            @if (AreaFilterStartDate.HasValue && AreaFilterEndDate.HasValue)
                            {
                                <div class="mt-2 text-center">
                                    <small class="text-muted">
                                        Mostrando datos desde @AreaFilterStartDate.Value.ToString("dd/MM/yyyy") hasta @AreaFilterEndDate.Value.ToString("dd/MM/yyyy")
                                    </small>
                                </div>
                            }
                        </div>
                    }

                    <div class="card-body">
                        @if (AreaViewMode == "table")
                        {
                            @if (AttentionsByArea.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-striped table-hover">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Área Médica</th>
                                                <th class="text-center">Total Atenciones</th>
                                                <th class="text-center">Pacientes Únicos</th>
                                                <th class="text-center">Prom. Atenciones/Paciente</th>
                                                <th class="text-center">Tendencia</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in AttentionsByArea)
                                            {
                                                <tr>
                                                    <td>
                                                        <strong>@item.Area</strong>
                                                        @if (item.ConsultationsByMonth.Any(x => x.Value > 0))
                                                        {
                                                            <br />
                                                            <small class="text-muted">
                                                                Último mes: @item.ConsultationsByMonth.OrderByDescending(x => x.Key).FirstOrDefault(x => x.Value > 0).Value atenciones
                                                            </small>
                                                        }
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-primary fs-6">@item.TotalConsultations</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-info fs-6">@item.UniquePatients</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span class="badge bg-secondary fs-6">@item.AverageConsultationsPerPatient.ToString("F1")</span>
                                                    </td>
                                                    <td class="text-center">
                                                        <div class="d-flex justify-content-center">
                                                            <div class="mini-chart-container" style="width: 150px; height: 40px;">
                                                                <canvas id="miniChart-@item.Area.Replace(" ", "-").Replace("/", "-")"></canvas>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                        <tfoot class="table-secondary">
                                            <tr>
                                                <td><strong>TOTAL GENERAL</strong></td>
                                                <td class="text-center">
                                                    <strong><span class="badge bg-dark fs-6">@AttentionsByArea.Sum(x => x.TotalConsultations)</span></strong>
                                                </td>
                                                <td class="text-center">
                                                    <strong><span class="badge bg-dark fs-6">@AttentionsByArea.Sum(x => x.UniquePatients)</span></strong>
                                                </td>
                                                <td class="text-center">
                                                    <strong>
                                                        <span class="badge bg-dark fs-6">
                                                            @{
                                                                var totalPatients = AttentionsByArea.Sum(x => x.UniquePatients);
                                                                var avg = totalPatients > 0
                                                                ? (AttentionsByArea.Sum(x => x.TotalConsultations) / (double)totalPatients).ToString("F1")
                                                                : "0.0";
                                                            }
                                                            @avg
                                                        </span>
                                                    </strong>
                                                </td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                <!-- Gráficos miniaturas para cada área -->
                                <div style="display: none;">
                                    @foreach (var item in AttentionsByArea)
                                    {
                                        var safeAreaName = item.Area.Replace(" ", "-").Replace("/", "-");
                                        <div id="data-@safeAreaName"
                                             data-months='@JsonSerializer.Serialize(item.ConsultationsByMonth.Keys.Select(m =>
                                         DateTime.ParseExact(m + "-01", "yyyy-MM-dd", CultureInfo.InvariantCulture).ToString("MMM")).ToArray())'
                                             data-values='@JsonSerializer.Serialize(item.ConsultationsByMonth.Values.ToArray())'>
                                        </div>
                                    }
                                </div>

                                <!-- Renderizar mini gráficos después de renderizar la tabla -->
                                @if (AreaViewMode == "table")
                                {
                                    <script>
                                        setTimeout(() => {
                                            if (typeof renderAreaMiniCharts !== 'undefined') {
                                                renderAreaMiniCharts();
                                            }
                                        }, 300);
                                    </script>
                                }
                            }
                            else
                            {
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                                    <p class="mb-0">No hay datos de atenciones por área para el período seleccionado</p>
                                </div>
                            }
                        }
                        else
                        {
                            <canvas id="areaChart" style="height: 400px; width: 100%;"></canvas>
                        }
                    </div>
                    @if (AreaViewMode == "table" && AttentionsByArea.Any())
                    {
                        <div class="card-footer text-muted">
                            <div class="row">
                                <div class="col-md-6">
                                    <small>
                                        <i class="fas fa-info-circle me-1"></i>
                                        Mostrando @AttentionsByArea.Count áreas médicas
                                    </small>
                                </div>
                                <div class="col-md-6 text-end">
                                    <small>
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        Período: @AreaStartDate.ToString("MMM yyyy") - @AreaEndDate.ToString("MMM yyyy")
                                        (@((AreaEndDate - AreaStartDate).Days / 30) meses)
                                    </small>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    
</div>

@code {
    private ReportRequestDTO ReportRequest { get; set; } = new();
    private List<HealthProfessionalDTO> Professionals { get; set; } = new();
    private List<HealthProfessionalDTO> FilteredProfessionals { get; set; } = new();
    private List<LocationDTO> Areas { get; set; } = new();
    private List<PlaceOfAttentionDTO> Locations { get; set; } = new();
    private bool IsLoading = false;
    private bool IsLoadingStatistics = false;
    private bool ShowStatistics = true;
    private string Message = string.Empty;
    private string ErrorMessage = string.Empty;

    private string _selectedArea = "";
    private string SelectedArea
    {
        get => _selectedArea;
        set
        {
            if (_selectedArea != value)
            {
                _selectedArea = value;
                ReportRequest.Area = value;
                _ = OnAreaChanged(value);
            }
        }
    }

    private readonly Dictionary<string, List<int>> _areaToProfessionalTypes = new()
        {
            ["Enfermería"] = new List<int> { 9 }, // Enfermero
            ["Médico General"] = new List<int> { 1 }, // Médico General
            ["Nutrición"] = new List<int> { 17 }, // Nutricionista
            ["Psicología"] = new List<int> { 27, 18 }, // Psicólogo y Psicólogo Clínico
            ["Fisioterapia"] = new List<int> { 15 }, // Fisioterapeuta
            ["Estimulación Temprana"] = new List<int> { 4 }, // Pediatra
            ["Ginecología"] = new List<int> { 5 }, // Ginecólogo
            ["Obstetricia"] = new List<int> { 26 } // Obstetra
        };

    // Variables para control de estadísticas
    private bool StatisticsIncludeAllRecords = true;
    private DateTime? StatisticsStartDate;
    private DateTime? StatisticsEndDate;

    // Variables para estadísticas generales
    private int TotalProfessionals = 0;
    private int TotalAreas = 0;
    private int TotalLocations = 0;
    private int TotalConsultations = 0;

    // VARIABLES PARA LAS TABLAS
    private Dictionary<string, int> AttentionsByGender = new();
    private List<LocationAttentionData> AttentionsByLocation = new();
    private List<AgeRangeAttentionData> AttentionsByAgeRange = new();
    private List<ReferralBetweenDepartmentsData> ReferralsBetweenDepartments = new();
    private List<ServicesByDepartmentData> ServicesByDepartment = new();
    private List<AttentionByAreaData> AttentionsByArea = new();


    // Variables para controlar vista tabla/gráfico
    private string GenderViewMode = "table";
    private string LocationViewMode = "table";
    private string AgeViewMode = "table";
    private string ReferralViewMode = "table";
    private string ServiceViewMode = "table";
    private string AreaViewMode = "table";

    // Variables para control de filtros de área
    private bool ShowAreaFilters = false;
    private DateTime? AreaFilterStartDate;
    private DateTime? AreaFilterEndDate;
    private DateTime AreaStartDate;
    private DateTime AreaEndDate;


    protected override async Task OnInitializedAsync()
    {
        await LoadDropdownData();
        await LoadStatistics();

        // Inicializar la lista filtrada con todos los profesionales
        FilteredProfessionals = new List<HealthProfessionalDTO>(Professionals);
    }

    private async Task LoadDropdownData()
    {
        try
        {
            Professionals = (await HealthProfessionalService.GetAllHealthProfessionalsAsync()).ToList();
            FilteredProfessionals = new List<HealthProfessionalDTO>(Professionals);
            Areas = (await LocationService.GetAllAsync()).ToList();
            Locations = (await PlaceOfAttentionService.GetAllPlacesAsync()).ToList();

            // Cargar información adicional de personas para obtener los tipos de profesional
            await LoadProfessionalTypeInfo();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error cargando datos: {ex.Message}";
        }
    }

    private async Task LoadProfessionalTypeInfo()
    {
        try
        {
            // Obtener todas las personas para tener acceso a la información de HealthProfessional
            var allPersons = await PersonService.GetAllPersons();

            // Para cada profesional, buscar su persona correspondiente para obtener el tipo
            foreach (var professional in Professionals)
            {
                var person = allPersons.FirstOrDefault(p => p.Id == professional.HealthProfessionalId);
                if (person != null && person.HealthProfessional != null)
                {
                    // Si tenemos el HealthProfessionalTypeId en el DTO, lo usamos
                    // Si no, intentamos obtenerlo de la persona
                    if (person.HealthProfessional.HealthProfessionalTypeId.HasValue)
                    {
                        professional.HealthProfessionalTypeId = person.HealthProfessional.HealthProfessionalTypeId;

                        // También podemos mapear el nombre del tipo si no está presente
                        if (string.IsNullOrEmpty(professional.NameTypeProfessional))
                        {
                            professional.NameTypeProfessional = GetProfessionalTypeName(person.HealthProfessional.HealthProfessionalTypeId.Value);
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando información de tipos de profesional: {ex.Message}");
        }
    }

    private string GetProfessionalTypeName(int typeId)
    {
        return typeId switch
        {
            1 => "Médico General",
            2 => "Médico Especialista",
            3 => "Cirujano",
            4 => "Pediatra",
            5 => "Ginecólogo",
            6 => "Cardiólogo",
            7 => "Neurólogo",
            8 => "Psiquiatra",
            9 => "Enfermero",
            11 => "Odontólogo",
            12 => "Farmacéutico",
            13 => "Bioquímico",
            14 => "Tecnólogo Médico",
            15 => "Fisioterapeuta",
            16 => "Terapeuta Ocupacional",
            17 => "Nutricionista",
            18 => "Psicólogo Clínico",
            19 => "Técnico en Radiología",
            20 => "Laboratorista Clínico",
            21 => "Optómetra",
            22 => "Audiólogo",
            23 => "Partera",
            24 => "Otro Profesional de Salud",
            25 => "Ninguno",
            26 => "Obstetra",
            27 => "Psicólogo",
            _ => "Desconocido"
        };
    }

    private async Task OnAreaChanged(string area)
    {
        await FilterProfessionalsByArea(area);
        StateHasChanged();
    }

    private async Task FilterProfessionalsByArea(string area)
    {
        try
        {
            if (string.IsNullOrEmpty(area))
            {
                // Si no hay área seleccionada, mostrar todos los profesionales
                FilteredProfessionals = new List<HealthProfessionalDTO>(Professionals);
                return;
            }

            // Verificar si el área tiene tipos de profesionales asignados
            if (_areaToProfessionalTypes.ContainsKey(area))
            {
                var professionalTypeIds = _areaToProfessionalTypes[area];

                // Filtrar profesionales por tipo
                FilteredProfessionals = Professionals
                    .Where(p =>
                        p.HealthProfessionalTypeId.HasValue &&
                        professionalTypeIds.Contains(p.HealthProfessionalTypeId.Value))
                    .ToList();

                // Si no encontramos profesionales por ID, intentar filtrar por nombre del tipo
                if (!FilteredProfessionals.Any())
                {
                    FilteredProfessionals = Professionals
                        .Where(p => !string.IsNullOrEmpty(p.NameTypeProfessional))
                        .Where(p => professionalTypeIds.Any(typeId =>
                            p.NameTypeProfessional.Contains(GetProfessionalTypeName(typeId), StringComparison.OrdinalIgnoreCase)))
                        .ToList();
                }
            }
            else
            {
                // Si el área no tiene tipos asignados, mostrar todos los profesionales
                FilteredProfessionals = new List<HealthProfessionalDTO>(Professionals);
            }

            // Limpiar la selección de profesional si ya no está en la lista filtrada
            if (ReportRequest.HealthProfessionalId.HasValue &&
                !FilteredProfessionals.Any(p => p.HealthProfessionalId == ReportRequest.HealthProfessionalId.Value))
            {
                ReportRequest.HealthProfessionalId = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error filtrando profesionales: {ex.Message}");
            FilteredProfessionals = new List<HealthProfessionalDTO>(Professionals);
        }
    }

    // MÉTODOS PARA CAMBIAR VISTA Y RENDERIZAR GRÁFICOS
    private async Task SetGenderViewMode(string mode)
    {
        GenderViewMode = mode;
        StateHasChanged();
        if (mode == "chart" && AttentionsByGender.Any())
        {
            await Task.Delay(100);
            await InitializeGenderChart();
        }
    }

    private async Task SetLocationViewMode(string mode)
    {
        LocationViewMode = mode;
        StateHasChanged();
        if (mode == "chart" && AttentionsByLocation.Any())
        {
            await Task.Delay(100);
            await InitializeLocationChart();
        }
    }

    private async Task SetAgeViewMode(string mode)
    {
        AgeViewMode = mode;
        StateHasChanged();
        if (mode == "chart" && AttentionsByAgeRange.Any())
        {
            await Task.Delay(100);
            await InitializeAgeChart();
        }
    }

    private async Task SetReferralViewMode(string mode)
    {
        ReferralViewMode = mode;
        StateHasChanged();
        if (mode == "chart" && ReferralsBetweenDepartments.Any())
        {
            await Task.Delay(100);
            await InitializeReferralChart();
        }
    }

    private async Task SetServiceViewMode(string mode)
    {
        ServiceViewMode = mode;
        StateHasChanged();
        if (mode == "chart" && ServicesByDepartment.Any())
        {
            await Task.Delay(100);
            await InitializeServiceChart();
        }
    }

    private async Task SetAreaViewMode(string mode)
    {
        AreaViewMode = mode;
        StateHasChanged();

        await Task.Delay(300); // Dar tiempo para el renderizado del DOM

        if (mode == "chart" && AttentionsByArea.Any())
        {
            // Esperar a que el canvas esté disponible
            await Task.Delay(100);

            var areas = AttentionsByArea.Take(15).Select(x => x.Area).ToArray();
            var totals = AttentionsByArea.Take(15).Select(x => x.TotalConsultations).ToArray();

            await JSRuntime.InvokeVoidAsync("renderAreaChart", "areaChart", areas, totals);
        }
        else if (mode == "table" && AttentionsByArea.Any())
        {
            await Task.Delay(100);
            await JSRuntime.InvokeVoidAsync("renderAreaMiniCharts");
        }
    }

    // MÉTODOS PARA INICIALIZAR GRÁFICOS
    private async Task InitializeGenderChart()
    {
        try
        {
            var labels = AttentionsByGender.Keys.ToArray();
            var data = AttentionsByGender.Values.ToArray();
            var colors = new[] { "#3b82f6", "#ef4444", "#10b981" };

            await JSRuntime.InvokeVoidAsync("renderGenderChart", "genderChart", labels, data, colors);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando gráfico de género: {ex.Message}");
        }
    }

    private async Task InitializeLocationChart()
    {
        try
        {
            // Agrupar por provincia para el gráfico
            var provinces = AttentionsByLocation
                .GroupBy(x => x.Province)
                .Select(g => new
                {
                    Province = g.Key,
                    Count = g.Sum(x => x.Count)
                })
                .OrderByDescending(x => x.Count)
                .Take(10) // Top 10 provincias
                .ToArray();

            var labels = provinces.Select(x => x.Province).ToArray();
            var data = provinces.Select(x => x.Count).ToArray();

            await JSRuntime.InvokeVoidAsync("renderLocationChart", "locationChart", labels, data);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando gráfico de ubicación: {ex.Message}");
        }
    }

    private async Task InitializeAgeChart()
    {
        try
        {
            var ageRanges = AttentionsByAgeRange.Select(x => x.Range).ToArray();
            var departments = Areas.Select(x => x.Name).Take(5).ToArray();
            var data = AttentionsByAgeRange.ToDictionary(ar => ar.Range, ar => ar.ByDepartment);

            await JSRuntime.InvokeVoidAsync("renderAgeChart", "ageChart", ageRanges, departments, data);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando gráfico de edad: {ex.Message}");
        }
    }

    private async Task InitializeReferralChart()
    {
        try
        {
            var referrals = ReferralsBetweenDepartments.Take(15)
                .Select(r => new { from = r.FromDepartment, to = r.ToDepartment, count = r.Count })
                .ToArray();

            await JSRuntime.InvokeVoidAsync("renderReferralChart", "referralChart", referrals);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando gráfico de derivaciones: {ex.Message}");
        }
    }

    private async Task InitializeServiceChart()
    {
        try
        {
            var professionals = ServicesByDepartment
                .Take(10)
                .Select(x => x.Department)
                .ToArray();

            var totals = ServicesByDepartment
                .Take(10)
                .Select(x => x.TotalServices)
                .ToArray();

            await JSRuntime.InvokeVoidAsync("renderServiceChart", "serviceChart", professionals, totals);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando gráfico de servicios: {ex.Message}");
        }
    }

    private async Task InitializeAreaChart()
    {
        try
        {
            var areas = AttentionsByArea.Take(15).Select(x => x.Area).ToArray();
            var totals = AttentionsByArea.Take(15).Select(x => x.TotalConsultations).ToArray();

            await JSRuntime.InvokeVoidAsync("renderAreaChart", "areaChart", areas, totals);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error inicializando gráfico de área: {ex.Message}");
        }
    }

    private async Task LoadStatistics()
    {
        IsLoadingStatistics = true;
        Message = string.Empty;
        ErrorMessage = string.Empty;

        try
        {
            if (!StatisticsIncludeAllRecords && (!StatisticsStartDate.HasValue || !StatisticsEndDate.HasValue))
            {
                ErrorMessage = "Por favor seleccione ambas fechas para filtrar las estadísticas.";
                return;
            }

            // Cargar todas las personas
            var allPersons = await PersonService.GetAllPersons();

            // Cargar estadísticas básicas
            var statisticalData = await ReportService.GetStatisticalDataAsync(
                StatisticsStartDate,
                StatisticsEndDate,
                StatisticsIncludeAllRecords);

            TotalProfessionals = statisticalData.TotalProfessionals;
            TotalAreas = statisticalData.ConsultationsByArea.Count;
            TotalLocations = Locations.Count;
            TotalConsultations = statisticalData.TotalConsultations;

            // Cargar datos de atenciones médicas
            var request = new ReportRequestDTO
                {
                    IncludeAllRecords = StatisticsIncludeAllRecords,
                    StartDate = StatisticsStartDate,
                    EndDate = StatisticsEndDate
                };

            var professionalData = await ReportService.GetProfessionalReportDataAsync(request);

            // Procesar atenciones por género
            await ProcessAttentionsByGender(professionalData, allPersons);

            // Procesar atenciones por ubicación geográfica
            await ProcessAttentionsByLocation(allPersons);

            // Procesar atenciones por rango de edad
            await ProcessAttentionsByAgeRange(professionalData, allPersons);

            // Procesar derivaciones entre departamentos
            await ProcessReferralsBetweenDepartments();

            // Procesar servicios por departamento
            await ProcessServicesByDepartment();

            // Procesar atenciones por área
            await ProcessAttentionsByArea(professionalData, allPersons);


            Message = "Estadísticas actualizadas correctamente";
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error cargando estadísticas: {ex.Message}";
            Console.WriteLine($"Error en LoadStatistics: {ex}");
        }
        finally
        {
            IsLoadingStatistics = false;
            StateHasChanged();
        }
    }

    private async Task ProcessAttentionsByGender(List<ProfessionalReportDTO> professionalData, List<PersonDTO> allPersons)
    {
        try
        {
            // Obtener TODAS las atenciones médicas según los filtros
            List<MedicalCareDTO> allMedicalCares;

            if (StatisticsIncludeAllRecords)
            {
                allMedicalCares = await MedicalCareService.GetAllAsync() ?? new List<MedicalCareDTO>();
            }
            else if (StatisticsStartDate.HasValue && StatisticsEndDate.HasValue)
            {
                allMedicalCares = await GetMedicalCaresByDateRangeAsync(StatisticsStartDate, StatisticsEndDate);
            }
            else
            {
                allMedicalCares = await MedicalCareService.GetAllAsync() ?? new List<MedicalCareDTO>();
            }

            if (!allMedicalCares.Any())
            {
                AttentionsByGender = new Dictionary<string, int>();
                return;
            }

            // Crear diccionario de género por paciente ID para optimizar búsquedas
            var patientGenderCache = new Dictionary<int, string>();

            foreach (var person in allPersons)
            {
                var genderName = person.GenderId switch
                {
                    1 => "Masculino",
                    2 => "Femenino",
                    _ => "Otro"
                };
                patientGenderCache[person.Id] = genderName;
            }

            // Contar atenciones por género
            var genderCounts = new Dictionary<string, int>
        {
            { "Masculino", 0 },
            { "Femenino", 0 },
            { "Otro", 0 }
        };

            foreach (var medicalCare in allMedicalCares)
            {
                if (patientGenderCache.TryGetValue(medicalCare.PatientId, out var gender))
                {
                    genderCounts[gender]++;
                }
            }

            // Filtrar géneros con al menos 1 atención
            AttentionsByGender = genderCounts
                .Where(x => x.Value > 0)
                .ToDictionary(x => x.Key, x => x.Value);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error procesando atenciones por género: {ex.Message}");
            AttentionsByGender = new Dictionary<string, int>();
        }
    }

    private async Task ProcessAttentionsByLocation(List<PersonDTO> allPersons)
    {
        var locationData = new List<LocationAttentionData>();

        // Obtener TODAS las atenciones médicas
        List<MedicalCareDTO> allMedicalCares;

        if (StatisticsIncludeAllRecords)
        {
            allMedicalCares = await MedicalCareService.GetAllAsync() ?? new List<MedicalCareDTO>();
        }
        else if (StatisticsStartDate.HasValue && StatisticsEndDate.HasValue)
        {
            allMedicalCares = await GetMedicalCaresByDateRangeAsync(StatisticsStartDate, StatisticsEndDate);
        }
        else
        {
            allMedicalCares = await MedicalCareService.GetAllAsync() ?? new List<MedicalCareDTO>();
        }

        if (!allMedicalCares.Any())
        {
            AttentionsByLocation = locationData;
            return;
        }

        // Diccionario para cachear información de pacientes
        var patientInfoCache = new Dictionary<int, (string Province, string City)>();

        foreach (var medicalCare in allMedicalCares)
        {
            try
            {
                if (string.IsNullOrEmpty(medicalCare.Area))
                    continue;

                // Obtener información de ubicación del paciente
                (string Province, string City) locationInfo;

                if (!patientInfoCache.TryGetValue(medicalCare.PatientId, out locationInfo))
                {
                    var patient = allPersons.FirstOrDefault(p => p.Id == medicalCare.PatientId);
                    if (patient?.Residence != null)
                    {
                        locationInfo = (
                            Province: patient.Residence.ProvinceName ?? "Sin provincia",
                            City: patient.Residence.CityName ?? "Sin ciudad"
                        );
                    }
                    else
                    {
                        locationInfo = ("Sin provincia", "Sin ciudad");
                    }
                    patientInfoCache[medicalCare.PatientId] = locationInfo;
                }

                // Buscar si ya existe esta combinación en los datos
                var existingRecord = locationData.FirstOrDefault(x =>
                    x.Province == locationInfo.Province &&
                    x.City == locationInfo.City &&
                    x.Department == medicalCare.Area);

                if (existingRecord != null)
                {
                    existingRecord.Count++;
                }
                else
                {
                    locationData.Add(new LocationAttentionData
                        {
                            Province = locationInfo.Province,
                            City = locationInfo.City,
                            Department = medicalCare.Area,
                            Count = 1
                        });
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error procesando atención ID {medicalCare.CareId}: {ex.Message}");
            }
        }

        // Ordenar: Primero por provincia, luego por ciudad, luego por cantidad (descendente)
        AttentionsByLocation = locationData
            .OrderBy(x => x.Province)
            .ThenBy(x => x.City)
            .ThenByDescending(x => x.Count)
            .ThenBy(x => x.Department)
            .ToList();
    }

    private async Task ProcessAttentionsByAgeRange(List<ProfessionalReportDTO> professionalData, List<PersonDTO> allPersons)
    {
        // Obtener TODAS las atenciones médicas
        List<MedicalCareDTO> allMedicalCares;

        if (StatisticsIncludeAllRecords)
        {
            // Obtener todas las atenciones médicas
            allMedicalCares = await MedicalCareService.GetAllAsync() ?? new List<MedicalCareDTO>();
        }
        else if (StatisticsStartDate.HasValue && StatisticsEndDate.HasValue)
        {
            // Obtener atenciones filtradas por fecha
            allMedicalCares = await GetMedicalCaresByDateRangeAsync(StatisticsStartDate, StatisticsEndDate);
        }
        else
        {
            // Usar todas las atenciones si no hay filtro
            allMedicalCares = await MedicalCareService.GetAllAsync() ?? new List<MedicalCareDTO>();
        }

        var ageRanges = new List<AgeRangeAttentionData>
    {
        new AgeRangeAttentionData { Range = "0-10 años", MinAge = 0, MaxAge = 10 },
        new AgeRangeAttentionData { Range = "11-20 años", MinAge = 11, MaxAge = 20 },
        new AgeRangeAttentionData { Range = "21-30 años", MinAge = 21, MaxAge = 30 },
        new AgeRangeAttentionData { Range = "31-40 años", MinAge = 31, MaxAge = 40 },
        new AgeRangeAttentionData { Range = "41-50 años", MinAge = 41, MaxAge = 50 },
        new AgeRangeAttentionData { Range = "51-60 años", MinAge = 51, MaxAge = 60 },
        new AgeRangeAttentionData { Range = "61+ años", MinAge = 61, MaxAge = 200 }
    };

        var departmentNames = Areas.Select(a => a.Name).ToList();

        // Inicializar todos los rangos de edad con todos los departamentos
        foreach (var ageRange in ageRanges)
        {
            foreach (var dept in departmentNames)
            {
                ageRange.ByDepartment[dept] = 0;
            }
            ageRange.Total = 0;
        }

        // Procesar cada atención médica
        foreach (var medicalCare in allMedicalCares)
        {
            try
            {
                // Buscar al paciente por ID
                var patient = allPersons.FirstOrDefault(p => p.Id == medicalCare.PatientId);

                if (patient == null)
                    continue;

                if (patient.BirthDate.HasValue)
                {
                    var age = CalculateAge(patient.BirthDate.Value);
                    var ageRange = ageRanges.FirstOrDefault(ar => age >= ar.MinAge && age <= ar.MaxAge);

                    if (ageRange != null && !string.IsNullOrEmpty(medicalCare.Area))
                    {
                        // Verificar si el departamento/área existe en el diccionario
                        if (ageRange.ByDepartment.ContainsKey(medicalCare.Area))
                        {
                            ageRange.ByDepartment[medicalCare.Area]++;
                        }
                        else
                        {
                            // Si el área no existe en la lista, agregarla
                            ageRange.ByDepartment[medicalCare.Area] = 1;
                            if (!departmentNames.Contains(medicalCare.Area))
                            {
                                departmentNames.Add(medicalCare.Area);
                            }
                        }
                        ageRange.Total++;
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error procesando atención médica ID {medicalCare.CareId}: {ex.Message}");
            }
        }

        // Asegurar que todos los rangos tengan todas las áreas en su diccionario
        foreach (var ageRange in ageRanges)
        {
            foreach (var dept in departmentNames)
            {
                if (!ageRange.ByDepartment.ContainsKey(dept))
                {
                    ageRange.ByDepartment[dept] = 0;
                }
            }
        }

        // Filtrar solo los rangos que tienen datos
        AttentionsByAgeRange = ageRanges.Where(ar => ar.Total > 0).ToList();
    }

    private async Task ProcessReferralsBetweenDepartments()
    {
        var allReferrals = await MedicalReferralService.GetAllAsync();

        if (!allReferrals.Success || allReferrals.Data == null)
        {
            ReferralsBetweenDepartments = new List<ReferralBetweenDepartmentsData>();
            return;
        }

        var referralData = allReferrals.Data
            .Where(r => !string.IsNullOrEmpty(r.ReferringArea) && !string.IsNullOrEmpty(r.LocationName))
            .GroupBy(r => new { From = r.ReferringArea, To = r.LocationName })
            .Select(g => new ReferralBetweenDepartmentsData
                {
                    FromDepartment = g.Key.From,
                    ToDepartment = g.Key.To,
                    Count = g.Count()
                })
            .ToList();

        ReferralsBetweenDepartments = referralData;
    }

    private async Task ProcessServicesByDepartment()
    {
        var allServices = await MedicalServiceService.GetAllAsync();

        if (allServices == null || !allServices.Any())
        {
            ServicesByDepartment = new List<ServicesByDepartmentData>();
            return;
        }

        // Obtener todos los profesionales para poder obtener sus nombres completos
        var allProfessionals = await HealthProfessionalService.GetAllHealthProfessionalsAsync();

        // Agrupar servicios por profesional
        var serviceData = allServices
            .Where(s => s.HealthProfessionalId > 0 && s.ServiceDate.HasValue)
            .GroupBy(s => s.HealthProfessionalId)
            .Select(g =>
            {
                // Encontrar el profesional correspondiente
                var professional = allProfessionals?.FirstOrDefault(p => p.HealthProfessionalId == g.Key);
                var professionalName = professional?.FullName ?? $"Profesional ID: {g.Key}";

                return new ServicesByDepartmentData
                    {
                    // Cambiar Department por ProfessionalName
                        Department = professionalName, // Aquí usamos el nombre del profesional
                        TotalServices = g.Count(),
                        ServiceTypes = g.GroupBy(s => s.ServiceType ?? "Sin tipo")
                            .ToDictionary(sg => sg.Key, sg => sg.Count())
                    };
            })
            .OrderByDescending(x => x.TotalServices)
            .ToList();

        ServicesByDepartment = serviceData;
    }

    private async Task ProcessAttentionsByArea(List<ProfessionalReportDTO> professionalData, List<PersonDTO> allPersons)
    {
        try
        {
            var areaData = new List<AttentionByAreaData>();

            // Obtener todas las atenciones médicas filtradas por fecha si es necesario
            List<MedicalCareDTO> medicalCares;

            if (StatisticsIncludeAllRecords)
            {
                // Obtener todas las atenciones médicas
                medicalCares = await MedicalCareService.GetAllAsync() ?? new List<MedicalCareDTO>();
            }
            else
            {
                // Obtener atenciones filtradas por fecha usando un método alternativo
                // Necesitarás crear un método en MedicalCareService para filtrar por fecha
                medicalCares = await GetMedicalCaresByDateRangeAsync(StatisticsStartDate, StatisticsEndDate);
            }

            if (medicalCares == null || !medicalCares.Any())
            {
                AttentionsByArea = areaData;
                return;
            }

            // Agrupar por área
            var consultationsByArea = medicalCares
                .Where(c => !string.IsNullOrEmpty(c.Area))
                .GroupBy(c => c.Area)
                .Select(g => new
                {
                    Area = g.Key,
                    Consultations = g.ToList(),
                    TotalConsultations = g.Count(),
                    UniquePatients = g.Select(c => c.PatientId)
                        .Distinct()
                        .Count()
                })
                .ToList();

            // Determinar el rango de meses a mostrar
            DateTime startDate, endDate;

            if (StatisticsIncludeAllRecords)
            {
                // Mostrar todos los registros - determinar rango dinámico
                var earliestDate = medicalCares.Min(c => c.CareDate);
                var latestDate = medicalCares.Max(c => c.CareDate);

                // Mostrar últimos 12 meses o desde el inicio si menos de 12 meses
                startDate = (latestDate - earliestDate).TotalDays > 365
                    ? latestDate.AddMonths(-11)
                    : earliestDate;
                endDate = latestDate;
            }
            else if (StatisticsStartDate.HasValue && StatisticsEndDate.HasValue)
            {
                // Usar fechas del filtro
                startDate = StatisticsStartDate.Value;
                endDate = StatisticsEndDate.Value;
            }
            else
            {
                // Por defecto últimos 6 meses
                endDate = DateTime.Now;
                startDate = endDate.AddMonths(-5);
            }

            // Generar lista de meses
            var months = new List<string>();
            var currentDate = new DateTime(startDate.Year, startDate.Month, 1);
            var endMonth = new DateTime(endDate.Year, endDate.Month, 1);

            while (currentDate <= endMonth)
            {
                months.Add(currentDate.ToString("yyyy-MM"));
                currentDate = currentDate.AddMonths(1);
            }

            foreach (var areaGroup in consultationsByArea)
            {
                var areaItem = new AttentionByAreaData
                    {
                        Area = areaGroup.Area,
                        TotalConsultations = areaGroup.TotalConsultations,
                        UniquePatients = areaGroup.UniquePatients,
                        AverageConsultationsPerPatient = areaGroup.UniquePatients > 0
                            ? Math.Round((double)areaGroup.TotalConsultations / areaGroup.UniquePatients, 2)
                            : 0
                    };

                // Agrupar por mes
                var consultationsByMonth = areaGroup.Consultations
                    .GroupBy(c => new DateTime(c.CareDate.Year, c.CareDate.Month, 1).ToString("yyyy-MM"))
                    .ToDictionary(g => g.Key, g => g.Count());

                // Inicializar todos los meses (incluso con 0)
                foreach (var month in months)
                {
                    areaItem.ConsultationsByMonth[month] = consultationsByMonth.ContainsKey(month)
                        ? consultationsByMonth[month]
                        : 0;
                }

                areaData.Add(areaItem);
            }

            // Ordenar por total de atenciones
            AttentionsByArea = areaData
                .OrderByDescending(x => x.TotalConsultations)
                .ThenBy(x => x.Area)
                .ToList();

            // Guardar el rango de fechas para mostrar en la UI
            AreaStartDate = startDate;
            AreaEndDate = endDate;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error procesando atenciones por área: {ex.Message}");
            AttentionsByArea = new List<AttentionByAreaData>();
        }
    }

    // Método auxiliar para obtener atenciones por rango de fechas
    private async Task<List<MedicalCareDTO>> GetMedicalCaresByDateRangeAsync(DateTime? startDate, DateTime? endDate)
    {
        try
        {
            // Primero obtenemos todas las atenciones
            var allMedicalCares = await MedicalCareService.GetAllAsync() ?? new List<MedicalCareDTO>();

            if (!allMedicalCares.Any())
                return new List<MedicalCareDTO>();

            // Filtramos por fecha si se especificó
            if (startDate.HasValue && endDate.HasValue)
            {
                return allMedicalCares
                    .Where(c => c.CareDate.Date >= startDate.Value.Date &&
                               c.CareDate.Date <= endDate.Value.Date)
                    .ToList();
            }
            else if (startDate.HasValue)
            {
                return allMedicalCares
                    .Where(c => c.CareDate.Date >= startDate.Value.Date)
                    .ToList();
            }
            else if (endDate.HasValue)
            {
                return allMedicalCares
                    .Where(c => c.CareDate.Date <= endDate.Value.Date)
                    .ToList();
            }

            return allMedicalCares;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error obteniendo atenciones por rango de fechas: {ex.Message}");
            return new List<MedicalCareDTO>();
        }
    }
    // Métodos para filtros de área
    private void ToggleAreaFilters()
    {
        ShowAreaFilters = !ShowAreaFilters;
        if (ShowAreaFilters)
        {
            // Inicializar fechas con el rango actual
            AreaFilterStartDate = AreaStartDate;
            AreaFilterEndDate = AreaEndDate;
        }
    }

    private async Task ApplyAreaFilters()
    {
        if (!AreaFilterStartDate.HasValue || !AreaFilterEndDate.HasValue)
        {
            ErrorMessage = "Por favor seleccione ambas fechas para filtrar";
            return;
        }

        if (AreaFilterStartDate.Value > AreaFilterEndDate.Value)
        {
            ErrorMessage = "La fecha de inicio no puede ser mayor a la fecha de fin";
            return;
        }

        // Actualizar las estadísticas con las nuevas fechas
        StatisticsIncludeAllRecords = false;
        StatisticsStartDate = AreaFilterStartDate;
        StatisticsEndDate = AreaFilterEndDate;

        await LoadStatistics();
        ShowAreaFilters = false;
        Message = "Filtros aplicados correctamente";
    }

    private int CalculateAge(DateTime birthDate)
    {
        var today = DateTime.Today;
        var age = today.Year - birthDate.Year;
        if (birthDate.Date > today.AddYears(-age)) age--;
        return age;
    }

    private async Task GenerateReport()
    {
        if (string.IsNullOrEmpty(ReportRequest.ReportType))
        {
            ErrorMessage = "Por favor seleccione un tipo de reporte";
            return;
        }

        if (!ValidateReportRequirements())
        {
            return;
        }

        IsLoading = true;
        ErrorMessage = string.Empty;
        Message = string.Empty;

        try
        {
            var cleanRequest = new ReportRequestDTO
                {
                    ReportType = ReportRequest.ReportType,
                    StartDate = ReportRequest.StartDate?.Date,
                    EndDate = ReportRequest.EndDate?.Date,
                    Format = "PDF",
                    Area = ReportRequest.Area ?? "",
                    LocationId = ReportRequest.LocationId,
                    HealthProfessionalId = ReportRequest.HealthProfessionalId,
                    PlaceOfAttentionId = ReportRequest.PlaceOfAttentionId,
                    DocumentNumber = ReportRequest.DocumentNumber ?? "",
                    IncludeAllRecords = false
                };

            byte[] reportContent = cleanRequest.ReportType switch
            {
                "medical-care" => await ReportService.GenerateMedicalCareReportAsync(cleanRequest),
                "patient" => await ReportService.GeneratePatientReportAsync(cleanRequest),
                "professional" => await ReportService.GenerateProfessionalReportAsync(cleanRequest),
                "professional-detail" => await ReportService.GenerateProfessionalDetailReportAsync(cleanRequest),
                "location" => await ReportService.GenerateLocationReportAsync(cleanRequest),
                "area" => await ReportService.GenerateAreaReportAsync(cleanRequest),
                "top-patients" => await ReportService.GenerateTopPatientReportAsync(cleanRequest),
                "statistical" => await ReportService.GenerateStatisticalReportAsync(cleanRequest),
                _ => throw new ArgumentException("Tipo de reporte no válido")
            };

            Message = $"Reporte {GetReportTypeName(cleanRequest.ReportType)} generado exitosamente";

            var fileName = $"{GetReportTypeName(cleanRequest.ReportType)}_{DateTime.Now:yyyyMMddHHmmss}.pdf";
            await ReportService.DownloadReport(reportContent, fileName);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error generando reporte: {ex.Message}";
            Console.WriteLine($"Error detallado: {ex}");
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private bool ValidateReportRequirements()
    {
        switch (ReportRequest.ReportType)
        {
            case "professional-detail":
                if (!ReportRequest.HealthProfessionalId.HasValue)
                {
                    ErrorMessage = "Para el reporte detallado de profesional, debe seleccionar un profesional específico";
                    return false;
                }
                break;

            case "location":
                if (!ReportRequest.PlaceOfAttentionId.HasValue)
                {
                    ErrorMessage = "Para el reporte por ubicación, debe seleccionar una ubicación específica";
                    return false;
                }
                break;

            case "area":
                if (string.IsNullOrEmpty(ReportRequest.Area))
                {
                    ErrorMessage = "Para el reporte por área, debe seleccionar un área específica";
                    return false;
                }
                break;
        }

        if (ReportRequest.StartDate.HasValue && ReportRequest.EndDate.HasValue)
        {
            if (ReportRequest.StartDate.Value > ReportRequest.EndDate.Value)
            {
                ErrorMessage = "La fecha de inicio no puede ser mayor a la fecha de fin";
                return false;
            }
        }

        return true;
    }

    private async Task ClearReportFilters()
    {
        ReportRequest = new ReportRequestDTO
            {
                Format = "PDF",
                IncludeAllRecords = false
            };

        // Limpiar el área seleccionada
        _selectedArea = "";

        // Restablecer la lista de profesionales filtrados
        FilteredProfessionals = new List<HealthProfessionalDTO>(Professionals);

        Message = string.Empty;
        ErrorMessage = string.Empty;
        StateHasChanged();
    }

    private string GetReportTypeName(string reportType)
    {
        return reportType switch
        {
            "medical-care" => "Atenciones_Médicas",
            "patient" => "Pacientes",
            "professional" => "Profesionales",
            "professional-detail" => "Detalle_Profesional",
            "location" => "Por_Ubicación",
            "area" => "Por_Área",
            "top-patients" => "Pacientes_Más_Atenciones",
            "statistical" => "Estadístico",
            _ => "Reporte"
        };
    }

    // Clases auxiliares para datos
    public class GeographicAttentionData
    {
        public string Province { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public int Count { get; set; }
    }

    public class AgeRangeAttentionData
    {
        public string Range { get; set; } = string.Empty;
        public int MinAge { get; set; }
        public int MaxAge { get; set; }
        public Dictionary<string, int> ByDepartment { get; set; } = new();
        public int Total { get; set; }
    }

    public class ReferralBetweenDepartmentsData
    {
        public string FromDepartment { get; set; } = string.Empty;
        public string ToDepartment { get; set; } = string.Empty;
        public int Count { get; set; }
    }

    public class ServicesByDepartmentData
    {
        public string Department { get; set; } = string.Empty;
        public string ProfessionalName { get; set; } = string.Empty; // Nueva propiedad
        public int TotalServices { get; set; }
        public Dictionary<string, int> ServiceTypes { get; set; } = new();
    }

    public class AttentionByAreaData
    {
        public string Area { get; set; } = string.Empty;
        public int TotalConsultations { get; set; }
        public int UniquePatients { get; set; }
        public double AverageConsultationsPerPatient { get; set; }
        public Dictionary<string, int> ConsultationsByMonth { get; set; } = new();
    }

    public class LocationAttentionData
    {
        public string Province { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public int Count { get; set; }
    }


}