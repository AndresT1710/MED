@inject NavigationManager NavigationManager
@using SMED.FrontEnd.Services
@inject AuthorizationService AuthorizationService

<div class="tab-container-wrapper">
    <div class="tab-container">
        <ul class="tab-header nav nav-tabs">
            @foreach (var tab in VisibleTabs)
            {
                <li class="nav-item">
                    <a class="nav-link @(IsActive(tab.Url) ? "active" : "")"
                       href="@tab.Url">@tab.Title</a>
                </li>
            }
        </ul>

        <div class="tab-body">
            @ChildContent
        </div>
    </div>
</div>

@code {
    [Parameter] public RenderFragment? ChildContent { get; set; }
    [Parameter] public EventCallback OnSave { get; set; }

    private List<TabItem> AllTabs = new()
    {
        new TabItem("Registro", "/medical-history/registro"),
        new TabItem("General", "/medical-history/general"),
        new TabItem("Obstétrico", "/medical-history/obstetric"),
        new TabItem("Ginecológico", "/medical-history/gynecological"),
        new TabItem("Nutrición", "/medical-history/nutrition"),
        new TabItem("Psicológico", "/medical-history/psychological"),
        new TabItem("Fisioterapia", "/medical-history/physiotherapy"),
        new TabItem("Estimulación temprana", "/medical-history/earlystimulation"),
    };

    private List<TabItem> VisibleTabs { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadVisibleTabs();
    }

    private async Task LoadVisibleTabs()
    {
        VisibleTabs.Clear();

        foreach (var tab in AllTabs)
        {
            if (await AuthorizationService.HasAccessToMedicalHistoryTabAsync(tab.Title))
            {
                VisibleTabs.Add(tab);
            }
        }

        StateHasChanged();
    }

    private bool IsActive(string url) => NavigationManager.Uri.Contains(url, StringComparison.OrdinalIgnoreCase);

    private async Task OnSaveClick()
    {
        if (OnSave.HasDelegate)
            await OnSave.InvokeAsync(null);
    }

    private record TabItem(string Title, string Url);
}