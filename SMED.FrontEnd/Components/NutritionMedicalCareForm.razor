@namespace SMED.FrontEnd.Components
@using SMED.FrontEnd.Components
@using SMED.Shared.DTOs
@using SMED.Shared.Entity
@using SMED.FrontEnd.Services
@inject MedicalCareService MedicalCareService
@inject HealthProfessionalService HealthProfessionalService
@inject PlaceOfAttentionService PlaceService
@inject ReasonForConsultationService ReasonForConsultationService
@inject LocationService LocationService
@inject AuthorizationService AuthorizationService
@inject SkinFoldsService SkinFoldsService
@inject MeasurementsService MeasurementsService
@inject BioImpedanceService BioImpedanceService
@inject PerimetersService PerimetersService
@inject DiametersService DiametersService
@inject FoodPlanService FoodPlanService
@inject ForbiddenFoodService ForbiddenFoodService
@inject FoodService FoodService
@inject MedicalReferralService MedicalReferralService
@inject IJSRuntime JS
@inject NavigationManager Navigation
@implements IDisposable

<div class="nutrition-care-form">
    <!-- Sistema de pestañas -->
    <ul class="nav nav-tabs" id="nutritionTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "patient" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("patient"))"
                    type="button" role="tab">
                <i class="fas fa-user me-2"></i>Selección de Paciente
                @if (IsPatientTabComplete())
                {
                    <span class="badge bg-success ms-1">✓</span>
                }
                else
                {
                    <span class="badge bg-danger ms-1">*</span>
                }
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "pliegues" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("pliegues"))"
                    type="button" role="tab"
                    disabled="@(!IsPatientTabComplete() || currentMedicalCareId == 0)">
                <i class="fas fa-ruler-combined me-2"></i>Pliegues
                @if (IsPlieguesComplete())
                {
                    <span class="badge bg-success ms-1">✓</span>
                }
                <small class="text-muted ms-1">(Opcional)</small>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "bioimpedancia" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("bioimpedancia"))"
                    type="button" role="tab"
                    disabled="@(!IsPatientTabComplete() || currentMedicalCareId == 0)">
                <i class="fas fa-weight me-2"></i>Bioimpedancia
                @if (IsBioimpedanciaComplete())
                {
                    <span class="badge bg-success ms-1">✓</span>
                }
                <small class="text-muted ms-1">(Opcional)</small>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "perimetros" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("perimetros"))"
                    type="button" role="tab"
                    disabled="@(!IsPatientTabComplete() || currentMedicalCareId == 0)">
                <i class="fas fa-ruler me-2"></i>Perímetros
                @if (IsPerimetrosComplete())
                {
                    <span class="badge bg-success ms-1">✓</span>
                }
                <small class="text-muted ms-1">(Opcional)</small>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "diametros" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("diametros"))"
                    type="button" role="tab"
                    disabled="@(!IsPatientTabComplete() || currentMedicalCareId == 0)">
                <i class="fas fa-arrows-alt-h me-2"></i>Diámetros
                @if (IsDiametrosComplete())
                {
                    <span class="badge bg-success ms-1">✓</span>
                }
                <small class="text-muted ms-1">(Opcional)</small>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "plan" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("plan"))"
                    type="button" role="tab"
                    disabled="@(!IsPatientTabComplete() || currentMedicalCareId == 0)">
                <i class="fas fa-utensils me-2"></i>Plan Alimentación
                @if (IsPlanComplete())
                {
                    <span class="badge bg-success ms-1">✓</span>
                }
                <small class="text-muted ms-1">(Opcional)</small>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "referral" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("referral"))"
                    type="button" role="tab"
                    disabled="@(!IsPatientTabComplete() || currentMedicalCareId == 0)">
                <i class="fas fa-share me-2"></i>Derivación
                @if (IsReferralTabComplete())
                {
                    <span class="badge bg-success ms-1">✓</span>
                }
                <small class="text-muted ms-1">(Opcional)</small>
            </button>
        </li>
    </ul>

    <div class="tab-content mt-3">
        <!-- Pestaña 1: Selección de Paciente -->
        <div class="tab-pane @(activeTab == "patient" ? "show active" : "")" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-apple-alt me-2"></i>Selección de Paciente - Nutrición
                        <span class="badge bg-danger ms-2">Obligatorio</span>
                        <span class="badge bg-success ms-2">
                            <i class="fas fa-apple-alt me-1"></i>Área: Nutrición
                        </span>
                    </h5>
                </div>
                <div class="card-body">
                    @if (!isEditMode)
                    {
                        <div class="mb-3">
                            <label class="form-label fw-bold">Paciente *</label>
                            <PatientSelector @bind-Value="clinicalHistoryId"
                                             OnPatientSelected="HandlePatientSelected" />
                            @if (showValidationErrors && selectedPatientId <= 0)
                            {
                                <div class="text-danger mt-1">
                                    <small><i class="fas fa-exclamation-triangle me-1"></i>Debe seleccionar un paciente</small>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Editando atención de nutrición existente. Paciente: @selectedHistoryNumber
                        </div>
                    }

                    @if (selectedPatientId > 0)
                    {
                        <div class="alert alert-success mt-3">
                            <i class="fas fa-check-circle me-2"></i>
                            Paciente seleccionado correctamente. Historia Clínica: @selectedHistoryNumber
                        </div>

                        <div class="alert alert-info mb-3">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-info-circle me-2"></i>
                                <div>
                                    <strong>Área de Atención:</strong> Nutrición
                                    <br>
                                    <small class="text-muted">Esta atención se registrará automáticamente en el área de Nutrición.</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label fw-bold">Lugar de Atención *</label>
                                <select class="form-select @(showValidationErrors && string.IsNullOrEmpty(lugarSeleccionada) ? "is-invalid" : "")"
                                        @bind="lugarSeleccionada">
                                    <option value="">Seleccione el lugar de Atención</option>
                                    @foreach (var lugar in lugaresAtencion)
                                    {
                                        <option value="@lugar.Id">@lugar.Name</option>
                                    }
                                </select>
                                @if (showValidationErrors && string.IsNullOrEmpty(lugarSeleccionada))
                                {
                                    <div class="invalid-feedback">
                                        Debe seleccionar un lugar de atención
                                    </div>
                                }
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Motivo de la Consulta *</label>
                            <textarea class="form-control @(showValidationErrors && string.IsNullOrWhiteSpace(motivoConsulta) ? "is-invalid" : "")"
                                      @bind="motivoConsulta"
                                      rows="3"
                                      placeholder="Describa el motivo principal de la consulta de nutrición..."
                                      maxlength="500"></textarea>
                            @if (showValidationErrors && string.IsNullOrWhiteSpace(motivoConsulta))
                            {
                                <div class="invalid-feedback">
                                    Debe ingresar el motivo de la consulta
                                </div>
                            }
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Nutricionista *</label>

                            @if (profesionalCargado)
                            {
                                @if (profesionalLogueado != null)
                                {
                                    <div class="alert alert-success">
                                        <i class="fas fa-user-md me-2"></i>
                                        <strong>Nutricionista asignado automáticamente:</strong>
                                        @profesionalLogueado.FullName - @profesionalLogueado.NameTypeProfessional
                                        <input type="hidden" @bind="selectedHealthProfessionalId" />
                                        <div class="mt-1">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                Usted ha sido asignado automáticamente como el profesional responsable.
                                            </small>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>No se pudo identificar su perfil profesional.</strong>
                                        <div class="mt-2">
                                            <select class="form-select @(showValidationErrors && selectedHealthProfessionalId <= 0 ? "is-invalid" : "")"
                                                    @bind="selectedHealthProfessionalId">
                                                <option value="0">Seleccione un nutricionista manualmente</option>
                                                @foreach (var profesional in nutricionistas)
                                                {
                                                    <option value="@profesional.HealthProfessionalId">
                                                        @profesional.FullName - @profesional.NameTypeProfessional
                                                    </option>
                                                }
                                            </select>
                                        </div>
                                        @if (showValidationErrors && selectedHealthProfessionalId <= 0)
                                        {
                                            <div class="invalid-feedback d-block">
                                                Debe seleccionar un nutricionista responsable
                                            </div>
                                        }
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    <span>Cargando información del profesional...</span>
                                </div>
                            }
                        </div>

                        @if (!IsPatientTabComplete())
                        {
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Complete todos los campos obligatorios para continuar a las siguientes pestañas.
                            </div>
                        }

                        <div class="d-flex justify-content-between mt-3">
                            <div>
                                <button class="btn btn-outline-secondary" @onclick="ValidateAndShowErrors">
                                    <i class="fas fa-check me-2"></i>Validar Información
                                </button>
                            </div>
                            <div>
                                @if (IsPatientTabComplete())
                                {
                                    <button class="btn btn-success me-2" @onclick="GuardarDatosPaciente" disabled="@isSaving">
                                        @if (isSaving)
                                        {
                                            <span class="spinner-border spinner-border-sm me-2"></span>
                                        }
                                        <i class="fas fa-save me-2"></i>@(currentMedicalCareId > 0 ? "Actualizar" : "Guardar") Datos Básicos
                                    </button>
                                    @if (currentMedicalCareId > 0)
                                    {
                                        <button class="btn btn-primary" @onclick="@(() => SetActiveTab("pliegues"))">
                                            Continuar a Pliegues <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    }
                                }
                                else
                                {
                                    <button class="btn btn-secondary" disabled>
                                        Complete la información obligatoria
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Pestaña 2: Pliegues -->
        <div class="tab-pane @(activeTab == "pliegues" ? "show active" : "")" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-ruler-combined me-2"></i>Medición de Pliegues Cutáneos
                        <span class="badge bg-info ms-2">Opcional</span>
                    </h5>
                </div>
                <div class="card-body">
                    @if (currentMedicalCareId > 0)
                    {
                        @if (isLoadingPreviousMeasurements)
                        {
                            <div class="alert alert-info mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    <span>Cargando medidas anteriores...</span>
                                </div>
                            </div>
                        }
                        else if (patientMedicalHistory.Any())
                        {
                            <div class="alert alert-success mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Se encontraron <strong>@patientMedicalHistory.Count</strong> atenciones anteriores con mediciones.
                                Las medidas anteriores se muestran debajo de cada campo.
                            </div>
                        }

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Sección de Pliegues Cutáneos</strong> - Complete las mediciones antropométricas del paciente. Los datos se guardan automáticamente.
                        </div>

                        <div class="row g-3">
                            <!-- Primera fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Subescapular (mm)</span>
                                    @if (GetPreviousSkinFolds("Subescapular").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousSkinFolds("Subescapular").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@skinFoldsData.Subscapular"
                                               @bind-Content:after="AutoSaveSkinFolds" />
                                @if (GetPreviousSkinFolds("Subescapular").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousSkinFolds("Subescapular")" />
                                }
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Tríceps (mm)</span>
                                    @if (GetPreviousSkinFolds("Tríceps").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousSkinFolds("Tríceps").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@skinFoldsData.Triceps"
                                               @bind-Content:after="AutoSaveSkinFolds" />
                                @if (GetPreviousSkinFolds("Tríceps").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousSkinFolds("Tríceps")" />
                                }
                            </div>

                            <!-- Segunda fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Bíceps (mm)</span>
                                    @if (GetPreviousSkinFolds("Bíceps").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousSkinFolds("Bíceps").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@skinFoldsData.Biceps"
                                               @bind-Content:after="AutoSaveSkinFolds" />
                                @if (GetPreviousSkinFolds("Bíceps").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousSkinFolds("Bíceps")" />
                                }
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Cresta Ilíaca (mm)</span>
                                    @if (GetPreviousSkinFolds("Cresta Ilíaca").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousSkinFolds("Cresta Ilíaca").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@skinFoldsData.IliacCrest"
                                               @bind-Content:after="AutoSaveSkinFolds" />
                                @if (GetPreviousSkinFolds("Cresta Ilíaca").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousSkinFolds("Cresta Ilíaca")" />
                                }
                            </div>

                            <!-- Tercera fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Supraespinal (mm)</span>
                                    @if (GetPreviousSkinFolds("Supraespinal").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousSkinFolds("Supraespinal").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@skinFoldsData.Supraespinal"
                                               @bind-Content:after="AutoSaveSkinFolds" />
                                @if (GetPreviousSkinFolds("Supraespinal").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousSkinFolds("Supraespinal")" />
                                }
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Abdominal (mm)</span>
                                    @if (GetPreviousSkinFolds("Abdominal").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousSkinFolds("Abdominal").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@skinFoldsData.Abdominal"
                                               @bind-Content:after="AutoSaveSkinFolds" />
                                @if (GetPreviousSkinFolds("Abdominal").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousSkinFolds("Abdominal")" />
                                }
                            </div>

                            <!-- Cuarta fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Muslo Frontal (mm)</span>
                                    @if (GetPreviousSkinFolds("Muslo Frontal").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousSkinFolds("Muslo Frontal").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@skinFoldsData.FrontalThigh"
                                               @bind-Content:after="AutoSaveSkinFolds" />
                                @if (GetPreviousSkinFolds("Muslo Frontal").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousSkinFolds("Muslo Frontal")" />
                                }
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Pantorrilla Medial (mm)</span>
                                    @if (GetPreviousSkinFolds("Pantorrilla Medial").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousSkinFolds("Pantorrilla Medial").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@skinFoldsData.MedialCalf"
                                               @bind-Content:after="AutoSaveSkinFolds" />
                                @if (GetPreviousSkinFolds("Pantorrilla Medial").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousSkinFolds("Pantorrilla Medial")" />
                                }
                            </div>

                            <!-- Quinta fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Axilar Medial (mm)</span>
                                    @if (GetPreviousSkinFolds("Axilar Medial").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousSkinFolds("Axilar Medial").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@skinFoldsData.MedialAxillary"
                                               @bind-Content:after="AutoSaveSkinFolds" />
                                @if (GetPreviousSkinFolds("Axilar Medial").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousSkinFolds("Axilar Medial")" />
                                }
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Pectoral (mm)</span>
                                    @if (GetPreviousSkinFolds("Pectoral").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousSkinFolds("Pectoral").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@skinFoldsData.Pectoral"
                                               @bind-Content:after="AutoSaveSkinFolds" />
                                @if (GetPreviousSkinFolds("Pectoral").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousSkinFolds("Pectoral")" />
                                }
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-secondary" @onclick="@(() => SetActiveTab("patient"))">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </button>
                            <button class="btn btn-primary" @onclick="@(() => SetActiveTab("bioimpedancia"))">
                                Continuar a Bioimpedancia <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Debe guardar primero los datos básicos del paciente para acceder a esta sección.
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Pestaña 3: Bioimpedancia -->
        <div class="tab-pane @(activeTab == "bioimpedancia" ? "show active" : "")" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-weight me-2"></i>Bioimpedancia
                        <span class="badge bg-info ms-2">Opcional</span>
                    </h5>
                </div>
                <div class="card-body">
                    @if (currentMedicalCareId > 0)
                    {
                        @if (isLoadingPreviousMeasurements)
                        {
                            <div class="alert alert-info mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    <span>Cargando medidas anteriores...</span>
                                </div>
                            </div>
                        }
                        else if (patientMedicalHistory.Any())
                        {
                            <div class="alert alert-success mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Se encontraron <strong>@patientMedicalHistory.Count</strong> atenciones anteriores con mediciones.
                                Las medidas anteriores se muestran debajo de cada campo.
                            </div>
                        }

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Análisis de Composición Corporal</strong> - Registre los resultados de la bioimpedancia. Los datos se guardan automáticamente.
                        </div>

                        <div class="row g-3">
                            <!-- Primera fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Porcentaje de Grasa Corporal (%)</span>
                                    @if (GetPreviousBioImpedance("BodyFatPercentage").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousBioImpedance("BodyFatPercentage").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@bioImpedanceData.BodyFatPercentage"
                                               @bind-Content:after="AutoSaveBioImpedance" />
                                @if (GetPreviousBioImpedance("BodyFatPercentage").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousBioImpedance("BodyFatPercentage")" />
                                }
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Porcentaje Grasa Sección Superior (%)</span>
                                    @if (GetPreviousBioImpedance("UpperSectionFatPercentage").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousBioImpedance("UpperSectionFatPercentage").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@bioImpedanceData.UpperSectionFatPercentage"
                                               @bind-Content:after="AutoSaveBioImpedance" />
                                @if (GetPreviousBioImpedance("UpperSectionFatPercentage").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousBioImpedance("UpperSectionFatPercentage")" />
                                }
                            </div>

                            <!-- Segunda fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Porcentaje Grasa Sección Inferior (%)</span>
                                    @if (GetPreviousBioImpedance("LowerSectionFatPercentage").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousBioImpedance("LowerSectionFatPercentage").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@bioImpedanceData.LowerSectionFatPercentage"
                                               @bind-Content:after="AutoSaveBioImpedance" />
                                @if (GetPreviousBioImpedance("LowerSectionFatPercentage").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousBioImpedance("LowerSectionFatPercentage")" />
                                }
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Grasa Visceral</span>
                                    @if (GetPreviousBioImpedance("VisceralFat").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousBioImpedance("VisceralFat").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@bioImpedanceData.VisceralFat"
                                               @bind-Content:after="AutoSaveBioImpedance" />
                                @if (GetPreviousBioImpedance("VisceralFat").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousBioImpedance("VisceralFat")" />
                                }
                            </div>

                            <!-- Tercera fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Masa Muscular (kg)</span>
                                    @if (GetPreviousBioImpedance("MuscleMass").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousBioImpedance("MuscleMass").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@bioImpedanceData.MuscleMass"
                                               @bind-Content:after="AutoSaveBioImpedance" />
                                @if (GetPreviousBioImpedance("MuscleMass").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousBioImpedance("MuscleMass")" />
                                }
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Peso Óseo (kg)</span>
                                    @if (GetPreviousBioImpedance("BoneWeight").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousBioImpedance("BoneWeight").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@bioImpedanceData.BoneWeight"
                                               @bind-Content:after="AutoSaveBioImpedance" />
                                @if (GetPreviousBioImpedance("BoneWeight").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousBioImpedance("BoneWeight")" />
                                }
                            </div>

                            <!-- Cuarta fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Agua Corporal (L)</span>
                                    @if (GetPreviousBioImpedance("BodyWater").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousBioImpedance("BodyWater").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@bioImpedanceData.BodyWater"
                                               @bind-Content:after="AutoSaveBioImpedance" />
                                @if (GetPreviousBioImpedance("BodyWater").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousBioImpedance("BodyWater")" />
                                }
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-secondary" @onclick="@(() => SetActiveTab("pliegues"))">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </button>
                            <button class="btn btn-primary" @onclick="@(() => SetActiveTab("perimetros"))">
                                Continuar a Perímetros <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Debe guardar primero los datos básicos del paciente para acceder a esta sección.
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Pestaña 4: Perímetros -->
        <div class="tab-pane @(activeTab == "perimetros" ? "show active" : "")" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-ruler me-2"></i>Medición de Perímetros Corporales
                        <span class="badge bg-info ms-2">Opcional</span>
                    </h5>
                </div>
                <div class="card-body">
                    @if (currentMedicalCareId > 0)
                    {
                        @if (isLoadingPreviousMeasurements)
                        {
                            <div class="alert alert-info mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    <span>Cargando medidas anteriores...</span>
                                </div>
                            </div>
                        }
                        else if (patientMedicalHistory.Any())
                        {
                            <div class="alert alert-success mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Se encontraron <strong>@patientMedicalHistory.Count</strong> atenciones anteriores con mediciones.
                                Las medidas anteriores se muestran debajo de cada campo.
                            </div>
                        }

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Perímetros Corporales</strong> - Registre las circunferencias del paciente. Los datos se guardan automáticamente.
                        </div>

                        <div class="row g-3">
                            <!-- Primera fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Cefálico (cm)</span>
                                    @if (GetPreviousPerimeters("Cefálico").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousPerimeters("Cefálico").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@perimetersData.Cephalic"
                                               @bind-Content:after="AutoSavePerimeters" />
                                @if (GetPreviousPerimeters("Cefálico").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousPerimeters("Cefálico")" />
                                }
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Cuello (cm)</span>
                                    @if (GetPreviousPerimeters("Cuello").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousPerimeters("Cuello").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@perimetersData.Neck"
                                               @bind-Content:after="AutoSavePerimeters" />
                                @if (GetPreviousPerimeters("Cuello").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousPerimeters("Cuello")" />
                                }
                            </div>

                            <!-- Segunda fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Mitad Brazo Relajado (cm)</span>
                                    @if (GetPreviousPerimeters("Mitad Brazo Relajado").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousPerimeters("Mitad Brazo Relajado").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@perimetersData.RelaxedArmHalf"
                                               @bind-Content:after="AutoSavePerimeters" />
                                @if (GetPreviousPerimeters("Mitad Brazo Relajado").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousPerimeters("Mitad Brazo Relajado")" />
                                }
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Antebrazo (cm)</span>
                                    @if (GetPreviousPerimeters("Antebrazo").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousPerimeters("Antebrazo").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@perimetersData.Forearm"
                                               @bind-Content:after="AutoSavePerimeters" />
                                @if (GetPreviousPerimeters("Antebrazo").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousPerimeters("Antebrazo")" />
                                }
                            </div>

                            <!-- Tercera fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Muñeca (cm)</span>
                                    @if (GetPreviousPerimeters("Muñeca").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousPerimeters("Muñeca").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@perimetersData.Wrist"
                                               @bind-Content:after="AutoSavePerimeters" />
                                @if (GetPreviousPerimeters("Muñeca").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousPerimeters("Muñeca")" />
                                }
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-secondary" @onclick="@(() => SetActiveTab("bioimpedancia"))">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </button>
                            <button class="btn btn-primary" @onclick="@(() => SetActiveTab("diametros"))">
                                Continuar a Diámetros <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Debe guardar primero los datos básicos del paciente para acceder a esta sección.
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Pestaña 5: Diámetros -->
        <div class="tab-pane @(activeTab == "diametros" ? "show active" : "")" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-arrows-alt-h me-2"></i>Medición de Diámetros Óseos
                        <span class="badge bg-info ms-2">Opcional</span>
                    </h5>
                </div>
                <div class="card-body">
                    @if (currentMedicalCareId > 0)
                    {
                        @if (isLoadingPreviousMeasurements)
                        {
                            <div class="alert alert-info mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    <span>Cargando medidas anteriores...</span>
                                </div>
                            </div>
                        }
                        else if (patientMedicalHistory.Any())
                        {
                            <div class="alert alert-success mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                Se encontraron <strong>@patientMedicalHistory.Count</strong> atenciones anteriores con mediciones.
                                Las medidas anteriores se muestran debajo de cada campo.
                            </div>
                        }

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Diámetros Óseos</strong> - Registre las medidas de la estructura ósea. Los datos se guardan automáticamente.
                        </div>

                        <div class="row g-3">
                            <!-- Primera fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Húmero (cm)</span>
                                    @if (GetPreviousDiameters("Húmero").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousDiameters("Húmero").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@diametersData.Humerus"
                                               @bind-Content:after="AutoSaveDiameters" />
                                @if (GetPreviousDiameters("Húmero").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousDiameters("Húmero")" />
                                }
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Fémur (cm)</span>
                                    @if (GetPreviousDiameters("Fémur").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousDiameters("Fémur").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@diametersData.Femur"
                                               @bind-Content:after="AutoSaveDiameters" />
                                @if (GetPreviousDiameters("Fémur").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousDiameters("Fémur")" />
                                }
                            </div>

                            <!-- Segunda fila -->
                            <div class="col-md-6">
                                <label class="form-label fw-bold d-flex justify-content-between">
                                    <span>Muñeca (cm)</span>
                                    @if (GetPreviousDiameters("Muñeca").Any())
                                    {
                                        <span class="badge bg-info">
                                            <i class="fas fa-history me-1"></i>
                                            @GetPreviousDiameters("Muñeca").Count anteriores
                                        </span>
                                    }
                                </label>
                                <ContainerBox1 Width="full"
                                               @bind-Content="@diametersData.Wrist"
                                               @bind-Content:after="AutoSaveDiameters" />
                                @if (GetPreviousDiameters("Muñeca").Any())
                                {
                                    <PreviousMeasurementsComponent 
                                        PreviousMeasurements="@GetPreviousDiameters("Muñeca")" />
                                }
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-secondary" @onclick="@(() => SetActiveTab("perimetros"))">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </button>
                            <button class="btn btn-primary" @onclick="@(() => SetActiveTab("plan"))">
                                Continuar a Plan Alimentación <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Debe guardar primero los datos básicos del paciente para acceder a esta sección.
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Pestaña 6: Plan Alimentación -->
        <div class="tab-pane @(activeTab == "plan" ? "show active" : "")" role="tabpanel">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-utensils me-2"></i>Plan de Alimentación
                        <span class="badge bg-info ms-2">Opcional</span>
                    </h5>
                </div>
                <div class="card-body">
                    @if (currentMedicalCareId > 0)
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Plan Nutricional Personalizado</strong> - Establezca las recomendaciones alimentarias.
                        </div>

                        <!-- Tabla: Plan de Alimentación -->
                        <div class="mb-5">
                            <EditableTable Title="Plan de Alimentación"
                                           ColumnHeaders="@foodPlanHeaders"
                                           Rows="@foodPlanRows"
                                           RowIds="@foodPlanIds"
                                           ShowAddButton="true"
                                           ShowEditButton="true"
                                           ShowDeleteButton="true"
                                           OnAddRequested="@PrepareForAddFoodPlan"
                                           OnEditRequested="@PrepareForEditFoodPlan"
                                           OnDeleteRequested="@HandleFoodPlanRowDeleted"
                                           OnSaveRequested="@SaveFoodPlanChanges"
                                           IsValidForm="@ValidateFoodPlanForm"
                                           EmptyMessage="No hay planes de alimentación registrados">
                                <EditModalContent>
                                    <div class="row g-3">
                                        <div class="col-md-12">
                                            <label class="form-label">Alimento *</label>
                                            <select class="form-select" @bind="editingFoodPlan.FoodId">
                                                <option value="0">Seleccione un alimento</option>
                                                @foreach (var food in foods)
                                                {
                                                    <option value="@food.FoodId">@food.Name</option>
                                                }
                                            </select>
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Descripción</label>
                                            <textarea class="form-control"
                                                      @bind="editingFoodPlan.Description"
                                                      rows="3"
                                                      style="resize: vertical; min-height: 80px;"
                                                      placeholder="Descripción del alimento..."></textarea>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Fecha de Registro</label>
                                            <input type="date"
                                                   class="form-control"
                                                   @bind="editingFoodPlan.RegistrationDate"
                                                   @bind:format="yyyy-MM-dd" />
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Cantidad</label>
                                            <input type="number"
                                                   class="form-control"
                                                   @bind="editingFoodPlan.Quantity"
                                                   placeholder="Ej: 2" />
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Frecuencia</label>
                                            <input type="text"
                                                   class="form-control"
                                                   @bind="editingFoodPlan.Frequency"
                                                   placeholder="Ej: Diaria, Semanal" />
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Indicaciones</label>
                                            <textarea class="form-control"
                                                      @bind="editingFoodPlan.Indications"
                                                      rows="3"
                                                      style="resize: vertical; min-height: 80px;"
                                                      placeholder="Indicaciones específicas..."></textarea>
                                        </div>
                                    </div>
                                </EditModalContent>
                            </EditableTable>
                        </div>

                        <!-- Tabla: Alimentos Restringidos -->
                        <div class="mt-5">
                            <EditableTable Title="Alimentos Restringidos"
                                           ColumnHeaders="@forbiddenFoodHeaders"
                                           Rows="@forbiddenFoodRows"
                                           RowIds="@forbiddenFoodIds"
                                           ShowAddButton="true"
                                           ShowEditButton="true"
                                           ShowDeleteButton="true"
                                           OnAddRequested="@PrepareForAddForbiddenFood"
                                           OnEditRequested="@PrepareForEditForbiddenFood"
                                           OnDeleteRequested="@HandleForbiddenFoodRowDeleted"
                                           OnSaveRequested="@SaveForbiddenFoodChanges"
                                           IsValidForm="@ValidateForbiddenFoodForm"
                                           EmptyMessage="No hay alimentos restringidos registrados">
                                <EditModalContent>
                                    <div class="row g-3">
                                        <div class="col-md-12">
                                            <label class="form-label">Alimento *</label>
                                            <select class="form-select" @bind="editingForbiddenFood.FoodId">
                                                <option value="0">Seleccione un alimento</option>
                                                @foreach (var food in foods)
                                                {
                                                    <option value="@food.FoodId">@food.Name</option>
                                                }
                                            </select>
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Descripción</label>
                                            <textarea class="form-control"
                                                      @bind="editingForbiddenFood.Description"
                                                      rows="3"
                                                      style="resize: vertical; min-height: 80px;"
                                                      placeholder="Descripción del alimento restringido..."></textarea>
                                        </div>
                                        <div class="col-md-12">
                                            <label class="form-label">Fecha de Registro</label>
                                            <input type="date"
                                                   class="form-control"
                                                   @bind="editingForbiddenFood.RegistrationDate"
                                                   @bind:format="yyyy-MM-dd" />
                                        </div>
                                    </div>
                                </EditModalContent>
                            </EditableTable>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-secondary" @onclick="@(() => SetActiveTab("diametros"))">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </button>
                            <button class="btn btn-primary" @onclick="@(() => SetActiveTab("referral"))">
                                Continuar a Derivación <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Debe guardar primero los datos básicos del paciente para acceder a esta sección.
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Pestaña: Derivación -->
        <div class="tab-pane @(activeTab == "referral" ? "show active" : "")" role="tabpanel">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-share me-2"></i>Derivación
                        <span class="badge bg-info ms-2">Opcional</span>
                    </h5>
                    <small class="text-muted">Derivación a módulos y especialidades</small>
                </div>
                <div class="card-body">
                    @if (currentMedicalCareId > 0)
                    {
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Información:</strong> Puede registrar múltiples derivaciones para esta atención de nutrición.
                        </div>

                        <EditableTable Title="Derivaciones"
                                       ColumnHeaders="@referralHeaders"
                                       Rows="@referralRows"
                                       RowIds="@referralIds"
                                       EmptyMessage="No se han registrado derivaciones"
                                       DeleteConfirmationMessage="¿Está seguro que desea eliminar esta derivación?"
                                       ShowAddButton="true"
                                       ShowEditButton="true"
                                       ShowDeleteButton="true"
                                       ShowActions="true"
                                       OnAddRequested="@OnAddReferralRequested"
                                       OnEditRequested="@OnEditReferralRequested"
                                       OnDeleteRequested="@OnDeleteReferralRequested"
                                       OnSaveRequested="@OnSaveReferralRequested"
                                       IsValidForm="@IsReferralFormValid">
                            <EditModalContent>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Módulo/Especialidad de Destino <span class="text-danger">*</span></label>
                                        <select class="form-select @(referralErrors.ContainsKey("LocationId") ? "is-invalid" : "")"
                                                @bind="selectedLocationDId">
                                            <option value="0">Seleccione un módulo o especialidad</option>
                                            @foreach (var location in availableLocationsForReferral)
                                            {
                                                <option value="@location.Id">@location.Name</option>
                                            }
                                        </select>
                                        @if (referralErrors.ContainsKey("LocationId"))
                                        {
                                            <div class="invalid-feedback">@referralErrors["LocationId"]</div>
                                        }
                                    </div>

                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Fecha de Derivación <span class="text-danger">*</span></label>
                                        <input type="datetime-local"
                                               class="form-control @(referralErrors.ContainsKey("DateOfReferral") ? "is-invalid" : "")"
                                               @bind="currentReferral.DateOfReferral"
                                               @bind:format="yyyy-MM-ddTHH:mm" />
                                        @if (referralErrors.ContainsKey("DateOfReferral"))
                                        {
                                            <div class="invalid-feedback">@referralErrors["DateOfReferral"]</div>
                                        }
                                    </div>

                                    <div class="col-12">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox"
                                                   @bind="currentReferral.IsUrgent" />
                                            <label class="form-check-label fw-bold">Derivación Urgente</label>
                                        </div>
                                        <small class="form-text text-muted">
                                            Marque esta opción si la derivación requiere atención prioritaria.
                                        </small>
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label fw-bold">Motivo de Derivación <span class="text-danger">*</span></label>
                                        <textarea class="form-control @(referralErrors.ContainsKey("Description") ? "is-invalid" : "")"
                                                  @bind="currentReferral.Description"
                                                  rows="4"
                                                  maxlength="1000"
                                                  placeholder="Describa detalladamente el motivo de la derivación, síntomas relevantes, tratamientos previos, etc..."
                                                  style="resize: vertical; min-height: 120px;"></textarea>
                                        @if (referralErrors.ContainsKey("Description"))
                                        {
                                            <div class="invalid-feedback">@referralErrors["Description"]</div>
                                        }
                                        <small class="form-text text-muted">
                                            Máximo 1000 caracteres. Restantes: @(1000 - (currentReferral.Description?.Length ?? 0))
                                        </small>
                                    </div>

                                    <div class="col-12">
                                        <label class="form-label fw-bold">Notas Adicionales</label>
                                        <textarea class="form-control @(referralErrors.ContainsKey("AdditionalNotes") ? "is-invalid" : "")"
                                                  @bind="currentReferral.AdditionalNotes"
                                                  rows="3"
                                                  maxlength="500"
                                                  placeholder="Observaciones adicionales, recomendaciones, etc..."
                                                  style="resize: vertical; min-height: 100px;"></textarea>
                                        @if (referralErrors.ContainsKey("AdditionalNotes"))
                                        {
                                            <div class="invalid-feedback">@referralErrors["AdditionalNotes"]</div>
                                        }
                                        <small class="form-text text-muted">
                                            Máximo 500 caracteres. Restantes: @(500 - (currentReferral.AdditionalNotes?.Length ?? 0))
                                        </small>
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(referralFormError))
                                {
                                    <div class="alert alert-danger mt-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        @referralFormError
                                    </div>
                                }
                            </EditModalContent>
                        </EditableTable>

                        <div class="d-flex justify-content-between mt-4">
                            <button class="btn btn-secondary" @onclick="@(() => SetActiveTab("plan"))">
                                <i class="fas fa-arrow-left me-2"></i>Volver
                            </button>
                            <div>
                                @if (hasUnsavedReferralData)
                                {
                                    <div class="alert alert-warning d-inline-block me-2 mb-0 py-1 px-2">
                                        <small><i class="fas fa-exclamation-triangle me-1"></i>Hay cambios sin guardar</small>
                                    </div>
                                }
                                <button class="btn btn-success" @onclick="FinalizarAtencionNutricion" disabled="@isSaving">
                                    @if (isSaving)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    <i class="fas fa-check me-2"></i>Finalizar Atención
                                </button>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Debe guardar primero los datos básicos del paciente para acceder a esta sección.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public MedicalCareDTO MedicalCare { get; set; } = new();
    [Parameter] public EventCallback<MedicalCareDTO> OnSaved { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }


    // Variables para pestañas
    private string activeTab = "patient";

    // Variables existentes para la pestaña de paciente
    private int clinicalHistoryId;
    private int selectedPatientId;
    private string selectedHistoryNumber = string.Empty;
    private List<PlaceOfAttentionDTO> lugaresAtencion = new();
    private string lugarSeleccionada = string.Empty;
    private string motivoConsulta = string.Empty;
    private List<HealthProfessionalDTO> nutricionistas = new();
    private HealthProfessionalDTO? profesionalLogueado;
    private int selectedHealthProfessionalId;
    private int nutritionLocationId;
    private bool isEditMode = false;
    private bool isSaving = false;
    private bool showValidationErrors = false;
    private bool profesionalCargado = false;
    private int currentMedicalCareId = 0;
    private ReasonForConsultationDTO? existingReasonForConsultation;

    // Variables para Pliegues
    private SkinFoldsDTO skinFoldsData = new SkinFoldsDTO();
    private int? currentMeasurementsId;
    private bool skinFoldsLoaded = false;

    // Variables para Bioimpedancia
    private BioImpedanceDTO bioImpedanceData = new BioImpedanceDTO();
    private bool bioImpedanceLoaded = false;

    // Variables para Perímetros
    private PerimetersDTO perimetersData = new PerimetersDTO();
    private bool perimetersLoaded = false;

    // Variables para Diámetros
    private DiametersDTO diametersData = new DiametersDTO();
    private bool diametersLoaded = false;

    // Variables para Plan Alimentación
    private List<FoodDTO> foods = new();
    private bool foodsLoaded = false;

    // Variables para FoodPlan
    private List<string> foodPlanHeaders = new() { "Alimento", "Descripción", "Fecha Registro", "Cantidad", "Frecuencia", "Indicaciones" };
    private List<List<string>> foodPlanRows = new();
    private List<int> foodPlanIds = new();
    private List<FoodPlanDTO> currentFoodPlans = new();
    private FoodPlanDTO editingFoodPlan = new FoodPlanDTO();

    // Variables para ForbiddenFood
    private List<string> forbiddenFoodHeaders = new() { "Alimento", "Descripción", "Fecha Registro" };
    private List<List<string>> forbiddenFoodRows = new();
    private List<int> forbiddenFoodIds = new();
    private List<ForbiddenFoodDTO> currentForbiddenFoods = new();
    private ForbiddenFoodDTO editingForbiddenFood = new ForbiddenFoodDTO();

    // Variables para Derivación
    private List<LocationDTO> availableLocationsForReferral = new();
    private List<MedicalReferralDTO> referralsList = new();
    private MedicalReferralDTO currentReferral = new();
    private List<string> referralHeaders = new() { "Módulo/Especialidad", "Fecha", "Motivo", "Urgente", "Estado" };
    private List<List<string>> referralRows = new();
    private List<int> referralIds = new();
    private Dictionary<string, string> referralErrors = new();
    private string referralFormError = "";
    private int? selectedLocationDId = null;
    private bool hasUnsavedReferralData = false;

    // Variables para medidas anteriores
    private List<MedicalCareDTO> patientMedicalHistory = new();
    private Dictionary<int, MeasurementsDTO> previousMeasurementsCache = new();
    private bool isLoadingPreviousMeasurements = false;

    private async Task LoadPatientMedicalHistory()
    {
        if (currentMedicalCareId <= 0 || selectedPatientId <= 0)
        {
            await JS.InvokeVoidAsync("console.log",
                "No se puede cargar historial: CareId o PatientId no válidos");
            return;
        }

        try
        {
            isLoadingPreviousMeasurements = true;
            StateHasChanged();

            // Limpiar datos anteriores
            patientMedicalHistory = new List<MedicalCareDTO>();
            previousMeasurementsCache = new Dictionary<int, MeasurementsDTO>();

            await JS.InvokeVoidAsync("console.log",
                $"Iniciando carga de historial: Paciente={selectedPatientId}, Atención actual={currentMedicalCareId}");

            // Obtener historial de atenciones anteriores de nutrición
            var history = await MedicalCareService.GetPatientMedicalHistoryAsync(
                selectedPatientId, currentMedicalCareId);

            if (history != null && history.Any())
            {
                // Ordenar por fecha de atención descendente (la más reciente primero)
                patientMedicalHistory = history
                    .OrderByDescending(h => h.CareDate)
                    .ToList();

                await JS.InvokeVoidAsync("console.log",
                    $"Se encontraron {patientMedicalHistory.Count} atenciones anteriores");

                // Procesar cada atención para extraer measurements
                foreach (var care in patientMedicalHistory)
                {
                    try
                    {
                        // Intentar obtener measurements directamente del DTO
                        if (care.Measurements != null)
                        {
                            previousMeasurementsCache[care.CareId] = care.Measurements;
                            await JS.InvokeVoidAsync("console.log",
                                $"✓ Measurements cargados para atención {care.CareId} ({care.CareDate:dd/MM/yyyy})");
                        }
                        else
                        {
                            await JS.InvokeVoidAsync("console.log",
                                $"✗ Atención {care.CareId} no tiene measurements");
                        }
                    }
                    catch (Exception ex)
                    {
                        await JS.InvokeVoidAsync("console.error",
                            $"Error procesando atención {care.CareId}: {ex.Message}");
                    }
                }
            }
            else
            {
                await JS.InvokeVoidAsync("console.log", "No se encontraron atenciones anteriores");
            }

            await DebugMeasurementsData(); // Mostrar datos para depuración
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error cargando historial: {ex.Message}");
        }
        finally
        {
            isLoadingPreviousMeasurements = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task DebugMeasurementsData()
    {
        await JS.InvokeVoidAsync("console.log", "=== DEBUG: Historial de Medidas ===");
        await JS.InvokeVoidAsync("console.log", $"Total atenciones: {patientMedicalHistory.Count}");

        foreach (var care in patientMedicalHistory)
        {
            await JS.InvokeVoidAsync("console.log",
                $"\nAtención ID: {care.CareId}, Fecha: {care.CareDate:dd/MM/yyyy}");

            if (previousMeasurementsCache.ContainsKey(care.CareId))
            {
                var measurements = previousMeasurementsCache[care.CareId];
                await JS.InvokeVoidAsync("console.log", $"  Measurements ID: {measurements.MeasurementsId}");

                // Verificar pliegues
                if (measurements.SkinFolds != null)
                {
                    var skinFolds = measurements.SkinFolds;
                    await JS.InvokeVoidAsync("console.log", $"  Pliegues disponibles:");
                    if (!string.IsNullOrEmpty(skinFolds.Subscapular))
                        await JS.InvokeVoidAsync("console.log", $"    - Subescapular: {skinFolds.Subscapular}");
                    if (!string.IsNullOrEmpty(skinFolds.Triceps))
                        await JS.InvokeVoidAsync("console.log", $"    - Tríceps: {skinFolds.Triceps}");
                }
                else
                {
                    await JS.InvokeVoidAsync("console.log", $"  No hay pliegues");
                }
            }
            else
            {
                await JS.InvokeVoidAsync("console.log", $"  Sin measurements en cache");
            }
        }
    }

    // Método para obtener medidas anteriores de pliegues
    private List<PreviousMeasurementDTO> GetPreviousSkinFolds(string foldType)
    {
        var previousList = new List<PreviousMeasurementDTO>();

        foreach (var kvp in previousMeasurementsCache)
        {
            var care = patientMedicalHistory.FirstOrDefault(c => c.CareId == kvp.Key);
            if (care == null) continue;

            var measurements = kvp.Value;
            var skinFolds = measurements.SkinFolds;
            if (skinFolds == null) continue;

            string? value = foldType switch
            {
                "Subescapular" => skinFolds.Subscapular,
                "Tríceps" => skinFolds.Triceps,
                "Bíceps" => skinFolds.Biceps,
                "Cresta Ilíaca" => skinFolds.IliacCrest,
                "Supraespinal" => skinFolds.Supraespinal,
                "Abdominal" => skinFolds.Abdominal,
                "Muslo Frontal" => skinFolds.FrontalThigh,
                "Pantorrilla Medial" => skinFolds.MedialCalf,
                "Axilar Medial" => skinFolds.MedialAxillary,
                "Pectoral" => skinFolds.Pectoral,
                _ => null
            };

            if (!string.IsNullOrWhiteSpace(value))
            {
                previousList.Add(new PreviousMeasurementDTO
                    {
                        Value = value,
                        MeasurementDate = care.CareDate,
                        MedicalCareId = care.CareId,
                        Area = care.Area ?? "Nutrición"
                    });
            }
        }

        // Ordenar por fecha descendente para que la más reciente aparezca primero
        return previousList.OrderByDescending(p => p.MeasurementDate).ToList();
    }

    // Hacer lo mismo para los otros métodos:
    private List<PreviousMeasurementDTO> GetPreviousBioImpedance(string type)
    {
        var previousList = new List<PreviousMeasurementDTO>();

        foreach (var kvp in previousMeasurementsCache)
        {
            var care = patientMedicalHistory.FirstOrDefault(c => c.CareId == kvp.Key);
            if (care == null) continue;

            var measurements = kvp.Value;
            var bioImpedance = measurements.BioImpedance;
            if (bioImpedance == null) continue;

            string? value = type switch
            {
                "BodyFatPercentage" => bioImpedance.BodyFatPercentage,
                "UpperSectionFatPercentage" => bioImpedance.UpperSectionFatPercentage,
                "LowerSectionFatPercentage" => bioImpedance.LowerSectionFatPercentage,
                "VisceralFat" => bioImpedance.VisceralFat,
                "MuscleMass" => bioImpedance.MuscleMass,
                "BoneWeight" => bioImpedance.BoneWeight,
                "BodyWater" => bioImpedance.BodyWater,
                _ => null
            };

            if (!string.IsNullOrWhiteSpace(value))
            {
                previousList.Add(new PreviousMeasurementDTO
                    {
                        Value = value,
                        MeasurementDate = care.CareDate,
                        MedicalCareId = care.CareId,
                        Area = care.Area ?? "Nutrición"
                    });
            }
        }

        return previousList.OrderByDescending(p => p.MeasurementDate).ToList();
    }

    private List<PreviousMeasurementDTO> GetPreviousPerimeters(string type)
    {
        var previousList = new List<PreviousMeasurementDTO>();

        foreach (var kvp in previousMeasurementsCache)
        {
            var care = patientMedicalHistory.FirstOrDefault(c => c.CareId == kvp.Key);
            if (care == null) continue;

            var measurements = kvp.Value;
            var perimeters = measurements.Perimeters;
            if (perimeters == null) continue;

            string? value = type switch
            {
                "Cefálico" => perimeters.Cephalic,
                "Cuello" => perimeters.Neck,
                "Mitad Brazo Relajado" => perimeters.RelaxedArmHalf,
                "Antebrazo" => perimeters.Forearm,
                "Muñeca" => perimeters.Wrist,
                _ => null
            };

            if (!string.IsNullOrWhiteSpace(value))
            {
                previousList.Add(new PreviousMeasurementDTO
                    {
                        Value = value,
                        MeasurementDate = care.CareDate,
                        MedicalCareId = care.CareId,
                        Area = care.Area ?? "Nutrición"
                    });
            }
        }

        return previousList.OrderByDescending(p => p.MeasurementDate).ToList();
    }

    private List<PreviousMeasurementDTO> GetPreviousDiameters(string type)
    {
        var previousList = new List<PreviousMeasurementDTO>();

        foreach (var kvp in previousMeasurementsCache)
        {
            var care = patientMedicalHistory.FirstOrDefault(c => c.CareId == kvp.Key);
            if (care == null) continue;

            var measurements = kvp.Value;
            var diameters = measurements.Diameters;
            if (diameters == null) continue;

            string? value = type switch
            {
                "Húmero" => diameters.Humerus,
                "Fémur" => diameters.Femur,
                "Muñeca" => diameters.Wrist,
                _ => null
            };

            if (!string.IsNullOrWhiteSpace(value))
            {
                previousList.Add(new PreviousMeasurementDTO
                    {
                        Value = value,
                        MeasurementDate = care.CareDate,
                        MedicalCareId = care.CareId,
                        Area = care.Area ?? "Nutrición"
                    });
            }
        }

        return previousList.OrderByDescending(p => p.MeasurementDate).ToList();
    }


    protected override async Task OnInitializedAsync()
    {
        await LoadLocationsAndPlaces();
        await LoadHealthProfessionals();
        await ObtenerProfesionalLogueado();
        await LoadReferralData();

        if (MedicalCare != null && MedicalCare.CareId > 0)
        {
            isEditMode = true;
            currentMedicalCareId = MedicalCare.CareId;
            selectedPatientId = MedicalCare.PatientId;
            await LoadExistingData();
        }
        else
        {
            await AsignarProfesionalLogueado();
        }
    }

    // ========== MÉTODOS PARA PESTAÑAS ==========

    private async Task SetActiveTab(string tab)
    {
        if (tab != "patient" && !IsPatientTabComplete())
        {
            showValidationErrors = true;
            await JS.InvokeVoidAsync("alert",
                "Debe completar toda la información obligatoria en la pestaña de Selección de Paciente antes de continuar.");
            return;
        }

        if (tab != "patient" && currentMedicalCareId == 0)
        {
            await JS.InvokeVoidAsync("alert",
                "Debe guardar primero los datos básicos del paciente antes de continuar.");
            return;
        }

        // Cargar historial del paciente cuando se accede a pestañas de mediciones
        if ((tab == "pliegues" || tab == "bioimpedancia" || tab == "perimetros" || tab == "diametros")
            && currentMedicalCareId > 0 && selectedPatientId > 0)
        {
            await JS.InvokeVoidAsync("console.log",
                $"Activando pestaña {tab}, cargando historial...");
            await LoadPatientMedicalHistory();

            // Esperar un momento para que se actualice la UI
            await Task.Delay(300);
        }

        // Cargar datos específicos de la pestaña
        if (tab == "pliegues" && currentMedicalCareId > 0)
        {
            await LoadSkinFoldsData();
        }
        else if (tab == "bioimpedancia" && currentMedicalCareId > 0)
        {
            await LoadBioImpedanceData();
        }
        else if (tab == "perimetros" && currentMedicalCareId > 0)
        {
            await LoadPerimetersData();
        }
        else if (tab == "diametros" && currentMedicalCareId > 0)
        {
            await LoadDiametersData();
        }
        else if (tab == "plan" && currentMedicalCareId > 0)
        {
            await LoadFoodsData();
            await LoadFoodPlansData();
            await LoadForbiddenFoodsData();
        }
        else if (tab == "referral" && currentMedicalCareId > 0)
        {
            await LoadReferralData();
        }

        activeTab = tab;
        StateHasChanged();
    }


    private bool IsPatientTabComplete()
    {
        return selectedPatientId > 0 &&
               !string.IsNullOrEmpty(lugarSeleccionada) &&
               !string.IsNullOrWhiteSpace(motivoConsulta) &&
               selectedHealthProfessionalId > 0 &&
               nutritionLocationId > 0;
    }



    private async Task FinalizarAtencionNutricion()
    {
        isSaving = true;
        try
        {
            if (currentMedicalCareId == 0)
            {
                await JS.InvokeVoidAsync("alert", "No hay una atención de nutrición válida para finalizar.");
                return;
            }

            // Aquí iría la lógica para guardar todos los datos de las pestañas
            await GuardarDatosNutricionales();

            await OnSaved.InvokeAsync(MedicalCare ?? new MedicalCareDTO { CareId = currentMedicalCareId });
            await JS.InvokeVoidAsync("alert", "Atención de nutrición finalizada exitosamente.");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error inesperado: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task GuardarDatosNutricionales()
    {
        // TODO: Implementar la lógica para guardar todos los datos nutricionales
        // en sus respectivos servicios cuando los creemos
        await Task.CompletedTask;
    }

    // Método para verificar si la pestaña de Pliegues está completa
    private bool IsPlieguesComplete()
    {
        return !string.IsNullOrWhiteSpace(skinFoldsData.Subscapular) ||
               !string.IsNullOrWhiteSpace(skinFoldsData.Triceps) ||
               !string.IsNullOrWhiteSpace(skinFoldsData.Biceps) ||
               !string.IsNullOrWhiteSpace(skinFoldsData.IliacCrest) ||
               !string.IsNullOrWhiteSpace(skinFoldsData.Supraespinal) ||
               !string.IsNullOrWhiteSpace(skinFoldsData.Abdominal) ||
               !string.IsNullOrWhiteSpace(skinFoldsData.FrontalThigh) ||
               !string.IsNullOrWhiteSpace(skinFoldsData.MedialCalf) ||
               !string.IsNullOrWhiteSpace(skinFoldsData.MedialAxillary) ||
               !string.IsNullOrWhiteSpace(skinFoldsData.Pectoral);
    }

    // Método para guardar automáticamente los pliegues
    private async Task AutoSaveSkinFolds()
    {
        if (currentMedicalCareId <= 0 || currentMeasurementsId == null)
            return;

        try
        {
            // Asegurarnos de que el MeasurementsId esté asignado
            skinFoldsData.MeasurementsId = currentMeasurementsId.Value;

            var result = await SkinFoldsService.SaveOrUpdateAsync(skinFoldsData);
            if (result.Success)
            {
                if (result.Data != null)
                {
                    skinFoldsData.SkinFoldsId = result.Data.SkinFoldsId;
                }
                await JS.InvokeVoidAsync("console.log", "Pliegues cutáneos guardados automáticamente");
            }
            else
            {
                await JS.InvokeVoidAsync("console.error", $"Error guardando pliegues: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error en AutoSaveSkinFolds: {ex.Message}");
        }
    }

    // Método para cargar los datos existentes de SkinFolds
    private async Task LoadSkinFoldsData()
    {
        if (currentMeasurementsId == null)
            return;

        try
        {
            var existingSkinFolds = await SkinFoldsService.GetByMeasurementsIdAsync(currentMeasurementsId.Value);
            if (existingSkinFolds != null)
            {
                skinFoldsData = existingSkinFolds;
                await JS.InvokeVoidAsync("console.log", "Datos de pliegues existentes cargados");
            }
            else
            {
                // Inicializar nuevo objeto si no existe
                skinFoldsData = new SkinFoldsDTO { MeasurementsId = currentMeasurementsId.Value };
                await JS.InvokeVoidAsync("console.log", "Nuevo objeto de pliegues inicializado");
            }

            skinFoldsLoaded = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error cargando datos de pliegues: {ex.Message}");
            skinFoldsData = new SkinFoldsDTO { MeasurementsId = currentMeasurementsId.Value };
            skinFoldsLoaded = true;
        }
    }

    // MÉTODO CORREGIDO - sin MeasurementDate
    private async Task<int?> GetOrCreateMeasurementsId()
    {
        try
        {
            // Buscar si ya existe un Measurements para este MedicalCare
            var existingMeasurements = await MeasurementsService.GetByMedicalCareIdAsync(currentMedicalCareId);
            if (existingMeasurements != null)
            {
                await JS.InvokeVoidAsync("console.log", $"Measurements existente encontrado: {existingMeasurements.MeasurementsId}");
                return existingMeasurements.MeasurementsId;
            }

            // Crear nuevo Measurements si no existe
            var newMeasurements = new MeasurementsDTO
            {
                MedicalCareId = currentMedicalCareId
                // No incluir MeasurementDate ya que no existe en el DTO
            };

            // Usamos el nuevo método con patrón de retorno consistente
            var result = await MeasurementsService.CreateAsync(newMeasurements);
            if (result.Success && result.Data != null)
            {
                await JS.InvokeVoidAsync("console.log", $"Nuevo Measurements creado: {result.Data.MeasurementsId}");
                return result.Data.MeasurementsId;
            }
            else
            {
                await JS.InvokeVoidAsync("console.error", $"Error creando Measurements: {result.Error}");

                // Fallback: intentar con el método legacy
                var legacyResult = await MeasurementsService.CreateMeasurementAsync(newMeasurements);
                if (legacyResult != null)
                {
                    await JS.InvokeVoidAsync("console.log", $"Measurements creado con método legacy: {legacyResult.MeasurementsId}");
                    return legacyResult.MeasurementsId;
                }
            }

            return null;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error obteniendo/creando Measurements: {ex.Message}");
            return null;
        }
    }


    // Método para verificar si la pestaña de Bioimpedancia está completa
    private bool IsBioimpedanciaComplete()
    {
        return !string.IsNullOrWhiteSpace(bioImpedanceData.BodyFatPercentage) ||
               !string.IsNullOrWhiteSpace(bioImpedanceData.UpperSectionFatPercentage) ||
               !string.IsNullOrWhiteSpace(bioImpedanceData.LowerSectionFatPercentage) ||
               !string.IsNullOrWhiteSpace(bioImpedanceData.VisceralFat) ||
               !string.IsNullOrWhiteSpace(bioImpedanceData.MuscleMass) ||
               !string.IsNullOrWhiteSpace(bioImpedanceData.BoneWeight) ||
               !string.IsNullOrWhiteSpace(bioImpedanceData.BodyWater);
    }

    // Método para guardar automáticamente la bioimpedancia
    private async Task AutoSaveBioImpedance()
    {
        if (currentMedicalCareId <= 0 || currentMeasurementsId == null)
            return;

        try
        {
            // Procesar campos de porcentaje - agregar % si es necesario
            ProcessPercentageFields();

            // Asegurarnos de que el MeasurementsId esté asignado
            bioImpedanceData.MeasurementsId = currentMeasurementsId.Value;

            var result = await BioImpedanceService.SaveOrUpdateAsync(bioImpedanceData);
            if (result.Success)
            {
                if (result.Data != null)
                {
                    bioImpedanceData.BioImpedanceId = result.Data.BioImpedanceId;
                }
                await JS.InvokeVoidAsync("console.log", "Bioimpedancia guardada automáticamente");
            }
            else
            {
                await JS.InvokeVoidAsync("console.error", $"Error guardando bioimpedancia: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error en AutoSaveBioImpedance: {ex.Message}");
        }
    }

    // Método para procesar campos de porcentaje
    private void ProcessPercentageFields()
    {
        // Procesar BodyFatPercentage
        if (!string.IsNullOrWhiteSpace(bioImpedanceData.BodyFatPercentage) &&
            !bioImpedanceData.BodyFatPercentage.EndsWith("%"))
        {
            bioImpedanceData.BodyFatPercentage = $"{bioImpedanceData.BodyFatPercentage.Trim()}%";
        }

        // Procesar UpperSectionFatPercentage
        if (!string.IsNullOrWhiteSpace(bioImpedanceData.UpperSectionFatPercentage) &&
            !bioImpedanceData.UpperSectionFatPercentage.EndsWith("%"))
        {
            bioImpedanceData.UpperSectionFatPercentage = $"{bioImpedanceData.UpperSectionFatPercentage.Trim()}%";
        }

        // Procesar LowerSectionFatPercentage
        if (!string.IsNullOrWhiteSpace(bioImpedanceData.LowerSectionFatPercentage) &&
            !bioImpedanceData.LowerSectionFatPercentage.EndsWith("%"))
        {
            bioImpedanceData.LowerSectionFatPercentage = $"{bioImpedanceData.LowerSectionFatPercentage.Trim()}%";
        }
    }

    // Método para cargar los datos existentes de Bioimpedancia
    private async Task LoadBioImpedanceData()
    {
        if (currentMeasurementsId == null)
            return;

        try
        {
            var existingBioImpedance = await BioImpedanceService.GetByMeasurementsIdAsync(currentMeasurementsId.Value);
            if (existingBioImpedance != null)
            {
                bioImpedanceData = existingBioImpedance;
                await JS.InvokeVoidAsync("console.log", "Datos de bioimpedancia existentes cargados");
            }
            else
            {
                // Inicializar nuevo objeto si no existe
                bioImpedanceData = new BioImpedanceDTO { MeasurementsId = currentMeasurementsId.Value };
                await JS.InvokeVoidAsync("console.log", "Nuevo objeto de bioimpedancia inicializado");
            }

            bioImpedanceLoaded = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error cargando datos de bioimpedancia: {ex.Message}");
            bioImpedanceData = new BioImpedanceDTO { MeasurementsId = currentMeasurementsId.Value };
            bioImpedanceLoaded = true;
        }
    }


    // Método para verificar si la pestaña de Perímetros está completa
    private bool IsPerimetrosComplete()
    {
        return !string.IsNullOrWhiteSpace(perimetersData.Cephalic) ||
               !string.IsNullOrWhiteSpace(perimetersData.Neck) ||
               !string.IsNullOrWhiteSpace(perimetersData.RelaxedArmHalf) ||
               !string.IsNullOrWhiteSpace(perimetersData.Forearm) ||
               !string.IsNullOrWhiteSpace(perimetersData.Wrist);
    }

    // Método para guardar automáticamente los perímetros
    private async Task AutoSavePerimeters()
    {
        if (currentMedicalCareId <= 0 || currentMeasurementsId == null)
            return;

        try
        {
            // Procesar campos - agregar "cm" si es necesario
            ProcessPerimeterFields();

            // Asegurarnos de que el MeasurementsId esté asignado
            perimetersData.MeasurementsId = currentMeasurementsId.Value;

            var result = await PerimetersService.SaveOrUpdateAsync(perimetersData);
            if (result.Success)
            {
                if (result.Data != null)
                {
                    perimetersData.PerimetersId = result.Data.PerimetersId;
                }
                await JS.InvokeVoidAsync("console.log", "Perímetros guardados automáticamente");
            }
            else
            {
                await JS.InvokeVoidAsync("console.error", $"Error guardando perímetros: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error en AutoSavePerimeters: {ex.Message}");
        }
    }

    // Método para procesar campos de perímetros
    private void ProcessPerimeterFields()
    {
        // Procesar Cephalic
        if (!string.IsNullOrWhiteSpace(perimetersData.Cephalic) &&
            !perimetersData.Cephalic.EndsWith("cm"))
        {
            perimetersData.Cephalic = $"{perimetersData.Cephalic.Trim()} cm";
        }

        // Procesar Neck
        if (!string.IsNullOrWhiteSpace(perimetersData.Neck) &&
            !perimetersData.Neck.EndsWith("cm"))
        {
            perimetersData.Neck = $"{perimetersData.Neck.Trim()} cm";
        }

        // Procesar RelaxedArmHalf
        if (!string.IsNullOrWhiteSpace(perimetersData.RelaxedArmHalf) &&
            !perimetersData.RelaxedArmHalf.EndsWith("cm"))
        {
            perimetersData.RelaxedArmHalf = $"{perimetersData.RelaxedArmHalf.Trim()} cm";
        }

        // Procesar Forearm
        if (!string.IsNullOrWhiteSpace(perimetersData.Forearm) &&
            !perimetersData.Forearm.EndsWith("cm"))
        {
            perimetersData.Forearm = $"{perimetersData.Forearm.Trim()} cm";
        }

        // Procesar Wrist
        if (!string.IsNullOrWhiteSpace(perimetersData.Wrist) &&
            !perimetersData.Wrist.EndsWith("cm"))
        {
            perimetersData.Wrist = $"{perimetersData.Wrist.Trim()} cm";
        }
    }

    // Método para cargar los datos existentes de Perímetros
    private async Task LoadPerimetersData()
    {
        if (currentMeasurementsId == null)
            return;

        try
        {
            var existingPerimeters = await PerimetersService.GetByMeasurementsIdAsync(currentMeasurementsId.Value);
            if (existingPerimeters != null)
            {
                perimetersData = existingPerimeters;
                await JS.InvokeVoidAsync("console.log", "Datos de perímetros existentes cargados");
            }
            else
            {
                // Inicializar nuevo objeto si no existe
                perimetersData = new PerimetersDTO { MeasurementsId = currentMeasurementsId.Value };
                await JS.InvokeVoidAsync("console.log", "Nuevo objeto de perímetros inicializado");
            }

            perimetersLoaded = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error cargando datos de perímetros: {ex.Message}");
            perimetersData = new PerimetersDTO { MeasurementsId = currentMeasurementsId.Value };
            perimetersLoaded = true;
        }
    }

    // Método para verificar si la pestaña de Diámetros está completa
    private bool IsDiametrosComplete()
    {
        return !string.IsNullOrWhiteSpace(diametersData.Humerus) ||
               !string.IsNullOrWhiteSpace(diametersData.Femur) ||
               !string.IsNullOrWhiteSpace(diametersData.Wrist);
    }


    // Método para guardar automáticamente los diámetros
    private async Task AutoSaveDiameters()
    {
        if (currentMedicalCareId <= 0 || currentMeasurementsId == null)
            return;

        try
        {
            // Procesar campos - agregar "cm" si es necesario
            ProcessDiameterFields();

            // Asegurarnos de que el MeasurementsId esté asignado
            diametersData.MeasurementsId = currentMeasurementsId.Value;

            var result = await DiametersService.SaveOrUpdateAsync(diametersData);
            if (result.Success)
            {
                if (result.Data != null)
                {
                    diametersData.DiametersId = result.Data.DiametersId;
                }
                await JS.InvokeVoidAsync("console.log", "Diámetros guardados automáticamente");
            }
            else
            {
                await JS.InvokeVoidAsync("console.error", $"Error guardando diámetros: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error en AutoSaveDiameters: {ex.Message}");
        }
    }

    // Método para procesar campos de diámetros
    private void ProcessDiameterFields()
    {
        // Procesar Humerus
        if (!string.IsNullOrWhiteSpace(diametersData.Humerus) &&
            !diametersData.Humerus.EndsWith("cm"))
        {
            diametersData.Humerus = $"{diametersData.Humerus.Trim()} cm";
        }

        // Procesar Femur
        if (!string.IsNullOrWhiteSpace(diametersData.Femur) &&
            !diametersData.Femur.EndsWith("cm"))
        {
            diametersData.Femur = $"{diametersData.Femur.Trim()} cm";
        }

        // Procesar Wrist
        if (!string.IsNullOrWhiteSpace(diametersData.Wrist) &&
            !diametersData.Wrist.EndsWith("cm"))
        {
            diametersData.Wrist = $"{diametersData.Wrist.Trim()} cm";
        }
    }

    // Método para cargar los datos existentes de Diámetros
    private async Task LoadDiametersData()
    {
        if (currentMeasurementsId == null)
            return;

        try
        {
            var existingDiameters = await DiametersService.GetByMeasurementsIdAsync(currentMeasurementsId.Value);
            if (existingDiameters != null)
            {
                diametersData = existingDiameters;
                await JS.InvokeVoidAsync("console.log", "Datos de diámetros existentes cargados");
            }
            else
            {
                // Inicializar nuevo objeto si no existe
                diametersData = new DiametersDTO { MeasurementsId = currentMeasurementsId.Value };
                await JS.InvokeVoidAsync("console.log", "Nuevo objeto de diámetros inicializado");
            }

            diametersLoaded = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error cargando datos de diámetros: {ex.Message}");
            diametersData = new DiametersDTO { MeasurementsId = currentMeasurementsId.Value };
            diametersLoaded = true;
        }
    }



    // Método para cargar datos de alimentos
    private async Task LoadFoodsData()
    {
        try
        {
            foods = await FoodService.GetAllAsync() ?? new List<FoodDTO>();
            foodsLoaded = true;
            await JS.InvokeVoidAsync("console.log", $"Se cargaron {foods.Count} alimentos");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error cargando alimentos: {ex.Message}");
            foods = new List<FoodDTO>();
            foodsLoaded = true;
        }
    }

    // Método para cargar datos de FoodPlan
    private async Task LoadFoodPlansData()
    {
        try
        {
            currentFoodPlans = await FoodPlanService.GetByCareIdAsync(currentMedicalCareId) ?? new List<FoodPlanDTO>();
            foodPlanRows.Clear();
            foodPlanIds.Clear();

            foreach (var plan in currentFoodPlans)
            {
                var foodName = foods.FirstOrDefault(f => f.FoodId == plan.FoodId)?.Name ?? "N/A";
                var registrationDate = plan.RegistrationDate?.ToString("dd/MM/yyyy") ?? "N/A";
                var quantity = plan.Quantity?.ToString() ?? "N/A";
                var frequency = plan.Frequency ?? "N/A";
                var indications = plan.Indications ?? "N/A";
                var description = plan.Description ?? "N/A";

                foodPlanRows.Add(new List<string> {
                foodName,
                description,
                registrationDate,
                quantity,
                frequency,
                indications
            });
                foodPlanIds.Add(plan.FoodPlanId);
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error cargando planes de alimentación: {ex.Message}");
        }
    }

    // Método para cargar datos de ForbiddenFood
    private async Task LoadForbiddenFoodsData()
    {
        try
        {
            currentForbiddenFoods = await ForbiddenFoodService.GetByCareIdAsync(currentMedicalCareId) ?? new List<ForbiddenFoodDTO>();
            forbiddenFoodRows.Clear();
            forbiddenFoodIds.Clear();

            foreach (var forbidden in currentForbiddenFoods)
            {
                var foodName = foods.FirstOrDefault(f => f.FoodId == forbidden.FoodId)?.Name ?? "N/A";
                var description = forbidden.Description ?? "N/A";
                var registrationDate = forbidden.RegistrationDate?.ToString("dd/MM/yyyy") ?? "N/A";

                forbiddenFoodRows.Add(new List<string> {
                foodName,
                description,
                registrationDate
            });
                forbiddenFoodIds.Add(forbidden.ForbiddenFoodId);
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error cargando alimentos restringidos: {ex.Message}");
        }
    }

    // ========== MÉTODOS PARA FOODPLAN ==========

    private void PrepareForAddFoodPlan()
    {
        editingFoodPlan = new FoodPlanDTO
        {
            CareId = currentMedicalCareId,
            RegistrationDate = DateTime.Today
        };
    }

    private void PrepareForEditFoodPlan(int id)
    {
        var plan = currentFoodPlans.FirstOrDefault(p => p.FoodPlanId == id);
        if (plan != null)
        {
            editingFoodPlan = new FoodPlanDTO
            {
                FoodPlanId = plan.FoodPlanId,
                CareId = plan.CareId,
                FoodId = plan.FoodId,
                Description = plan.Description,
                RegistrationDate = plan.RegistrationDate,
                Quantity = plan.Quantity,
                Frequency = plan.Frequency,
                Indications = plan.Indications
            };
        }
    }

    private async Task HandleFoodPlanRowDeleted(int id)
    {
        try
        {
            var result = await FoodPlanService.DeleteAsync(id);
            if (result.Success)
            {
                await LoadFoodPlansData();
                await JS.InvokeVoidAsync("alert", "Plan de alimentación eliminado correctamente");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"Error al eliminar: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al eliminar: {ex.Message}");
        }
    }

    private async Task SaveFoodPlanChanges()
    {
        try
        {
            if (!ValidateFoodPlanForm())
            {
                await JS.InvokeVoidAsync("alert", "Debe seleccionar un alimento");
                return;
            }

            var result = await FoodPlanService.SaveOrUpdateAsync(editingFoodPlan);
            if (result.Success)
            {
                await LoadFoodPlansData();
                await JS.InvokeVoidAsync("alert", "Plan de alimentación guardado correctamente");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"Error al guardar: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al guardar: {ex.Message}");
        }
    }

    private bool ValidateFoodPlanForm()
    {
        return editingFoodPlan.FoodId > 0;
    }

    // ========== MÉTODOS PARA FORBIDDENFOOD ==========

    private void PrepareForAddForbiddenFood()
    {
        editingForbiddenFood = new ForbiddenFoodDTO
        {
            CareId = currentMedicalCareId,
            RegistrationDate = DateTime.Today
        };
    }

    private void PrepareForEditForbiddenFood(int id)
    {
        var forbidden = currentForbiddenFoods.FirstOrDefault(f => f.ForbiddenFoodId == id);
        if (forbidden != null)
        {
            editingForbiddenFood = new ForbiddenFoodDTO
            {
                ForbiddenFoodId = forbidden.ForbiddenFoodId,
                CareId = forbidden.CareId,
                FoodId = forbidden.FoodId,
                Description = forbidden.Description,
                RegistrationDate = forbidden.RegistrationDate
            };
        }
    }

    private async Task HandleForbiddenFoodRowDeleted(int id)
    {
        try
        {
            var result = await ForbiddenFoodService.DeleteAsync(id);
            if (result.Success)
            {
                await LoadForbiddenFoodsData();
                await JS.InvokeVoidAsync("alert", "Alimento restringido eliminado correctamente");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"Error al eliminar: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al eliminar: {ex.Message}");
        }
    }

    private async Task SaveForbiddenFoodChanges()
    {
        try
        {
            if (!ValidateForbiddenFoodForm())
            {
                await JS.InvokeVoidAsync("alert", "Debe seleccionar un alimento");
                return;
            }

            var result = await ForbiddenFoodService.SaveOrUpdateAsync(editingForbiddenFood);
            if (result.Success)
            {
                await LoadForbiddenFoodsData();
                await JS.InvokeVoidAsync("alert", "Alimento restringido guardado correctamente");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"Error al guardar: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al guardar: {ex.Message}");
        }
    }

    private bool ValidateForbiddenFoodForm()
    {
        return editingForbiddenFood.FoodId > 0;
    }

    // Método para verificar si la pestaña de Plan está completa
    private bool IsPlanComplete()
    {
        return currentFoodPlans.Any() || currentForbiddenFoods.Any();
    }



    // ========== MÉTODOS EXISTENTES ADAPTADOS ==========

    private async Task ObtenerProfesionalLogueado()
    {
        try
        {
            profesionalLogueado = await HealthProfessionalService.GetCurrentHealthProfessionalAsync(AuthorizationService);

            if (profesionalLogueado != null)
            {
                await JS.InvokeVoidAsync("console.log",
                    $"✅ Nutricionista logueado encontrado: {profesionalLogueado.FullName}, ID: {profesionalLogueado.HealthProfessionalId}");
            }
            else
            {
                await JS.InvokeVoidAsync("console.warn", "⚠️ No se pudo encontrar el nutricionista logueado");
            }

            profesionalCargado = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"❌ Error obteniendo nutricionista logueado: {ex.Message}");
            profesionalCargado = true;
        }
    }

    private async Task AsignarProfesionalLogueado()
    {
        if (profesionalLogueado != null)
        {
            selectedHealthProfessionalId = profesionalLogueado.HealthProfessionalId;
            await JS.InvokeVoidAsync("console.log",
                $"✅ Nutricionista logueado asignado automáticamente: {profesionalLogueado.FullName}");
        }
        else if (nutricionistas.Any())
        {
            await JS.InvokeVoidAsync("console.warn",
                "⚠️ No se encontró nutricionista logueado, mostrando selector manual");
        }
    }

    private async Task LoadLocationsAndPlaces()
    {
        try
        {
            var locations = await LocationService.GetAllAsync();
            var nutritionLocation = locations?.FirstOrDefault(l =>
                l.Name.Equals("Nutrición", StringComparison.OrdinalIgnoreCase));

            nutritionLocationId = nutritionLocation?.Id ?? 0;

            if (nutritionLocationId == 0)
            {
                await JS.InvokeVoidAsync("console.error", "No se encontró la ubicación de Nutrición");
            }

            lugaresAtencion = await PlaceService.GetAllPlacesAsync() ?? new List<PlaceOfAttentionDTO>();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error loading locations and places: {ex.Message}");
        }
    }

    private async Task LoadHealthProfessionals()
    {
        try
        {
            var allProfessionals = await HealthProfessionalService.GetAllHealthProfessionalsAsync();
            nutricionistas = allProfessionals?
                .Where(hp => hp.NameTypeProfessional != null &&
                           (hp.NameTypeProfessional.ToLower().Contains("nutrición") ||
                            hp.NameTypeProfessional.ToLower().Contains("nutricion") ||
                            hp.NameTypeProfessional.ToLower().Contains("dietista") ||
                            hp.NameTypeProfessional.ToLower().Contains("dietología") ||
                            hp.NameTypeProfessional.ToLower().Contains("dietologia")))
                .ToList() ?? new List<HealthProfessionalDTO>();

            await JS.InvokeVoidAsync("console.log",
                $"Se encontraron {nutricionistas.Count} nutricionistas");

        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error loading health professionals: {ex.Message}");
        }
    }

    private async Task LoadExistingData()
    {
        try
        {
            if (currentMedicalCareId > 0)
            {
                var medicalCare = await MedicalCareService.GetByIdAsync(currentMedicalCareId);
                if (medicalCare != null)
                {
                    lugarSeleccionada = medicalCare.PlaceOfAttentionId.ToString();
                    selectedHealthProfessionalId = medicalCare.HealthProfessionalId;

                    var reasons = await ReasonForConsultationService.GetByCareIdAsync(currentMedicalCareId);
                    existingReasonForConsultation = reasons?.FirstOrDefault();
                    if (existingReasonForConsultation != null)
                    {
                        motivoConsulta = existingReasonForConsultation.Description;
                    }

                    // Cargar MeasurementsId existente si hay datos
                    currentMeasurementsId = await GetOrCreateMeasurementsId();
                    if (currentMeasurementsId != null)
                    {
                        await LoadSkinFoldsData();
                        await LoadBioImpedanceData();
                        await LoadPerimetersData();
                        await LoadDiametersData();
                    }

                    // Cargar datos de plan alimentación
                    await LoadFoodsData();
                    await LoadFoodPlansData();
                    await LoadForbiddenFoodsData();
                }
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error loading existing data: {ex.Message}");
        }
    }

    private Task HandlePatientSelected((int ClinicalHistoryId, string MedicalRecordNumber, int PersonId) paciente)
    {
        clinicalHistoryId = paciente.ClinicalHistoryId;
        selectedPatientId = paciente.PersonId;
        selectedHistoryNumber = paciente.MedicalRecordNumber;
        if (selectedPatientId > 0)
        {
            showValidationErrors = false;
        }
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void ValidateAndShowErrors()
    {
        showValidationErrors = true;
        StateHasChanged();
    }

    private async Task GuardarDatosPaciente()
    {
        isSaving = true;
        try
        {
            if (!IsPatientTabComplete())
            {
                showValidationErrors = true;
                await JS.InvokeVoidAsync("alert", "Debe completar toda la información obligatoria antes de guardar.");
                return;
            }

            if (nutritionLocationId <= 0)
            {
                await JS.InvokeVoidAsync("alert", "No se pudo identificar el área de nutrición. Por favor, contacte con soporte.");
                return;
            }

            if (selectedHealthProfessionalId <= 0)
            {
                await JS.InvokeVoidAsync("alert", "No se pudo identificar al nutricionista. Por favor, contacte con soporte.");
                return;
            }

            MedicalCareDTO medicalCareResult;

            if (isEditMode && MedicalCare != null && MedicalCare.CareId > 0)
            {
                MedicalCare.LocationId = nutritionLocationId;
                MedicalCare.HealthProfessionalId = selectedHealthProfessionalId;
                MedicalCare.PlaceOfAttentionId = int.Parse(lugarSeleccionada);

                var updateResult = await MedicalCareService.UpdateAsync(MedicalCare);
                if (!updateResult.Success)
                {
                    await JS.InvokeVoidAsync("alert", $"Error al actualizar la atención: {updateResult.Error}");
                    return;
                }

                medicalCareResult = MedicalCare;
                currentMedicalCareId = MedicalCare.CareId;
            }
            else
            {
                var medicalCareDto = new MedicalCareDTO
                {
                    PatientId = selectedPatientId,
                    HealthProfessionalId = selectedHealthProfessionalId,
                    PlaceOfAttentionId = int.Parse(lugarSeleccionada),
                    LocationId = nutritionLocationId,
                    CareDate = DateTime.Now
                };

                var result = await MedicalCareService.CreateAsync(medicalCareDto);
                if (!result.Success)
                {
                    await JS.InvokeVoidAsync("alert", $"Error al crear la atención de nutrición: {result.Error}");
                    return;
                }

                medicalCareResult = result.Data;
                currentMedicalCareId = medicalCareResult.CareId;
                isEditMode = true;
                MedicalCare = medicalCareResult;
            }

            if (!string.IsNullOrWhiteSpace(motivoConsulta))
            {
                var reasonDto = new ReasonForConsultationDTO
                {
                    Id = existingReasonForConsultation?.Id ?? 0,
                    Description = motivoConsulta.Trim(),
                    MedicalCareId = currentMedicalCareId
                };

                if (existingReasonForConsultation != null && existingReasonForConsultation.Id > 0)
                {
                    await ReasonForConsultationService.UpdateAsync(reasonDto);
                }
                else
                {
                    await ReasonForConsultationService.CreateAsync(reasonDto);
                }
            }

            await JS.InvokeVoidAsync("alert", "Datos guardados correctamente. Puede continuar con las siguientes pestañas.");
            showValidationErrors = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error saving data:", ex.Message);
            await JS.InvokeVoidAsync("alert", $"Error al guardar: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    // ============================================================================
    // MÉTODOS PARA DERIVACIÓN
    // ============================================================================

    private async Task LoadReferralData()
    {
        try
        {
            var allLocations = await LocationService.GetAllAsync();

            // Filtrar módulos disponibles para derivación (excluir Psicología)
            availableLocationsForReferral = allLocations
                .Where(l => !l.Name.Contains("Nutrición", StringComparison.OrdinalIgnoreCase) &&
                           !l.Name.Contains("Nutrición", StringComparison.OrdinalIgnoreCase))
                .OrderBy(l => l.Name)
                .ToList();

            await JS.InvokeVoidAsync("console.log",
                $"✅ Loaded {availableLocationsForReferral.Count} locations for referrals");

            if (currentMedicalCareId > 0)
            {
                var referralsResult = await MedicalReferralService.GetByMedicalCareIdAsync(currentMedicalCareId);
                if (referralsResult.Success && referralsResult.Data != null)
                {
                    referralsList = referralsResult.Data;
                    await RefreshReferralsTable();
                }
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"❌ Error loading referral data: {ex.Message}");
            availableLocationsForReferral = new List<LocationDTO>();
        }
    }

    private async Task RefreshReferralsTable()
    {
        referralRows.Clear();
        referralIds.Clear();

        foreach (var referral in referralsList)
        {
            var locationName = "N/A";
            if (referral.LocationId.HasValue)
            {
                var location = availableLocationsForReferral.FirstOrDefault(l => l.Id == referral.LocationId.Value);
                locationName = location?.Name ?? "Módulo no encontrado";
            }

            var dateOfReferral = referral.DateOfReferral?.ToString("dd/MM/yyyy HH:mm") ?? "Sin fecha";
            var description = !string.IsNullOrEmpty(referral.Description)
                ? (referral.Description.Length > 30 ? referral.Description.Substring(0, 30) + "..." : referral.Description)
                : "Sin motivo";
            var isUrgent = referral.IsUrgent ? "Sí" : "No";
            var status = referral.Status ?? "Pendiente";

            referralRows.Add(new List<string> { locationName, dateOfReferral, description, isUrgent, status });
            referralIds.Add(referral.Id);
        }

        StateHasChanged();
    }

    private async Task OnAddReferralRequested()
    {
        currentReferral = new MedicalReferralDTO
        {
            Id = 0,
            MedicalCareId = currentMedicalCareId,
            DateOfReferral = DateTime.Now,
            Description = "",
            AdditionalNotes = "",
            Status = "Pendiente",
            IsUrgent = false,
            LocationId = null
        };

        selectedLocationDId = null;
        referralErrors.Clear();
        referralFormError = "";
    }

    private async Task OnEditReferralRequested(int id)
    {
        var existing = referralsList.FirstOrDefault(r => r.Id == id);
        if (existing != null)
        {
            currentReferral = new MedicalReferralDTO
            {
                Id = existing.Id,
                MedicalCareId = existing.MedicalCareId,
                DateOfReferral = existing.DateOfReferral,
                Description = existing.Description ?? "",
                AdditionalNotes = existing.AdditionalNotes,
                Status = existing.Status ?? "Pendiente",
                IsUrgent = existing.IsUrgent,
                LocationId = existing.LocationId
            };

            selectedLocationDId = existing.LocationId;
        }

        referralErrors.Clear();
        referralFormError = "";
    }

    private async Task OnDeleteReferralRequested(int id)
    {
        try
        {
            bool confirmed = await JS.InvokeAsync<bool>("confirm",
                "¿Está seguro que desea eliminar esta derivación?");

            if (!confirmed) return;

            var result = await MedicalReferralService.DeleteAsync(id);
            if (result.Success)
            {
                var toRemove = referralsList.FirstOrDefault(r => r.Id == id);
                if (toRemove != null)
                {
                    referralsList.Remove(toRemove);
                    await RefreshReferralsTable();
                }
                await JS.InvokeVoidAsync("alert", "Derivación eliminada exitosamente.");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"Error al eliminar: {result.Error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error inesperado al eliminar: {ex.Message}");
        }
    }

    private async Task OnSaveReferralRequested()
    {
        try
        {
            if (!ValidateReferralForm())
            {
                return;
            }

            currentReferral.MedicalCareId = currentMedicalCareId;
            currentReferral.LocationId = selectedLocationDId;

            if (currentReferral.Id == 0)
            {
                var result = await MedicalReferralService.CreateAsync(currentReferral);
                if (result.Success && result.Data != null)
                {
                    referralsList.Add(result.Data);
                    await RefreshReferralsTable();
                    await JS.InvokeVoidAsync("alert", "Derivación creada exitosamente.");

                    await JS.InvokeVoidAsync("localStorage.removeItem", $"referral_data_{currentMedicalCareId}");
                    hasUnsavedReferralData = false;
                }
                else
                {
                    referralFormError = result.Error ?? "Error desconocido al crear derivación";
                    await JS.InvokeVoidAsync("alert", $"Error al crear: {referralFormError}");
                    return;
                }
            }
            else
            {
                var result = await MedicalReferralService.UpdateAsync(currentReferral);
                if (result.Success && result.Data != null)
                {
                    var index = referralsList.FindIndex(r => r.Id == currentReferral.Id);
                    if (index >= 0)
                    {
                        referralsList[index] = result.Data;
                    }
                    await RefreshReferralsTable();
                    await JS.InvokeVoidAsync("alert", "Derivación actualizada exitosamente.");

                    await JS.InvokeVoidAsync("localStorage.removeItem", $"referral_data_{currentMedicalCareId}");
                    hasUnsavedReferralData = false;
                }
                else
                {
                    referralFormError = result.Error ?? "Error desconocido al actualizar derivación";
                    await JS.InvokeVoidAsync("alert", $"Error al actualizar: {referralFormError}");
                    return;
                }
            }

            currentReferral = new MedicalReferralDTO();
            selectedLocationDId = null;
            referralErrors.Clear();
            referralFormError = "";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            referralFormError = $"Error inesperado: {ex.Message}";
            await JS.InvokeVoidAsync("alert", referralFormError);
        }
    }

    private bool ValidateReferralForm()
    {
        referralErrors.Clear();
        referralFormError = "";
        bool isValid = true;

        if (!selectedLocationDId.HasValue || selectedLocationDId <= 0)
        {
            referralErrors["LocationId"] = "Debe seleccionar un módulo o especialidad de destino.";
            isValid = false;
        }

        if (!currentReferral.DateOfReferral.HasValue)
        {
            referralErrors["DateOfReferral"] = "La fecha de derivación es obligatoria.";
            isValid = false;
        }

        if (string.IsNullOrWhiteSpace(currentReferral.Description))
        {
            referralErrors["Description"] = "El motivo de derivación es obligatorio.";
            isValid = false;
        }
        else if (currentReferral.Description.Length > 1000)
        {
            referralErrors["Description"] = "El motivo de derivación no puede exceder 1000 caracteres.";
            isValid = false;
        }

        if (!string.IsNullOrEmpty(currentReferral.AdditionalNotes) && currentReferral.AdditionalNotes.Length > 500)
        {
            referralErrors["AdditionalNotes"] = "Las notas adicionales no pueden exceder 500 caracteres.";
            isValid = false;
        }

        if (!isValid)
        {
            referralFormError = "Por favor, corrija los errores antes de continuar.";
        }

        return isValid;
    }

    private bool IsReferralFormValid()
    {
        return selectedLocationDId.HasValue && selectedLocationDId > 0 &&
               currentReferral.DateOfReferral.HasValue &&
               !string.IsNullOrWhiteSpace(currentReferral.Description) &&
               (currentReferral.Description?.Length ?? 0) <= 1000 &&
               (currentReferral.AdditionalNotes?.Length ?? 0) <= 500;
    }

    private bool IsReferralTabComplete()
    {
        return referralsList.Any();
    }

    public void Dispose()
    {
        // Cleanup si es necesario
    }
}