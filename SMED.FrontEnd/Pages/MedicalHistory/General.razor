@page "/medical-history/general"
@using SMED.FrontEnd.Components
@using SMED.FrontEnd.Services
@using SMED.Shared.DTOs
@inject PersonalHistoryService PersonalHistoryService
@inject DiseaseService DiseaseService
@inject ILogger<General> Logger

<TabContainer>
    <h4>Historia Clínica - General</h4>

    <PatientSelector @bind-Value="clinicalHistoryId"
                     OnPatientSelected="HandlePatientSelected" />

    @if (clinicalHistoryId > 0)
    {
        <div class="editable-table-wrapper">
            <EditableTable Title="Antecedentes Personales"
                           ColumnHeaders="@headersPersonales"
                           Rows="@personalesData.Select(d => d.Values).ToList()"
                           RowIds="@personalesData.Select(d => d.Id).ToList()"
                           OnAddRequested="PrepareForAdd"
                           OnEditRequested="PrepareForEdit"
                           OnDeleteRequested="HandleRowDeleted"
                           OnSaveRequested="SaveChanges"
                           IsValidForm="() => !string.IsNullOrEmpty(selectedDisease)"
                           EmptyMessage="@(isLoading ? "Cargando..." : "No hay datos disponibles")">

                <EditModalContent>
                    <div class="form-group mb-3">
                        <label>ID del Registro</label>
                        <input class="form-control" value="@GetCurrentEditingId()" disabled />
                    </div>
                    <div class="form-group mb-3">
                        <label>Tipo de Enfermedad</label>
                        <select class="form-select" @onchange="OnDiseaseTypeChanged">
                            <option value="">Seleccione un tipo</option>
                            @foreach (var type in diseaseTypes)
                            {
                                <option value="@type.DiseaseTypeId" selected="@(selectedDiseaseType == type.DiseaseTypeId)">
                                    @type.Name
                                </option>
                            }
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label>Enfermedad</label>
                        <select class="form-select" @bind="selectedDisease" disabled="@(!canSelectDisease)">
                            <option value="">@(canSelectDisease ? "Seleccione una enfermedad" : "Seleccione primero el tipo")</option>
                            @foreach (var disease in availableDiseases)
                            {
                                <option value="@disease">@disease</option>
                            }
                        </select>
                        @if (isLoadingDiseases)
                        {
                            <div class="text-muted mt-1">Cargando enfermedades...</div>
                        }
                    </div>
                </EditModalContent>
            </EditableTable>
        </div>
    }
    else
    {
        <p class="text-muted">Seleccione un paciente con historia clínica para mostrar los antecedentes personales.</p>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">
            @errorMessage
            <button type="button" class="btn-close float-end" @onclick="ClearErrorMessage"></button>
        </div>
    }
</TabContainer>

@code {
    private int clinicalHistoryId = 0;
    private string medicalRecordNumber = string.Empty;
    private string errorMessage = string.Empty;
    private bool isLoading = false;

    private readonly List<string> headersPersonales = new() { "Tipo de Enfermedad", "Enfermedad" };
    private List<PersonalRow> personalesData = new();
    private List<PersonalHistoryDTO> currentPersonalHistories = new();
    private List<DiseaseTypeDTO> diseaseTypes = new();
    private List<string> availableDiseases = new();

    private int selectedDiseaseType = 0;
    private string selectedDisease = "";
    private int editingId = -1;
    private bool isLoadingDiseases = false;
    private bool canSelectDisease => selectedDiseaseType > 0 && !isLoadingDiseases;

    private class PersonalRow
    {
        public int Id { get; set; }
        public List<string> Values { get; set; } = new();
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            diseaseTypes = await DiseaseService.GetAllAsyncDiseaseTypes() ?? new();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar tipos de enfermedad");
            errorMessage = "Error al cargar los tipos de enfermedad.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadHistories()
    {
        errorMessage = string.Empty;
        isLoading = true;

        try
        {
            var result = await PersonalHistoryService.GetByClinicalHistoryIdAsync(clinicalHistoryId);
            currentPersonalHistories = result ?? new();
            personalesData = new();

            foreach (var ph in currentPersonalHistories)
            {
                personalesData.Add(new PersonalRow
                    {
                        Id = ph.PersonalHistoryId,
                        Values = new()
                    {
                        ph.DiseaseTypeName ?? "Desconocido",
                        ph.DiseaseName ?? "No especificada"
                    }
                    });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al cargar historias personales");
            errorMessage = "Error al cargar los antecedentes personales.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task PrepareForEdit(int id)
    {
        errorMessage = string.Empty;

        try
        {
            var dto = currentPersonalHistories.FirstOrDefault(p => p.PersonalHistoryId == id);
            if (dto == null)
            {
                errorMessage = $"No se encontró el antecedente con ID {id}";
                return;
            }

            editingId = id;
            selectedDisease = dto.DiseaseName ?? "";
            selectedDiseaseType = 0;
            availableDiseases = new();

            if (dto.DiseaseId.HasValue)
            {
                var disease = await DiseaseService.GetByIdAsync(dto.DiseaseId.Value);
                if (disease != null)
                {
                    selectedDiseaseType = disease.DiseaseTypeId;
                    await LoadDiseasesByType(selectedDiseaseType);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al preparar edición");
            errorMessage = "Error al preparar el formulario de edición.";
        }
    }

    private async Task LoadDiseasesByType(int typeId)
    {
        isLoadingDiseases = true;
        try
        {
            var diseases = await DiseaseService.GetDiseasesByTypeAsync(typeId);
            availableDiseases = diseases?.Select(d => d.Name).ToList() ?? new();
        }
        finally
        {
            isLoadingDiseases = false;
        }
    }

    private async Task HandleRowDeleted(int id)
    {
        errorMessage = string.Empty;

        try
        {
            var (success, error) = await PersonalHistoryService.DeleteAsync(id);
            if (!success)
            {
                errorMessage = $"Error al eliminar: {error}";
                return;
            }

            await LoadHistories();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al eliminar antecedente");
            errorMessage = "Error al eliminar el antecedente.";
        }
    }

    private async Task SaveChanges()
    {
        errorMessage = string.Empty;

        try
        {
            if (string.IsNullOrWhiteSpace(selectedDisease))
            {
                errorMessage = "Debe seleccionar una enfermedad.";
                return;
            }

            var diseaseList = await DiseaseService.GetDiseasesByTypeAsync(selectedDiseaseType);
            var enfermedad = diseaseList?.FirstOrDefault(d => d.Name == selectedDisease);
            if (enfermedad == null)
            {
                errorMessage = "Enfermedad no encontrada.";
                return;
            }

            if (editingId == -1)
            {
                var nuevo = new PersonalHistoryDTO
                    {
                        ClinicalHistoryId = clinicalHistoryId,
                        DiseaseId = enfermedad.DiseaseId,
                        Description = $"{selectedDiseaseType} - {selectedDisease}",
                        RegistrationDate = DateTime.Now,
                        MedicalRecordNumber = medicalRecordNumber
                    };

                var (success, _, error) = await PersonalHistoryService.CreateAsync(nuevo);
                if (!success)
                {
                    errorMessage = $"Error al crear antecedente: {error}";
                    return;
                }
            }
            else
            {
                var dto = currentPersonalHistories.FirstOrDefault(p => p.PersonalHistoryId == editingId);
                if (dto == null)
                {
                    errorMessage = "Registro no encontrado para editar.";
                    return;
                }

                dto.DiseaseId = enfermedad.DiseaseId;
                dto.Description = $"{selectedDiseaseType} - {selectedDisease}";

                var (success, error) = await PersonalHistoryService.UpdateAsync(dto);
                if (!success)
                {
                    errorMessage = $"Error al actualizar antecedente: {error}";
                    return;
                }
            }

            await LoadHistories();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error al guardar cambios");
            errorMessage = "Error inesperado al guardar cambios.";
        }
    }

    private async Task OnDiseaseTypeChanged(ChangeEventArgs e)
    {
        errorMessage = string.Empty;

        if (int.TryParse(e.Value?.ToString(), out var typeId))
        {
            selectedDiseaseType = typeId;
            selectedDisease = "";
            await LoadDiseasesByType(typeId);
        }
    }

    private void PrepareForAdd()
    {
        editingId = -1;
        selectedDiseaseType = 0;
        selectedDisease = "";
        availableDiseases = new();
        errorMessage = string.Empty;
    }

    private async Task HandlePatientSelected((int ClinicalHistoryId, string MedicalRecordNumber) patient)
    {
        clinicalHistoryId = patient.ClinicalHistoryId;
        medicalRecordNumber = patient.MedicalRecordNumber;

        if (clinicalHistoryId > 0)
        {
            await LoadHistories();
        }
    }

    private string GetCurrentEditingId() => editingId == -1 ? "Nuevo" : editingId.ToString();

    private void ClearErrorMessage() => errorMessage = string.Empty;
}