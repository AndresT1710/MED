@page "/nursing-module/registro"
@layout MainLayout
@using SMED.FrontEnd.Components
@using SMED.Shared.Entity
@using SMED.Shared.DTOs
@using SMED.FrontEnd.Services
@inject MedicalCareService MedicalCareService
@inject MedicalProcedureService MedicalProcedureService
@inject PlaceOfAttentionService PlaceOfAttentionService
@inject MedicalReferralService MedicalReferralService
@inject HealthProfessionalService HealthProfessionalService
@inject AuthorizationService AuthorizationService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject HttpClient Http

<TabContainerE OnSave="GuardarDatos">
    <h3 class="mb-4">Gestión de Atenciones Médicas - Enfermería</h3>

    <!-- Agregar pestañas para separar atenciones, procedimientos y derivaciones -->
    <ul class="nav nav-tabs mb-4" id="nursingTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "atenciones" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("atenciones"))"
                    type="button">
                <i class="fas fa-hospital me-2"></i>Atenciones Médicas
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "procedimientos" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("procedimientos"))"
                    type="button">
                <i class="fas fa-procedures me-2"></i>Procedimientos
                @if (pendingProceduresCount > 0)
                {
                    <span class="badge bg-warning ms-1">@pendingProceduresCount</span>
                }
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "derivaciones" ? "active" : "")"
                    @onclick="@(() => SetActiveTab("derivaciones"))"
                    type="button">
                <i class="fas fa-share-square me-2"></i>Derivaciones Recibidas
                @if (HasPendingReferrals)
                {
                    <span class="badge bg-warning ms-1">@PendingReferralsCount</span>
                }
            </button>
        </li>
    </ul>

    <!-- Contenido de las pestañas -->
    <div class="tab-content">
        <!-- Pestaña de Atenciones Médicas -->
        @if (activeTab == "atenciones")
        {
            <div class="tab-pane show active" role="tabpanel">
                <!-- Filtros de búsqueda mejorados -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-filter me-2"></i>Filtros de Búsqueda
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Filtro por fecha y lugar de atención -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Filtrar por fecha</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar"></i>
                                    </span>
                                    <input type="date"
                                           class="form-control"
                                           value="@selectedDateString"
                                           @onchange="@OnDateChanged" />
                                    <button class="btn btn-outline-secondary" @onclick="ClearDateFilter">
                                        <i class="fas fa-times"></i> Limpiar
                                    </button>
                                </div>
                                <small class="text-muted">Seleccione una fecha para ver los procedimientos de ese día</small>
                            </div>
                        </div>
                        <!-- Búsqueda por paciente usando PersonSearchComponent -->
                        <div class="row">
                            <div class="col-12">
                                <label class="form-label fw-bold">Buscar por paciente</label>
                                <PersonSearchComponent @bind-SelectedPerson="selectedPerson"
                                                       OnPersonSelected="HandlePersonSelected"
                                                       OnPersonCleared="HandlePersonCleared" />
                            </div>
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                @if (hasActiveFilters)
                                {
                                    <span class="badge bg-info me-2">
                                        <i class="fas fa-filter me-1"></i>Filtros activos
                                    </span>
                                    <button class="btn btn-outline-secondary btn-sm" @onclick="ClearAllFilters">
                                        <i class="fas fa-times me-1"></i>Limpiar todos los filtros
                                    </button>
                                }
                            </div>
                            <button class="btn btn-primary" @onclick="CreateNewMedicalCare">
                                <i class="fas fa-plus me-1"></i>Nueva Atención
                            </button>
                        </div>
                    </div>
                </div>

                @if (showNoMedicalCareAlert)
                {
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>@searchMessage</strong>
                            </div>
                            <div>
                                <button type="button" class="btn btn-primary me-2" @onclick="CreateNewMedicalCare">
                                    <i class="fas fa-plus"></i> Crear Nueva Atención
                                </button>
                                <button type="button" class="btn-close" @onclick="() => showNoMedicalCareAlert = false" aria-label="Close"></button>
                            </div>
                        </div>
                    </div>
                }

                <!-- Información de filtros activos y tabla de atenciones médicas -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center gap-3">
                            <span class="badge bg-success">
                                <i class="fas fa-hospital me-1"></i>Sector: Enfermería
                            </span>
                            @if (selectedDate.HasValue)
                            {
                                <span class="badge bg-primary">
                                    <i class="fas fa-calendar me-1"></i>Fecha: @selectedDate.Value.ToString("dd/MM/yyyy")
                                </span>
                            }
                            @if (selectedPlaceOfAttentionId.HasValue)
                            {
                                var selectedPlace = placeOfAttentionList.FirstOrDefault(p => p.Id == selectedPlaceOfAttentionId.Value);
                                if (selectedPlace != null)
                                {
                                    <span class="badge bg-warning">
                                        <i class="fas fa-map-marker-alt me-1"></i>Sector: @selectedPlace.Name
                                    </span>
                                }
                            }
                            @if (selectedPerson != null)
                            {
                                <span class="badge bg-info">
                                    <i class="fas fa-user me-1"></i>Paciente: @selectedPerson.FirstName @selectedPerson.LastName
                                </span>
                            }
                            <span class="badge bg-secondary">
                                <i class="fas fa-list me-1"></i>Total: @filteredMedicalCareList.Count registros
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Tabla de atenciones médicas -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>Lista de Atenciones Médicas - Enfermería
                        </h5>
                    </div>
                    <div class="card-body">
                        <ManagementTableR @key="tableKey"
                                          TableTitle=""
                                          Columns="MedicalCareColumns"
                                          DocumentTypes="documentTypeList"
                                          RenderActions="RenderMedicalCareActions"
                                          AddCallback="AddMedicalCare"
                                          @ref="table" />
                    </div>
                </div>
            </div>
        }

        <!-- Nueva pestaña de Procedimientos -->
        @if (activeTab == "procedimientos")
        {
            <div class="tab-pane show active" role="tabpanel">
                <NursingProceduresManagement />
            </div>
        }

        <!-- Nueva pestaña de Derivaciones -->
        @if (activeTab == "derivaciones")
        {
            <div class="tab-pane show active" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-share-square me-2"></i>Derivaciones Recibidas - Enfermería
                            @if (HasPendingReferrals)
                            {
                                <span class="badge bg-warning ms-2">@PendingReferralsCount pendientes</span>
                            }
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (isLoadingReferrals)
                        {
                            <div class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando derivaciones...</span>
                                </div>
                                <p class="mt-2">Cargando derivaciones...</p>
                            </div>
                        }
                        else if (!referralsList.Any())
                        {
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No hay derivaciones pendientes para enfermería.
                            </div>
                        }
                        else
                        {
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Paciente</th>
                                            <th>Historia Clínica</th>
                                            <th>Fecha Derivación</th>
                                            <th>Área Origen</th>
                                            <th>Motivo</th>
                                            <th>Estado</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var referral in filteredReferralsList)
                                        {
                                            <tr class="@(referral.Status == "Pendiente" ? "table-warning" : "table-success")">
                                                <td>
                                                    <strong>@referral.PatientName</strong>
                                                    @if (referral.IsUrgent)
                                                    {
                                                        <span class="badge bg-danger ms-1">Urgente</span>
                                                    }
                                                </td>
                                                <td>@referral.MedicalRecordNumber</td>
                                                <td>@referral.DateOfReferral?.ToString("dd/MM/yyyy")</td>
                                                <td>
                                                    <span class="badge bg-info">@referral.ReferringArea</span>
                                                    <br />
                                                    <small class="text-muted">@referral.ReferringProfessional</small>
                                                </td>
                                                <td>
                                                    <div class="referral-reason">
                                                        @if (!string.IsNullOrEmpty(referral.Description))
                                                        {
                                                            if (referral.Description.Length > 100)
                                                            {
                                                                <span title="@referral.Description">
                                                                    @referral.Description.Substring(0, 100)...
                                                                </span>
                                                            }
                                                            else
                                                            {
                                                                @referral.Description
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">Sin motivo especificado</span>
                                                        }
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge @GetStatusBadgeClass(referral.Status)">
                                                        @referral.Status
                                                    </span>
                                                    @if (referral.Status == "Atendido" && referral.AttendedDate.HasValue)
                                                    {
                                                        <br />
                                                        <small class="text-muted">
                                                            @referral.AttendedDate.Value.ToString("dd/MM/yyyy")
                                                        </small>
                                                    }
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <button class="btn btn-outline-primary"
                                                                @onclick="() => ShowReferralDetails(referral)"
                                                                title="Ver detalles">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        @if (referral.Status == "Pendiente")
                                                        {
                                                            <button class="btn btn-outline-success"
                                                                    @onclick="() => MarkAsAttended(referral)"
                                                                    title="Marcar como atendido">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                        }
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Filtros y estadísticas -->
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <div class="btn-group" role="group">
                                        <button type="button"
                                                class="btn @(referralFilter == "all" ? "btn-primary" : "btn-outline-primary")"
                                                @onclick="@(() => FilterReferrals("all"))">
                                            Todas (@referralsList.Count)
                                        </button>
                                        <button type="button"
                                                class="btn @(referralFilter == "pending" ? "btn-warning" : "btn-outline-warning")"
                                                @onclick="@(() => FilterReferrals("pending"))">
                                            Pendientes (@referralsList.Count(r => r.Status == "Pendiente"))
                                        </button>
                                        <button type="button"
                                                class="btn @(referralFilter == "attended" ? "btn-success" : "btn-outline-success")"
                                                @onclick="@(() => FilterReferrals("attended"))">
                                            Atendidas (@referralsList.Count(r => r.Status == "Atendido"))
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-6 text-end">
                                    <small class="text-muted">
                                        <i class="fas fa-sync-alt me-1"></i>
                                        Actualizado: @lastUpdateTime.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                    <button class="btn btn-outline-secondary btn-sm ms-2" @onclick="RefreshReferrals">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Modales existentes -->
    @if (showDetail && selectedMedicalCare != null)
    {
        <div class="modal fade show d-flex align-items-center justify-content-center"
             tabindex="-1"
             style="background-color: rgba(0,0,0,0.5); position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1050;"
             role="dialog">
            <div style="width: 90vw; height: 90vh; display: flex; justify-content: center; align-items: center;">
                <div class="modal-content"
                     style="width: 100%; height: 100%; display: flex; flex-direction: column; max-width: 1100px;">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-eye me-2"></i>Detalle de Atención Médica
                        </h5>
                        <button type="button" class="btn-close" @onclick="() => showDetail = false"></button>
                    </div>
                    <div class="modal-body" style="overflow-y: auto; flex-grow: 1;">
                        <NursingDetail MedicalCare="selectedMedicalCare" />
                    </div>
                </div>
            </div>
        </div>
    }

    @if (showForm)
    {
        <div class="modal-backdrop fade show"></div>
        <div class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas @(selectedMedicalCare?.CareId == 0 ? "fa-plus" : "fa-edit") me-2"></i>
                            @(selectedMedicalCare?.CareId == 0 ? "Nueva Atención Médica" : "Editar Atención Médica")
                        </h5>
                        <button type="button" class="btn-close" @onclick="HideForm" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <NursingForm MedicalCare="selectedMedicalCare"
                                     OnSaved="OnMedicalCareSaved"
                                     OnCancel="HideForm" />
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Modal de detalles de derivación -->
    @if (showReferralDetailModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-file-medical-alt me-2"></i>
                            Detalles de Derivación - Enfermería
                        </h5>
                        <button type="button" class="btn-close" @onclick="CloseReferralDetailModal"></button>
                    </div>
                    <div class="modal-body">
                        @if (selectedReferral != null)
                        {
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Información del Paciente</h6>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Nombre:</strong> @selectedReferral.PatientName</p>
                                            <p><strong>Historia Clínica:</strong> @selectedReferral.MedicalRecordNumber</p>
                                            <p><strong>Edad:</strong> @selectedReferral.PatientAge años</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0">Información de Derivación</h6>
                                        </div>
                                        <div class="card-body">
                                            <p><strong>Fecha:</strong> @selectedReferral.DateOfReferral?.ToString("dd/MM/yyyy")</p>
                                            <p><strong>Área Origen:</strong> @selectedReferral.ReferringArea</p>
                                            <p><strong>Profesional:</strong> @selectedReferral.ReferringProfessional</p>
                                            <p>
                                                <strong>Estado:</strong>
                                                <span class="badge @GetStatusBadgeClass(selectedReferral.Status)">
                                                    @selectedReferral.Status
                                                </span>
                                            </p>
                                            @if (selectedReferral.IsUrgent)
                                            {
                                                <p>
                                                    <strong>Prioridad:</strong>
                                                    <span class="badge bg-danger">Urgente</span>
                                                </p>
                                            }
                                            @if (selectedReferral.Status == "Atendido" && selectedReferral.AttendedDate.HasValue)
                                            {
                                                <p><strong>Atendido el:</strong> @selectedReferral.AttendedDate.Value.ToString("dd/MM/yyyy")</p>
                                                <p><strong>Atendido por:</strong> @selectedReferral.AttendedBy</p>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">Motivo de Derivación</h6>
                                </div>
                                <div class="card-body">
                                    <div class="bg-light p-3 rounded">
                                        @if (!string.IsNullOrEmpty(selectedReferral.Description))
                                        {
                                            @selectedReferral.Description
                                        }
                                        else
                                        {
                                            <span class="text-muted">No se especificó motivo de derivación</span>
                                        }
                                    </div>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(selectedReferral.AdditionalNotes))
                            {
                                <div class="card mt-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">Notas Adicionales</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="bg-light p-3 rounded">
                                            @selectedReferral.AdditionalNotes
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                    <div class="modal-footer">
                        @if (selectedReferral?.Status == "Pendiente")
                        {
                            <button class="btn btn-success" @onclick="() => MarkAsAttended(selectedReferral)">
                                <i class="fas fa-check me-2"></i>Marcar como Atendido
                            </button>
                        }
                        <button class="btn btn-secondary" @onclick="CloseReferralDetailModal">
                            Cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
</TabContainerE>

@code {
    private ManagementTableR table;
    private MedicalCareDTO selectedMedicalCare;
    private PersonDTO selectedPerson;
    private bool showDetail = false;
    private bool showForm = false;
    private List<DocumentTypeDTO> documentTypeList = new();
    private List<MedicalCareDTO> allMedicalCareList = new();
    private List<MedicalCareDTO> filteredMedicalCareList = new();
    private List<List<string>> MedicalCareData = new();
    private List<PlaceOfAttentionDTO> placeOfAttentionList = new();
    private string tableKey = Guid.NewGuid().ToString();
    private bool shouldReloadTable = false;

    // Variables para gestión de derivaciones
    private List<MedicalReferralDTO> referralsList = new();
    private List<MedicalReferralDTO> filteredReferralsList = new();
    private MedicalReferralDTO? selectedReferral;
    private bool isLoadingReferrals = false;
    private bool showReferralDetailModal = false;
    private string referralFilter = "all";
    private DateTime lastUpdateTime = DateTime.Now;
    private int nursingLocationId = 1;


    private string activeTab = "atenciones";
    private int pendingProceduresCount = 0;

    // Filtros
    private int? _selectedPlaceOfAttentionId;
    private string quickSearchTerm = string.Empty;
    private string searchMessage = string.Empty;
    private bool showNoMedicalCareAlert = false;
    private bool hasActiveFilters = false;
    private int totalMedicalCareCount = 0;
    private DateTime? selectedDate = null;
    private string selectedDateString = string.Empty;

    // Propiedades computadas para derivaciones
    private bool HasPendingReferrals => referralsList.Any(r => r.Status == "Pendiente");
    private int PendingReferralsCount => referralsList.Count(r => r.Status == "Pendiente");

    private async void OnDateChanged(ChangeEventArgs e)
    {
        selectedDateString = e.Value?.ToString() ?? string.Empty;

        if (DateTime.TryParse(selectedDateString, out DateTime date))
        {
            selectedDate = date;
        }
        else
        {
            selectedDate = null;
        }

        await ApplyFilters();
    }

    private int? selectedPlaceOfAttentionId
    {
        get => _selectedPlaceOfAttentionId;
        set
        {
            _selectedPlaceOfAttentionId = value;
            HandlePlaceFilter();
        }
    }

    private List<string> MedicalCareColumns = new()
    {
        "Fecha", "Paciente", "Sector", "Profesional", "Acciones"
    };

    protected override async Task OnInitializedAsync()
    {
        documentTypeList = await Http.GetFromJsonAsync<List<DocumentTypeDTO>>("api/Complements/document-types") ?? new();
        placeOfAttentionList = await PlaceOfAttentionService.GetAllPlacesAsync();
        await LoadNursingMedicalCareData();
        await LoadPendingProceduresCount();
        await LoadReferrals();
    }

    private async Task SetActiveTab(string tab)
    {
        activeTab = tab;

        if (tab == "atenciones")
        {
            // Forzar recreación de la tabla
            tableKey = Guid.NewGuid().ToString();
            shouldReloadTable = true;

            // Asegurar que los datos estén actualizados
            await ApplyFilters();

            // Forzar re-renderizado
            await InvokeAsync(StateHasChanged);
        }
        else if (tab == "procedimientos")
        {
            await LoadPendingProceduresCount();
        }
        else if (tab == "derivaciones")
        {
            await LoadReferrals();
        }
    }

    private async Task LoadPendingProceduresCount()
    {
        try
        {
            pendingProceduresCount = await MedicalProcedureService.GetPendingCountByLocationAsync("Enfermería");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error loading pending procedures count: {ex.Message}");
        }
    }

    private async Task LoadNursingMedicalCareData()
    {
        try
        {
            List<MedicalCareDTO> result;

            // Si hay filtros de fecha o lugar, usar el método filtrado
            if (selectedDate.HasValue || selectedPlaceOfAttentionId.HasValue)
            {
                result = await MedicalCareService.GetByPlaceOfAttentionAndDateAsync(
                    selectedPlaceOfAttentionId,
                    selectedDate);
            }
            else
            {
                // Si no hay filtros, cargar todos los datos de enfermería
                result = await MedicalCareService.GetNursingCareAsync();
            }

            allMedicalCareList = result ?? new List<MedicalCareDTO>();
            totalMedicalCareCount = allMedicalCareList.Count;

            // Aplicar filtros locales después de cargar
            await ApplyLocalFilters();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error loading nursing medical care data: {ex.Message}");
            allMedicalCareList = new List<MedicalCareDTO>();
            filteredMedicalCareList = new List<MedicalCareDTO>();
        }
    }

    private async Task LoadReferrals()
    {
        isLoadingReferrals = true;
        StateHasChanged();

        try
        {
            // Obtener derivaciones para enfermería
            var referralsResult = await MedicalReferralService.GetByLocationAsync(nursingLocationId);
            if (referralsResult.Success && referralsResult.Data != null)
            {
                referralsList = referralsResult.Data;
                ApplyReferralFilter();
            }
            else
            {
                referralsList = new List<MedicalReferralDTO>();
                await JS.InvokeVoidAsync("console.error", "Error loading referrals:", referralsResult.Error);
            }

            lastUpdateTime = DateTime.Now;
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", "Error loading referrals:", ex.Message);
            await JS.InvokeVoidAsync("alert", "Error al cargar las derivaciones");
            referralsList = new List<MedicalReferralDTO>();
        }
        finally
        {
            isLoadingReferrals = false;
            StateHasChanged();
        }
    }

    private async Task RefreshReferrals()
    {
        await LoadReferrals();
    }

    private void ApplyReferralFilter()
    {
        switch (referralFilter)
        {
            case "pending":
                filteredReferralsList = referralsList.Where(r => r.Status == "Pendiente").ToList();
                break;
            case "attended":
                filteredReferralsList = referralsList.Where(r => r.Status == "Atendido").ToList();
                break;
            default:
                filteredReferralsList = referralsList;
                break;
        }
    }

    private async Task FilterReferrals(string filter)
    {
        referralFilter = filter;
        ApplyReferralFilter();
        StateHasChanged();
    }

    private async Task ShowReferralDetails(MedicalReferralDTO referral)
    {
        selectedReferral = referral;
        showReferralDetailModal = true;
        StateHasChanged();
    }

    private void CloseReferralDetailModal()
    {
        showReferralDetailModal = false;
        selectedReferral = null;
        StateHasChanged();
    }

    private async Task MarkAsAttended(MedicalReferralDTO referral)
    {
        try
        {
            // Obtener el profesional logueado actual
            var currentProfessional = await HealthProfessionalService.GetCurrentHealthProfessionalAsync(AuthorizationService);
            if (currentProfessional == null)
            {
                await JS.InvokeVoidAsync("alert", "No se pudo identificar al profesional actual");
                return;
            }

            // Actualizar la derivación
            referral.Status = "Atendido";
            referral.AttendedDate = DateTime.Now;
            referral.AttendedByProfessionalId = currentProfessional.HealthProfessionalId;
            referral.AttendedBy = currentProfessional.FullName;

            var updateResult = await MedicalReferralService.UpdateAsync(referral);
            if (updateResult.Success)
            {
                await JS.InvokeVoidAsync("alert", "Derivación marcada como atendida exitosamente");

                // Recargar la lista
                await LoadReferrals();
                CloseReferralDetailModal();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"Error al actualizar: {updateResult.Error}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}");
        }
    }

    private async Task ViewMedicalCareFromReferral(MedicalReferralDTO referral)
    {
        if (referral.MedicalCareId > 0)
        {
            // Buscar la atención médica en la lista actual
            var medicalCare = allMedicalCareList.FirstOrDefault(mc => mc.CareId == referral.MedicalCareId);
            if (medicalCare != null)
            {
                selectedMedicalCare = medicalCare;
                showDetail = true;
                activeTab = "atenciones"; // Cambiar a la pestaña de atenciones
                StateHasChanged();
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "No se pudo encontrar la atención médica relacionada");
            }
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Esta derivación no tiene una atención médica asociada");
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pendiente" => "bg-warning",
            "Atendido" => "bg-success",
            "Cancelado" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    private async Task ApplyLocalFilters()
    {
        filteredMedicalCareList = allMedicalCareList.ToList();

        // Aplicar solo filtros locales (paciente y búsqueda rápida)
        if (selectedPerson != null)
        {
            filteredMedicalCareList = filteredMedicalCareList
                .Where(mc => mc.NamePatient != null &&
                             mc.NamePatient.Contains(selectedPerson.FirstName, StringComparison.OrdinalIgnoreCase) &&
                             mc.NamePatient.Contains(selectedPerson.LastName, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        if (!string.IsNullOrWhiteSpace(quickSearchTerm) && int.TryParse(quickSearchTerm, out int careId))
        {
            filteredMedicalCareList = filteredMedicalCareList
                .Where(mc => mc.CareId == careId)
                .ToList();
        }

        hasActiveFilters = selectedDate.HasValue || selectedPlaceOfAttentionId.HasValue || selectedPerson != null || !string.IsNullOrWhiteSpace(quickSearchTerm);

        if (hasActiveFilters && !filteredMedicalCareList.Any())
        {
            SetNoResultsMessage();
        }

        UpdateTableData();
        StateHasChanged();
    }

    private async Task ApplyFilters()
    {
        try
        {
            // Si tenemos filtros de fecha o lugar, recargar datos del servidor
            if (selectedDate.HasValue || selectedPlaceOfAttentionId.HasValue)
            {
                await LoadNursingMedicalCareData(); // Recargar datos filtrados
            }

            // Aplicar filtros locales
            filteredMedicalCareList = allMedicalCareList.ToList();
            hasActiveFilters = false;
            showNoMedicalCareAlert = false;

            hasActiveFilters = selectedDate.HasValue || selectedPlaceOfAttentionId.HasValue || selectedPerson != null || !string.IsNullOrWhiteSpace(quickSearchTerm);

            // Filtrar por paciente (filtro local)
            if (selectedPerson != null)
            {
                filteredMedicalCareList = filteredMedicalCareList
                    .Where(mc => mc.NamePatient != null &&
                                 mc.NamePatient.Contains(selectedPerson.FirstName, StringComparison.OrdinalIgnoreCase) &&
                                 mc.NamePatient.Contains(selectedPerson.LastName, StringComparison.OrdinalIgnoreCase))
                    .ToList();
            }

            // Búsqueda rápida por ID (filtro local)
            if (!string.IsNullOrWhiteSpace(quickSearchTerm) && int.TryParse(quickSearchTerm, out int careId))
            {
                filteredMedicalCareList = filteredMedicalCareList
                    .Where(mc => mc.CareId == careId)
                    .ToList();
            }

            if (hasActiveFilters && !filteredMedicalCareList.Any())
            {
                SetNoResultsMessage();
            }

            UpdateTableData();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error in ApplyFilters: {ex.Message}");
        }
    }

    private void SetNoResultsMessage()
    {
        var filters = new List<string>();

        if (selectedDate.HasValue)
            filters.Add($"fecha {selectedDate.Value:dd/MM/yyyy}");

        if (selectedPlaceOfAttentionId.HasValue)
        {
            var selectedPlace = placeOfAttentionList.FirstOrDefault(p => p.Id == selectedPlaceOfAttentionId.Value);
            if (selectedPlace != null)
                filters.Add($"sector {selectedPlace.Name}");
        }

        if (selectedPerson != null)
            filters.Add($"paciente {selectedPerson.FirstName} {selectedPerson.LastName}");

        if (!string.IsNullOrWhiteSpace(quickSearchTerm))
            filters.Add($"ID {quickSearchTerm}");

        searchMessage = filters.Count > 0
            ? $"No se encontraron atenciones médicas de enfermería para: {string.Join(", ", filters)}"
            : "No se encontraron atenciones médicas de enfermería";

        // MOSTRAR el mensaje de "no results" pero OCULTAR el botón de creación cuando hay fecha
        showNoMedicalCareAlert = !selectedDate.HasValue; // Solo mostrar alerta si NO hay fecha seleccionada
    }

    private async void UpdateTableData()
    {
        try
        {
            MedicalCareData = filteredMedicalCareList.Select(mc => new List<string>
        {
            mc.CareDate.ToString("dd/MM/yyyy HH:mm") ?? "N/A",
            mc.NamePatient ?? "N/A",
            mc.NamePlace ?? "N/A",
            mc.NameHealthProfessional ?? "N/A",
            mc.CareId.ToString()
        }).ToList();

            Console.WriteLine($"Actualizando tabla con {MedicalCareData.Count} registros");

            // Esperar un ciclo de renderizado para asegurar que la tabla esté lista
            await InvokeAsync(StateHasChanged);

            // Cargar los registros en la tabla después de que se haya renderizado
            if (table != null && MedicalCareData.Any())
            {
                await Task.Delay(100); // Pequeño delay para asegurar renderizado
                await table.LoadRecords(MedicalCareData);
            }

            shouldReloadTable = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error en UpdateTableData: {ex.Message}");
            await JS.InvokeVoidAsync("console.error", $"Error en UpdateTableData: {ex.Message}");
        }
    }

    RenderFragment<List<string>> RenderMedicalCareActions => row => builder =>
    {
        int seq = 0;
        var id = row[4];

        builder.OpenElement(seq++, "button");
        builder.AddAttribute(seq++, "class", "btn btn-sm btn-info me-1");
        builder.AddAttribute(seq++, "title", "Ver");
        builder.AddAttribute(seq++, "onclick", EventCallback.Factory.Create(this, () => ViewMedicalCare(id)));
        builder.AddContent(seq++, "Ver");
        builder.CloseElement();

        builder.OpenElement(seq++, "button");
        builder.AddAttribute(seq++, "class", "btn btn-sm btn-warning me-1");
        builder.AddAttribute(seq++, "title", "Editar");
        builder.AddAttribute(seq++, "onclick", EventCallback.Factory.Create(this, () => EditMedicalCare(id)));
        builder.AddContent(seq++, "Editar");
        builder.CloseElement();

        builder.OpenElement(seq++, "button");
        builder.AddAttribute(seq++, "class", "btn btn-sm btn-danger");
        builder.AddAttribute(seq++, "title", "Eliminar");
        builder.AddAttribute(seq++, "onclick", EventCallback.Factory.Create(this, () => DeleteMedicalCare(id)));
        builder.AddContent(seq++, "Eliminar");
        builder.CloseElement();
    };

    private void ViewMedicalCare(string id)
    {
        if (int.TryParse(id, out int idInt))
        {
            selectedMedicalCare = filteredMedicalCareList.FirstOrDefault(mc => mc.CareId == idInt);
            if (selectedMedicalCare != null)
            {
                showDetail = true;
            }
        }
    }

    private async Task EditMedicalCare(string id)
    {
        if (int.TryParse(id, out int idInt))
        {
            try
            {
                var medicalCare = await MedicalCareService.GetByIdAsync(idInt);
                if (medicalCare != null)
                {
                    selectedMedicalCare = medicalCare;
                    showForm = true;
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "No se pudo cargar la atención médica");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("console.error", $"Error cargando atención médica: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Error al cargar la atención médica");
            }
        }
    }

    private async Task DeleteMedicalCare(string id)
    {
        if (!int.TryParse(id, out int idInt))
        {
            await JS.InvokeVoidAsync("alert", "ID inválido");
            return;
        }

        var medicalCareToDelete = filteredMedicalCareList.FirstOrDefault(mc => mc.CareId == idInt);
        if (medicalCareToDelete == null)
        {
            await JS.InvokeVoidAsync("alert", "Atención médica no encontrada");
            return;
        }

        bool confirmed = await JS.InvokeAsync<bool>("confirm",
            $"¿Estás seguro de eliminar la atención médica del paciente {medicalCareToDelete.NamePatient}?\n\nEsta acción no se puede deshacer.");

        if (confirmed)
        {
            try
            {
                var result = await MedicalCareService.DeleteAsync(idInt);
                if (result.Success)
                {
                    await LoadNursingMedicalCareData();
                    await JS.InvokeVoidAsync("alert", "Atención médica eliminada exitosamente");
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", $"Error al eliminar la atención médica: {result.Error}");
                }
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("console.error", $"Error eliminando: {ex.Message}");
                await JS.InvokeVoidAsync("alert", "Error inesperado al eliminar la atención médica");
            }
        }
    }

    private void HideForm()
    {
        showForm = false;
        selectedMedicalCare = null;
    }

    private async Task OnMedicalCareSaved(MedicalCareDTO savedMedicalCare)
    {
        showForm = false;
        await LoadNursingMedicalCareData();

        var message = savedMedicalCare.CareId == 0
            ? "Atención médica creada exitosamente"
            : "Atención médica actualizada exitosamente";

        await JS.InvokeVoidAsync("alert", message);
    }

    private void CreateNewMedicalCare()
    {
        selectedMedicalCare = new MedicalCareDTO
            {
                CareId = 0
            };
        showForm = true;
        showNoMedicalCareAlert = false;
    }

    private async Task HandlePlaceFilter()
    {
        await LoadNursingMedicalCareData();
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandlePersonSelected(PersonDTO person)
    {
        selectedPerson = person;
        ApplyFilters();
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandlePersonCleared()
    {
        selectedPerson = null;
        ApplyFilters();
        await InvokeAsync(StateHasChanged);
    }

    private async Task ClearDateFilter()
    {
        selectedDateString = string.Empty;
        selectedDate = null;
        await LoadNursingMedicalCareData();
    }

    private async Task ClearAllFilters()
    {
        selectedDateString = string.Empty;
        selectedDate = null;
        selectedPlaceOfAttentionId = null;
        selectedPerson = null;
        quickSearchTerm = string.Empty;
        await LoadNursingMedicalCareData();
    }

    private async Task ClearPlaceFilter()
    {
        selectedPlaceOfAttentionId = null;
        await LoadNursingMedicalCareData();
        await InvokeAsync(StateHasChanged);
    }

    private Task AddMedicalCare()
    {
        CreateNewMedicalCare();
        return Task.CompletedTask;
    }

    void GuardarDatos()
    {
        // Lógica para guardar los datos
    }
}